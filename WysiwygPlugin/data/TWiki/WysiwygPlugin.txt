---+!! Wysiwyg Plugin

A WYSIWYG (What-You-See-Is-What-You-Get) editor.

<img src="%ATTACHURL%/screenshot.jpg" alt="Screenshot" />

The editor is built on a generic framework that supports editing of TWiki topics using any browser-based HTML editor and the import of HTML from external sources such as existing web pages.

%RED% WARNING: this is a what-you-see-is-all-you-get, Beta release with the following known problems:
	* No way to add form or change form
	* No way to force a new revision on save
	* Images cannot be resized
	* Overlapping TWiki styles don't work very well
	* No help information
Feedback is very welcome - please add to the TWiki:Plugins.WysiwygPluginDev topic.
%ENDCOLOR%

%TOC%

---++ Features
	* Supports the input of malformed HTML
	* Full round-trip (TWiki syntax -> XHTML -> TWiki syntax)
	* Framework is editor agnostic
	* Customised [[http://kupu.osqom.org][Kupu]] editor included

---++ Details
---+++ What's in the package
The package includes the following pieces:
	* TML (TWiki syntax) to HTML translator
	* HTML to TML translator
	* Generic TWiki plugin for automating the translation during editing
	* [[http://kupu.osqom.org][Kupu]] editor integration, implemented as a TWiki skin
---+++ How to use it
The Kupu editor is customised for use with TWiki. Basic help for most of the functions in the toolbar is available by "hovering" the mouse over the button. 
Some functions require a bit more explanation:
   * "Insert No-Op" inserts a &lt;nop> region. Any TWiki syntax such as wikiwords or variables inside the region will be disabled in the rgeion. $lt;nop> regions may not extend over line breaks.
   * "Insert a TWiki Tag" will give you a menu of TWiki variables that can be inserted. Any of these variables can be edited after they have been placed in the text, for example to add parameters.
   * "Insert a WikiWord" will give you a menu of topics in the _current web_ that can be inserted. Topics are inserted as links, though typing wikiwords in plain text will work just as well.

---++++ Kupu Notes
The version of Kupu shipped with this plugin is a customised version of the basic Kupu release. All the customisation is done as plugins and extensions to Kupu - the basic kupu code is shipped intact. Kupu has a number of limitations that are worth mentioning:
   * Undo does not work in all cases. Undo is implemented using the browser undo support, and only a limited number of functions can be undone. Nothing done while editing HTML source can be undone.

---+++ How it works
The plugin works by translating the topic text into HTML, which is then fed to the editor. The edited HTML is then run through the reverse translation before saving to the topic. TWiki syntax is used in preference to HTML in the stored topic.

The default rendering that TWiki uses to generate HTML for browsers is 'lossy' - information in the TWiki syntax is lost in the HTML output, and a round-trip (recovering the original TWiki syntax from the HTML) is impossible. To solve this the plugin instead uses its own translation of TWiki syntax to pure XHTML. The generated XHTML is annotated with CSS classes that support the accurate recovery of the original TWiki syntax.

_(before you ask the obvious question, yes, the translator *could* be used to replace the TWiki rendering pipeline for generating HTML pages. In fact, the translator is taken directly from the implementation of the rendering pipeline for the TWiki 'Dakar' release)_

Translation of the HTML back to TWiki syntax uses the CPAN:HTML::Parser. This parser is used in preference to a more modern XML parser, because the HTML may not generate fully compliant XHTML. A strict parser would risk losing content. CPAN:HTML::Parser is better at handling malformed syntax. There is also the advantage that the translator can be used to import HTML from other sources - for example, existing web pages. Due to the simple nature of TWiki syntax and the complexity of HTML, this translation is lossy - i.e there will be HTML features that can be entered by editors that will be lost in this translation step. This is especially noticeable with HTML tables.

---+++ Using the translators from Perl scripts

Both translators can be used directly from Perl scripts, for example to build your own stand-alone translators. For example
<verbatim>
# We require a pointer to a TWiki installation, so we can use parts of
# TWiki. Substitute your own path.
unshift(@INC,'/home/twiki/cairo/lib');

use TWiki::Plugins::WysiwygPlugin::TML2HTML;
use TWiki::Plugins::WysiwygPlugin::HTML2TML;

my $tml2html = new TWiki::Plugins::WysiwygPlugin::TML2HTML();
my $html = $txer->convert( "---++ TML text\n   Some TWiki syntax" );

my $html2tml = new TWiki::Plugins::WysiwygPlugin::HTML2TML();
my $tml = $html2tml->convert( $html );
</verbatim>

---++ Plugin Installation Instructions
	* Download the ZIP file from the Plugin web (see below)
	* Unzip ==%TOPIC%.zip== in your twiki installation directory. Content:
	| *File:* | *Description:* |
%$MANIFEST%
	* Run ==%TOPIC%_installer== to automatically check and install other modules that this module depends on. You can also do this step manually. Dependencies:
	%$DEPENDENCIES%
	* The installer script will try to install the [[http://kupu.osqom.org][Kupu]] editor. The script simply unzips the kupu.zip package and then follows the steps described in the Kupu installation documentation. The Kupu package in this install (in =pub/_kupu=) is a one-for-one copy of the Kupu 1.2.1 release package. If you don't run the installer script, you need to do this manually.
		* Kupu install requires an XSLT processor with XInclude support, such as xsltproc from Gnome's libxml/libxslt.<p /> Windows users: You can get libxml/libxslt binaries at http://www.zlatkovic.com/pub/libxml/. As a minimum you need to download the zipfiles for libxslt, libxml2, iconv and zlib. Extracting all of the .dll and .exe files into c:\libxslt is sufficient for make.bat to work (ignore subdirectories in the zipfiles).
	* To enable the editor in one of you skins, add the following link to the skin alongside or in place of the existing 'edit' link:<br />
	<code>&lt;a href="%<nop>SCRIPTURLPATH%/edit%<nop>SCRIPTSUFFIX%/%<nop>WEB%/%<nop>TOPIC%?skin=kupu"&gt;Kupu&lt;/a&gt;</code><br />
	As you can see this is just a standard edit link with the 'kupu' skin in place of the usual edit skin. Here it is for this topic: <a href="%SCRIPTURLPATH%/edit%SCRIPTSUFFIX%/%WEB%/%TOPIC%?skin=kupu">Kupu</a>. Try clicking on it, but _do not save_!

---++ Settings
	* Web/Topic name of a help page. Change this to point to your local version of the help page. Currently only used by the Kupu editor.
	* Set HELPPAGE = TWiki/WysiwygPlugin
	* If set to =on= then TWiki variables will be "marked" by the TML -> HTML translator by putting the variable name and any parameters into a span. This works well for simple variables, but can get in trouble with complex syntax or some plugins constructs. If it isn't set to =on= variables will be treated as plain text.
	* Set MARK_VARIABLES =
	* Lists of icons that will be available in the Kupu editor. This has to be a list of &lt;IMG&gt; tags. If present, the 'alt' text will be used in place of the &lt;IMG&gt; tag when translating from HTML to TML.
		* Set ICONS =
		<img src="%PUBURL%/TWiki/SmiliesPlugin/smile.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/cool.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/indifferent.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/frown.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/redface.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/biggrin.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/wink.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/tongue.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/rolleyes.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/mad.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/eek.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/confused.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/devil.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/devilwink.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/sealed.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/thumbs.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/yes.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/no.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/love.gif" alt="" />
		<img src="%PUBURL%/TWiki/SmiliesPlugin/scull.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/tip.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/warning.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/pencil.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/choice-yes.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/updated.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/help.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/new.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/starred.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowright.gif" alt="" />
	* List of TWiki variables that will be available to the Kupu editor, in the form of a set of HTML option tags
		* Set TAGS =
		<option value="TOPIC">Current Topic</option>
		<option value="WEB">Current Web</option>
		<option value="DATE"> Today's Date</option>
		<option value="WIKIVERSION"> Wiki Version</option>
		<option value="USERNAME"> Login User Name</option>
		<option value="WIKIUSERNAME"> Wiki User Name</option>
		<option value="MAINWEB"> Main Web</option>
		<option value="TWIKIWEB"> TWiki Web</option>
		<option value="HOMETOPIC"> Home Topic Name</option>
		<option value="NOTIFYTOPIC"> Notify Topic Name</option>
		<option value="WIKIUSERSTOPIC"> User List Topic Name</option>
		<option value="STATISTICSTOPIC"> Statistics Topic Name</option>
		<option value="INCLUDE{...}"> Server Side Include</option>
		<option value="SEARCH{...}"> Inline Search</option>
		<option value="TOC"> Table of Contents</option>

---++ Known Issues
---+++ Overlapping formatting
Because TWiki employs a "best guess" approach to some formatting, and allows overlapping of tags in a way forbidden by HTML, it is impossible to guarantee 100% that formating in the original TWiki document will still be there when the same document is loaded and then saved through the WysiwygPlugin. The most obvious case of this is to do with styles. For example, the sentence
<verbatim>
*bold _bold-italic* italic_
</verbatim>
is legal in TML, but in HTML is represented by
<verbatim>
<strong>bold <em>bold-italic</em></strong> <em>itelaic</em>
</verbatim>
which gets translated back to TML as
<verbatim>
*bold _bold-italic_* _italic_
</verbatim>
which is correct by construction, but does not render correctly in TWiki. This problem is unfortunately unavoidable due to the way TWiki syntax works.
---+++ Resizing images
In Kupu, images cannot be resized using the resizing handles. This is a [[http://codespeak.net/issues/kupu/issue221][known Kupu bug]].

---++ Plugin Info

This plugin is heavily based on the TWiki::Plugins.KupuEditorAddOn, and the authors of that add-on are therefore also credited as authors of this plugin.

|  Plugin Authors: | TWiki:Main.CrawfordCurrie http://www.c-dot.co.uk (from original work by TWiki:Main.RomainRaugi, TWiki:Main.DamienMandrioli, TWiki:Main.FredericLuddeni, and TWiki:Main.ColasNahaboo)  |
| Copyright | &copy; ILOG 2005 http://www.ilog.fr |
|  Plugin Version: | %$VERSION% |
| Change History: <!-- Most recent first --> ||
|  Dependencies: | %$DEPENDENCIES% |
|  Perl Version: | 5.0 |
|  Plugin Home: | TWiki:Plugins/%TOPIC% |
|  Feedback: | TWiki:Plugins/%TOPIC%Dev |

__Related Topics:__ %TWIKIWEB%.TWikiPreferences, %TWIKIWEB%.TWikiPlugins

-- TWiki:Main/CrawfordCurrie - %$DATE%

<!-- Other icons, not supported because they don't have a corresponding
     shortcut

		<img src="%PUBURL%/TWiki/TWikiDocGraphics/go_ff.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/go_end.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/wip.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/rfc.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/days.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/hourglass.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/watch.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/globe.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/home.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/group.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/person.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/persons.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/lock.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/folder.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/lockfolder.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/lockfoldergray.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/locktopic.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/locktopicgray.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/refreshtopic.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/viewtopic.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/edittopic.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/topicdiffs.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/topicbacklinks.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/newtopic.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/searchtopic.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/cachetopic.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/printtopic.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/attachfile.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/recentchanges.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/changes.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/notify.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/mail.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/trash.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/rss-feed.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/xml-feed.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/empty.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_ud.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_lr.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_udlr.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_ur.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_rd.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_ld.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_ul.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_udr.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_lrd.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_udl.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/line_ulr.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_ud.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_lr.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_udlr.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_ur.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_rd.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_ld.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_ul.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_udr.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_lrd.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/dot_udl.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/note.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/bubble.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/stop.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/target.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/gear.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/wrench.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/choice-no.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/choice-cancel.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/stargold.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/hand.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowleft.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowup.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowdown.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowbleft.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowbright.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowbup.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowbdown.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/arrowdot.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/go_start.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/go_fb.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/go_back.gif" alt="" />
		<img src="%PUBURL%/TWiki/TWikiDocGraphics/go_forward.gif" alt="" />
-->

