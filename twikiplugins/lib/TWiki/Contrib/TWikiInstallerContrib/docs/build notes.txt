# creates a $TWIKIDEV/CPAN directory for a local cpan library install

this document describes the build process

CAVEATS: 
   * these scripts will overwrite your ~/.cpan/CPAN/MyConfig.pm !!! (if you have one)
   * a $TWIKIDEV/CPAN directory is created (lib, man, bin)

TWikiKernel build requirements
   * standard TWiki requirements (perl)
   * htpasswd (to generate TWikiGuest/guest .htpasswd)
   * xsltproc (to generate CHANGELOG from SVN)
   * cvs, svn
   * cvs
   * svn
   * make
   * CPAN modules: Number::Compare Text::Glob File::Slurp File::Find::Rule File::Slurp::Tree File::Spec::Functions Getopt::Long Pod::Parser LWP::UserAgent LWP::UserAgent::TWiki::TWikiGuest
   * ssh keys (opt, though highly recommended; keys for sourceforge.net, and for each server to install twiki on)

---+ First-time setup

# build user
sudo adduser --shell /bin/bash twikibuilder
su - twikibuilder

# ssh keys
ssh-keygen -t dsa -b 1024
# upload ~/.ssh/id_dsa.pub to sourceforge.net (Account Options, [Edit SSH Keys for Shell/CVS])
# wait anywhere from a few minutes to a few hours to take effect on sourceforge.net
# until then, you'll have to enter your sourceforge.net password for the cvs commands

cat >~/.bashrc <<__BASHRC__
export TWIKIDEV=~/twiki
export BRANCH=DEVELOP

# sourceforge setup
export CVS_RSH=ssh
__BASHRC__
source ~/.bashrc

# twiki.org kernel
[ -e $TWIKIDEV/$BRANCH ] || mkdir -p $TWIKIDEV/$BRANCH
cd $TWIKIDEV/$BRANCH
svn --username TWikiBuilder checkout http://ntwiki.ethermage.net:8181/svn/twiki/branches/DEVELOP .

# twiki plugins from sourceforge
cd $TWIKIDEV
# anonymous instructions: these don't really work as cvs update is delayed by up to 24 hours
# cvs -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/twikiplugins login
## press enter for password
## TODO: fix: pipe \n from echo or something...
#cvs -z3 -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/twikiplugins co -P twikiplugins
# change wbniv to your sourceforge.net userid
cvs -z3 -d:ext:wbniv@cvs.sourceforge.net:/cvsroot/twikiplugins co -P twikiplugins

# must have some version of LWP installed

# create local mini-cpan mirror
cd $TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib/cpan
# TODO: use variables to allow specifying an existing mini-cpan mirror
# TODO: switch to CPAN:MiniCPAN mini-cpan.pl script
# TODO: exclude more modules (eg, Acme::, perl, parrot, etc.)
time ./mirror-cpan.pl --cpan
# EPIA-M 10000, 256MB RAM, (usually) fast cable internet connection
# real    143m3.784s
# user    6m30.169s
# sys     1m8.873s

# check for xsltproc (required for CHANGELOG generation from SVN)

# cdot, i turn off gendocs here - this is what i mean when i say it doesn "work out of the box"
# please help :-)

# install modules required for the build process
cd $TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib/cpan
TWIKIKERNEL_BUILD_LIBS="Number::Compare Text::Glob File::Slurp File::Find::Rule File::Slurp::Tree File::Spec::Functions Getopt::Long Pod::Parser LWP::UserAgent LWP::UserAgent::TWiki::TWikiGuest"
./install-cpan.pl -f -mirror=./MIRROR/MINICPAN -baselibdir=$TWIKIDEV/CPAN $TWIKIKERNEL_BUILD_LIBS

# build a TWikiKernel
cd $TWIKIDEV/$BRANCH
svn update
cd $TWIKIDEV/$BRANCH/tools/distro
time ./build-twiki-kernel.pl --notar --nogendocs --outputdir=$TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib/downloads/releases/
# most of the time comes from gendocs and pdoc generation
# for the times below, neither gendocs nor pdoc were run
# real    2m53.955s
# user    1m42.404s
# sys     0m1.700s

# all of $TWIKIKERNEL_BUILD_LIBS plus
cd $TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib/cpan
TWIKIDISTRO_BUILD_LIBS="XML::NamespaceSupport XML::SAX XML::Simple"
./install-cpan.pl -f -mirror=./MIRROR/MINICPAN -baselibdir=$TWIKIDEV/CPAN $TWIKIDISTRO_BUILD_LIBS </dev/null

# creating a distro
# bundle extensions + installer + TWikiKernel
cd $TWIKIDEV/twikiplugins
cvs update
cd $TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib
time make distro
# which is just a shortcut for "make twiki-cpan plugins contribs addons release twiki.tar.bz2"
# this creates: twiki.tar.bz2 (~21MB), which contains:
#
# install_twiki.cgi - the actual installer, also html menu config for installation
# pre-twiki.pl - installs local cpan libraries required by the installer 
#   next step is to merge this into install_twiki.cgi
# un-twiki.pl - uninstall the twiki installation
# uninstall.pl - remove this whole package (deletes everything from twiki.tar.bz2)
#
# config - html files for web-based installer
# cpan - cpan utilities, esp. install-cpan.pl
# cpan/MIRROR/TWIKI - mini, mini-cpan mirror.  
#   in theory, it contains all of the CPAN modules used by all of the TWikiExtensions
#   however, the dependencies (cpan/calc-twiki-deps.pl) were generated by hand and probably
#   aren't up to date anymore; an automated solution is needed
# downloads/addons - downloaded from twiki.org which conform to attachment $PluginTopic.zip on TWiki:Plugins.$PluginTopic
# downloads/plugins - "
# downloads/contribs - "
# downloads/releases - TWikiKernel-BRANCH-REV.zip files from build-twiki-kernel.pl
#   used to contain TWikiKernel20040902.zip, but i don't think the installer still works with that release

---+ publishing / distribution

cd $TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib
# to allow downloading from http://twikiplugins.sourceforge.net/twiki.tar.bz2,
PUBLISH_TO=wbniv@twikiplugins.sourceforge.net:/home/groups/t/tw/twikiplugins/htdocs make publish


---+ Subsequent builds

here's the short version for after you've already checked out the code and just want to build a new release

su - twikibuilder
source ~/.bashrc

cd $TWIKIDEV/$BRANCH
svn update
cd $TWIKIDEV/$BRANCH/tools/distro
time ./build-twiki-kernel.pl --nogendocs --notar --outputdir=$TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib/downloads/releases/

cd $TWIKIDEV/twikiplugins
cvs update
cd $TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib
# TODO: pick a real package/distro/whatever filename
time make twiki.tar.bz2

cd $TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib
PUBLISH_TO=wbniv@twikiplugins.sourceforge.net:/home/groups/t/tw/twikiplugins/htdocs make publish


----------------------------------------------------------

# install modules required for the test process
cd $TWIKIDEV/twikiplugins/lib/TWiki/Contrib/TWikiInstallerContrib/cpan
TWIKI_TEST_LIBS="Error Class::Inner Devel::Symdump Test::Unit Apache::Htpasswd"
./install-cpan.pl -f -mirror=./MIRROR/MINICPAN -baselibdir=$TWIKIDEV/CPAN $TWIKI_TEST_LIBS





#  All files and directories in the installation tree must be readable by user nobody.
# All files in the twiki/bin directory must be executable by user nobody
# twiki/data and all files and directories below it must be writable by user nobody.
# twiki/pub and all files and directories below it must be writable by user nobody.
# HELP If you are unsure how to set permissions, read the man pages for chmod.