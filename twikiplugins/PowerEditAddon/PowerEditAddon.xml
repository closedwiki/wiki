<!-- ANTfile for PowerEdit
  Ant is at http://jakarta.apache.org
  Four main targets are available:
        test - runs unit tests on the package
        release - runs tests and creates a zipped package
        install - installs in the local TWiki
        uninstall - inverse of install
-->
<project name="PowerEditAddon" default="build">

    <!-- set to "yes" for debug info in the java -->
    <property name="debug.setting" value="no" />

    <property environment="ENV"/>
    <property name="twiki" value="${ENV.TWIKI_HOME}"/>
    <property name="junit" value="${ENV.JUNIT_HOME}"/>

    <property name="lib.plugins" value="lib/TWiki/Plugins"/>
    <property name="data.plugins" value="data/TWiki"/>
    <property name="pub.plugins" value="pub/TWiki"/>

    <property name="addon.lib" value="${lib.plugins}/${ant.project.name}"/>
    <property name="addon.data" value="${data.plugins}/PowerEdit"/>
    <property name="addon.pub" value="${pub.plugins}/${ant.project.name}"/>

    <property name="app.test" value="${addon.lib}/test" />
    <property name="jar.file" value="${addon.pub}/poweredit.jar"/>
    <property name="src.zip" value="${addon.lib}/source.zip" />
    <property name="release.zip" value="${ant.project.name}.zip" />

    <property name="applet.classes" value="${addon.lib}/applet.classes"/>
    <property name="test.classes" value="${addon.lib}/test.classes"/>

    <!-- Init target -->
    <target name="init">
        <tstamp />
    </target>

    <patternset id="package.sources">
	<include name="**/gnu/regexp/*.java"/>
	<include name="**/com/kizna/html/*.java"/>
	<include name="**/com/kizna/html/tags/HTMLTag.java"/>
	<include name="**/com/kizna/html/tags/HTMLEndTag.java"/>
	<include name="**/com/kizna/html/tags/HTMLDoctypeTag.java"/>
	<include name="**/com/kizna/html/tags/HTMLImageTag.java"/>
	<include name="**/com/kizna/html/tags/HTMLJspTag.java"/>
	<include name="**/com/kizna/html/tags/HTMLLinkTag.java"/>
	<include name="**/com/kizna/html/scanners/HTMLTagScanner.java"/>
	<include name="**/com/kizna/html/scanners/HTMLDoctypeScanner.java"/>
	<include name="**/com/kizna/html/scanners/HTMLImageScanner.java"/>
	<include name="**/com/kizna/html/scanners/HTMLJspScanner.java"/>
	<include name="**/com/kizna/html/scanners/HTMLLinkScanner.java"/>
    </patternset>

    <!-- Classpath for compiling -->
    <path id="compile.class.path">
        <pathelement path="/usr/lib/netscape/java/classes/java40.jar"/>
        <pathelement path="/usr/lib/netscape/java/classes/jio40.jar"/>
        <pathelement path="/usr/lib/netscape/java/classes/joptio40.jar"/>
    </path>

    <!-- Classpath for running tests -->
    <path id="test.class.path">
        <pathelement path="${java.class.path}/"/>
        <pathelement path="/usr/lib/netscape/java/classes/java40.jar"/>
        <pathelement path="${test.classes}" />
        <pathelement path="${jar.file}"/>
        <pathelement path="${junit}"/>
    </path>

    <!-- Files that get installed in the twiki -->
    <patternset id="installed.files">
	<include name="${ant.project.name}.xml"/>
	<include name="bin/poweredit"/>
	<include name="${addon.lib}/PowerEdit.pm"/>
	<include name="templates/*.power.tmpl"/>
	<include name="${jar.file}"/>
	<include name="${addon.data}*.txt"/>
	<include name="${src.zip}"/>
    </patternset>

    <!-- Install in local TWiki -->
    <target name="install" depends="test,src.zip">
        <copy todir="${twiki}" overwrite="yes">
            <fileset dir="${basedir}">
                <patternset refid="installed.files"/>
            </fileset>
        </copy>

        <chmod perm="ugoa+rwx" parallel="no">
            <fileset dir="${twiki}">
                <patternset refid="installed.files"/>
            </fileset>
        </chmod>
    </target>

    <!-- Uninstall from local twiki -->
    <target name="uninstall" depends="checkTWIKI">
        <delete>
            <fileset dir="${twiki}">
                <patternset refid="installed.files"/>
            </fileset>
        </delete>
    </target>

    <!-- Build jar -->
    <target name="build" depends="init">
        <mkdir dir="${applet.classes}" />
        <javac srcdir="${addon.lib}/packages"
            bootclasspathref="compile.class.path"
            destdir="${applet.classes}"
	    debug="${debug.setting}"
            target="1.1">
	    <patternset refid="package.sources" />
	</javac>
        <javac srcdir="${addon.lib}/src"
            bootclasspathref="compile.class.path"
            destdir="${applet.classes}"
	    debug="${debug.setting}"
            target="1.1"
            includes="**/*.java"
        />
	<delete file="${jar.file}"/>
        <jar jarfile="${jar.file}" basedir="${applet.classes}" />
    </target>

    <!-- Build and execute tests -->
    <target name="checkJUNIT" unless="ENV.JUNIT_HOME">
        <fail message="JUNIT_HOME must be set!!"/>
    </target>

    <target name="checkTWIKI" unless="ENV.TWIKI_HOME">
        <fail message="TWIKI_HOME must be set!!"/>
    </target>

    <target name="test" depends="build,checkJUNIT,checkTWIKI">
        <exec dir="${ENV.TWIKI_HOME}/bin"
		failonerror="yes" executable="perl">
            <arg line="-T -I${basedir}/lib  -I../lib ${basedir}/${addon.lib}/tests.pl"/>
        </exec>
        <mkdir dir="${test.classes}" />
        <javac srcdir="${addon.lib}/test"
            destdir="${test.classes}"
            classpathref="test.class.path"
	    debug="yes"
            includes="**/*.java"
        />
        <junit fork="yes" printsummary="yes" haltonerror="yes"
		dir="${ENV.TWIKI_HOME}/data/TWiki">
	    <formatter type="plain" usefile="no"/>
            <test name="com.ccsoft.edit.TWikiEditSuite"/>
            <classpath refid="test.class.path"/>
        </junit>
    </target>

    <target name="src.zip">
	<delete file="${src.zip}"/>
	<zip zipfile="${src.zip}">
	    <zipfileset dir="${addon.lib}">
		<include name="**/*.java"/>
		<include name="**/*.html"/>
	    </zipfileset>
	</zip>
    </target>

    <!--
        MAIN TARGETS
     -->

    <target description="Build from sources and package"
            name="release" depends="test,src.zip">
        <delete file="${release.zip}" />
        <zip zipfile="${release.zip}">
            <zipfileset dir="${basedir}">
                <patternset refid="installed.files"/>
            </zipfileset>
	</zip>
    </target>

</project>
