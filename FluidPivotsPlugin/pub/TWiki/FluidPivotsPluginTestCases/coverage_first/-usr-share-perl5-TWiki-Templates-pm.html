<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: /usr/share/perl5/TWiki/Templates.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">/usr/share/perl5/TWiki/Templates.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">71.2%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Module of TWiki Enterprise Collaboration Platform, http://TWiki.org/</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Copyright (C) 2000-2007 Peter Thoeny, peter@thoeny.org</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td class="s"># and TWiki Contributors. All Rights Reserved. TWiki Contributors</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td class="s"># are listed in the AUTHORS file in the root of this distribution.</td></tr>
<tr><td class="h">6</td><td></td><td></td><td></td><td></td><td></td><td class="s"># NOTE: Please extend that file, not this notice.</td></tr>
<tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">8</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is free software; you can redistribute it and/or</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td class="s"># modify it under the terms of the GNU General Public License</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td class="s"># as published by the Free Software Foundation; either version 2</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td class="s"># of the License, or (at your option) any later version. For</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td class="s"># more details read LICENSE in the root of this distribution.</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is distributed in the hope that it will be useful,</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td class="s"># but WITHOUT ANY WARRANTY; without even the implied warranty of</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td class="s"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td class="s"># As per the GPL, removal of this notice is prohibited.</td></tr>
<tr><td class="h">19</td><td colspan="6"></td></tr><tr><td class="h">20</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L20">1</a></div></td><td><div>5</div><div>3</div><div>5</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">21</td><td colspan="6"></td></tr><tr><td class="h">22 - 28</td><td colspan="5"></td><td class="s"><pre>=pod

---+ package TWiki::Templates

Support for the TWiki template language.

=cut</pre></td></tr>
<tr><td class="h">29</td><td colspan="6"></td></tr><tr><td class="h">30 - 48</td><td colspan="5"></td><td class="s"><pre>=pod

The following tokens are supported by this language:

| %&lt;nop&gt;TMPL:P% | Instantiates a previously defined template |
| %&lt;nop&gt;TMPL:DEF% | Opens a template definition |
| %&lt;nop&gt;TMPL:END% | Closes a template definition |
| %&lt;nop&gt;TMPL:INCLUDE% | Includes another file of templates |

Note; the template cache does not get reset during initialisation, so
the haveTemplate test will return true if a template was loaded during
a previous run when used with mod_perl or speedycgi. Frustrating for
the template author, but they just have to switch off
the accelerators during development.

This is to all intents and purposes a singleton object. It could
easily be coverted into a true singleton (template manager).

=cut</pre></td></tr>
<tr><td class="h">49</td><td colspan="6"></td></tr><tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td class="s">package TWiki::Templates;</td></tr>
<tr><td class="h">51</td><td colspan="6"></td></tr><tr><td class="h">52</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L52">1</a></div></td><td><div>6</div><div>3</div><div>4</div></td><td class="s">use Assert;</td></tr>
<tr><td class="h">53</td><td colspan="6"></td></tr><tr><td class="h">54 - 61</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ClassMethod new ( $session )

Constructor. Creates a new template database object.
   * $session - session (TWiki) object

=cut</pre></td></tr>
<tr><td class="h">62</td><td colspan="6"></td></tr><tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new {</td></tr>
<tr><td class="h">64</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L64">1</a></div></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $class, $session ) = @_;</td></tr>
<tr><td class="h">65</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>2</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($session-&gt;isa( &#39;TWiki&#39;)) if DEBUG;</td></tr>
<tr><td class="h">66</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>9</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this = bless( {}, $class );</td></tr>
<tr><td class="h">67</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session} = $session;</td></tr>
<tr><td class="h">68</td><td colspan="6"></td></tr><tr><td class="h">69</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{VARS} = { sep =&gt; &#39; | &#39; };</td></tr>
<tr><td class="h">70</td><td colspan="6"></td></tr><tr><td class="h">71</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $this;</td></tr>
<tr><td class="h">72</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">73</td><td colspan="6"></td></tr><tr><td class="h">74 - 80</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod haveTemplate( $name ) -&gt; $boolean

Return true if the template exists and is loaded into the cache

=cut</pre></td></tr>
<tr><td class="h">81</td><td colspan="6"></td></tr><tr><td class="h">82</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub haveTemplate {</td></tr>
<tr><td class="h">83</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L83">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $template ) = @_;</td></tr>
<tr><td class="h">84</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa( &#39;TWiki::Templates&#39;)) if DEBUG;</td></tr>
<tr><td class="h">85</td><td colspan="6"></td></tr><tr><td class="h">86</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return exists( $this-&gt;{VARS}-&gt;{$template} );</td></tr>
<tr><td class="h">87</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">88</td><td colspan="6"></td></tr><tr><td class="h">89</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Expand only simple templates that can be expanded statically.</td></tr>
<tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Templates with conditions can only be expanded after the</td></tr>
<tr><td class="h">91</td><td></td><td></td><td></td><td></td><td></td><td class="s"># context is fully known.</td></tr>
<tr><td class="h">92</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _expandTrivialTemplate {</td></tr>
<tr><td class="h">93</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L93">4</a></div></td><td><div>18</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $text ) = @_;</td></tr>
<tr><td class="h">94</td><td colspan="6"></td></tr><tr><td class="h">95</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td><div>17</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text =~ /%TMPL\:P{(.*)}%/;</td></tr>
<tr><td class="h">96</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td><div>22</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $attrs = new TWiki::Attrs( $1 );</td></tr>
<tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Can&#39;t expand context-dependant templates</td></tr>
<tr><td class="h">98</td><td><div class="c3">4</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L98">50</a></div></td><td></td><td></td><td><div>19</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $text if ( $attrs-&gt;{context} );</td></tr>
<tr><td class="h">99</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td><div>17</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;tmplP( $attrs );</td></tr>
<tr><td class="h">100</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">101</td><td colspan="6"></td></tr><tr><td class="h">102 - 113</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod expandTemplate( $params ) -&gt; $string

Expand the template specified in the parameter string using =tmplP=.

Examples:
&lt;verbatim&gt;
$tmpls-&gt;expandTemplate(&#39;&quot;blah&quot;);
$tmpls-&gt;expandTemplate(&#39;context=&quot;view&quot; then=&quot;sigh&quot; else=&quot;humph&quot;&#39;);

=cut</pre></td></tr>
<tr><td class="h">114</td><td colspan="6"></td></tr><tr><td class="h">115</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub expandTemplate {</td></tr>
<tr><td class="h">116</td><td><div class="c3">95</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L116">95</a></div></td><td><div>401</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $params ) = @_;</td></tr>
<tr><td class="h">117</td><td><div class="c3">95</div></td><td></td><td></td><td></td><td><div>239</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa( &#39;TWiki::Templates&#39;)) if DEBUG;</td></tr>
<tr><td class="h">118</td><td colspan="6"></td></tr><tr><td class="h">119</td><td><div class="c3">95</div></td><td></td><td></td><td></td><td><div>401</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $attrs = new TWiki::Attrs( $params );</td></tr>
<tr><td class="h">120</td><td><div class="c3">95</div></td><td></td><td></td><td></td><td><div>401</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $value = $this-&gt;tmplP( $attrs );</td></tr>
<tr><td class="h">121</td><td><div class="c3">95</div></td><td></td><td></td><td></td><td><div>677</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $value;</td></tr>
<tr><td class="h">122</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">123</td><td colspan="6"></td></tr><tr><td class="h">124 - 140</td><td colspan="5"></td><td class="s"><pre>=pod

---+ ObjectMethod tmplP( $attrs ) -&gt; $string

Return value expanded text of the template, as found from looking
in the register of template definitions. The attrs can contain a template
name in _DEFAULT, and / or =context=, =then= and =else= values.

Recursively expands any contained TMPL:P tags.

Note that it would be trivial to add template parameters to this,
simply by iterating over the other parameters (other than _DEFAULT, context,
then and else) and doing a s/// in the template for that parameter value. This
would add considerably to the power of templates. There is already code
to do this in the MacrosPlugin.

=cut</pre></td></tr>
<tr><td class="h">141</td><td colspan="6"></td></tr><tr><td class="h">142</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub tmplP {</td></tr>
<tr><td class="h">143</td><td><div class="c3">99</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L143">99</a></div></td><td><div>347</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $params ) = @_;</td></tr>
<tr><td class="h">144</td><td colspan="6"></td></tr><tr><td class="h">145</td><td><div class="c3">99</div></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L145">100</a></div></td><td></td><td><div>386</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $template = $params-&gt;remove(&#39;_DEFAULT&#39;) || &#39;&#39;;</td></tr>
<tr><td class="h">146</td><td><div class="c3">99</div></td><td></td><td></td><td></td><td><div>396</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $context = $params-&gt;remove(&#39;context&#39;);</td></tr>
<tr><td class="h">147</td><td><div class="c3">99</div></td><td></td><td></td><td></td><td><div>393</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $then = $params-&gt;remove(&#39;then&#39;);</td></tr>
<tr><td class="h">148</td><td><div class="c3">99</div></td><td></td><td></td><td></td><td><div>369</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $else = $params-&gt;remove(&#39;else&#39;);</td></tr>
<tr><td class="h">149</td><td><div class="c3">99</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L149">100</a></div></td><td></td><td></td><td><div>427</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $context ) {</td></tr>
<tr><td class="h">150</td><td><div class="c3">16</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L150">50</a></div></td><td></td><td></td><td><div>80</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$template = $then if defined( $then );</td></tr>
<tr><td class="h">151</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td><div>76</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $id ( split( /\,\s*/, $context )) {</td></tr>
<tr><td class="h">152</td><td><div class="c3">16</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L152">100</a></div></td><td></td><td></td><td><div>113</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless( $this-&gt;{session}-&gt;{context}-&gt;{$id} ) {</td></tr>
<tr><td class="h">153</td><td><div class="c3">13</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L153">50</a></div></td><td></td><td><div>57</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$template = ( $else || &#39;&#39; );</td></tr>
<tr><td class="h">154</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>42</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last;</td></tr>
<tr><td class="h">155</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">156</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">157</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">158</td><td colspan="6"></td></tr><tr><td class="h">159</td><td><div class="c3">99</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L159">50</a></div></td><td></td><td></td><td><div>407</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39; unless $template;</td></tr>
<tr><td class="h">160</td><td colspan="6"></td></tr><tr><td class="h">161</td><td><div class="c3">99</div></td><td></td><td></td><td></td><td><div>287</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $val = &#39;&#39;;</td></tr>
<tr><td class="h">162</td><td><div class="c3">99</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L162">100</a></div></td><td></td><td></td><td><div>539</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( exists($this-&gt;{VARS}-&gt;{$template} )) {</td></tr>
<tr><td class="h">163</td><td><div class="c3">98</div></td><td></td><td></td><td></td><td><div>457</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val = $this-&gt;{VARS}-&gt;{$template};</td></tr>
<tr><td class="h">164</td><td><div class="c3">98</div></td><td></td><td></td><td></td><td><div>427</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $p ( keys %$params ) {</td></tr>
<tr><td class="h">165</td><td><div class="c3">98</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L165">50</a></div><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L165">50</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L165">33</a></div></td><td></td><td><div>1198</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $p eq &#39;then&#39; || $p eq &#39;else&#39; ) {</td></tr>
<tr><td class="h">166</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val =~ s/%$p%/$this-&gt;expandTemplate($1)/ge;</td></tr>
<tr><td class="h">167</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif( defined( $params-&gt;{$p} )) {</td></tr>
<tr><td class="h">168</td><td><div class="c3">98</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>585</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val =~ s/%$p%/$params-&gt;{$p}/ge;</td></tr>
<tr><td class="h">169</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">170</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">171</td><td><div class="c3">98</div><div class="c3">95</div></td><td></td><td></td><td></td><td><div>446</div><div>380</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val =~ s/%TMPL:P{(.*?)}%/$this-&gt;expandTemplate($1)/ge;</td></tr>
<tr><td class="h">172</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">173</td><td colspan="6"></td></tr><tr><td class="h">174</td><td><div class="c3">99</div></td><td></td><td></td><td></td><td><div>501</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $val;</td></tr>
<tr><td class="h">175</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">176</td><td colspan="6"></td></tr><tr><td class="h">177 - 208</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod readTemplate ( $name, $skins, $web ) -&gt; $text

Return value: expanded template text

Reads a template, constructing a candidate name for the template thus
   0 looks for file =$name.$skin.tmpl= (for each skin)
      0 in =templates/$web=
      0 in =templates=, look for
   0 looks for file =$name.tmpl=
      0 in =templates/$web=
      0 in =templates=, look for
   0 if a template is not found, tries in this order
      0 parse =$name= into a web name (default to $web) and a topic name and looks for this topic
      0 looks for topic =${skin}Skin${name}Template= 
         0 in $web (for each skin)
         0 in =TWiki::cfg{SystemWebName}= (for each skin)
      0 looks for topic =${name}Template=
         0 in $web (for each skin)
         0 in =TWiki::cfg{SystemWebName}= (for each skin)
In the event that the read fails (template not found, access permissions fail)
returns the empty string &#39;&#39;.

=$skin=, =$web= and =$name= are forced to an upper-case first character
when composing user topic names.

If template text is found, extracts include statements and fully expands them.
Also extracts template definitions and adds them to the
list of loaded templates, overwriting any previous definition.

=cut</pre></td></tr>
<tr><td class="h">209</td><td colspan="6"></td></tr><tr><td class="h">210</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub readTemplate {</td></tr>
<tr><td class="h">211</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L211">1</a></div></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $name, $skins, $web ) = @_;</td></tr>
<tr><td class="h">212</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa( &#39;TWiki::Templates&#39;)) if DEBUG;</td></tr>
<tr><td class="h">213</td><td colspan="6"></td></tr><tr><td class="h">214</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{files} = ();</td></tr>
<tr><td class="h">215</td><td colspan="6"></td></tr><tr><td class="h">216</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# recursively read template file(s)</td></tr>
<tr><td class="h">217</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $text = $this-&gt;_readTemplateFile( $name, $skins, $web );</td></tr>
<tr><td class="h">218</td><td colspan="6"></td></tr><tr><td class="h">219</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>13</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while( $text =~ /%TMPL\:INCLUDE{[\s\&quot;]*(.*?)[\&quot;\s]*}%/s ) {</td></tr>
<tr><td class="h">220</td><td><div class="c3">3</div><div class="c3">12</div></td><td></td><td></td><td></td><td><div>31</div><div>49</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text =~ s/%TMPL\:INCLUDE{[\s\&quot;]*(.*?)[\&quot;\s]*}%/$this-&gt;_readTemplateFile( $1, $skins, $web )/geo;</td></tr>
<tr><td class="h">221</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">222</td><td colspan="6"></td></tr><tr><td class="h">223</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Kill comments, marked by %{ ... }%</td></tr>
<tr><td class="h">224</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>125</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text =~ s/%{.*?}%//sg;</td></tr>
<tr><td class="h">225</td><td colspan="6"></td></tr><tr><td class="h">226</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L226">50</a></div></td><td></td><td></td><td><div>13</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( ! ( $text =~ /%TMPL\:/s ) ) {</td></tr>
<tr><td class="h">227</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# no template processing</td></tr>
<tr><td class="h">228</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text =~ s|^(( {3})+)|&quot;\t&quot; x (length($1)/3)|geom;  # leading spaces to tabs</td></tr>
<tr><td class="h">229</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $text;</td></tr>
<tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">231</td><td colspan="6"></td></tr><tr><td class="h">232</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $result = &#39;&#39;;</td></tr>
<tr><td class="h">233</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $key  = &#39;&#39;;</td></tr>
<tr><td class="h">234</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $val  = &#39;&#39;;</td></tr>
<tr><td class="h">235</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $delim = &#39;&#39;;</td></tr>
<tr><td class="h">236</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>306</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach( split( /(%TMPL\:)/, $text ) ) {</td></tr>
<tr><td class="h">237</td><td><div class="c3">551</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L237">100</a></div><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L237">100</a></div><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L237">100</a></div><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L237">100</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L237">67</a></div></td><td></td><td><div>3861</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( /^(%TMPL\:)$/ ) {</td></tr>
<tr><td class="h">238</td><td><div class="c3">275</div></td><td></td><td></td><td></td><td><div>995</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$delim = $1;</td></tr>
<tr><td class="h">239</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif( ( /^DEF{[\s\&quot;]*(.*?)[\&quot;\s]*}%(.*)/s ) &amp;&amp; ( $1 ) ) {</td></tr>
<tr><td class="h">240</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# handle %TMPL:DEF{key}%</td></tr>
<tr><td class="h">241</td><td><div class="c3">91</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L241">50</a></div></td><td></td><td></td><td><div>349</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $key ) {</td></tr>
<tr><td class="h">242</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{VARS}-&gt;{$key} = $val;</td></tr>
<tr><td class="h">243</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">244</td><td><div class="c3">91</div></td><td></td><td></td><td></td><td><div>274</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key = $1;</td></tr>
<tr><td class="h">245</td><td><div class="c3">91</div></td><td></td><td></td><td></td><td><div>365</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val = $2;</td></tr>
<tr><td class="h">246</td><td colspan="6"></td></tr><tr><td class="h">247</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif( /^END%[\n\r]*(.*)/s ) {</td></tr>
<tr><td class="h">248</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# handle %TMPL:END%</td></tr>
<tr><td class="h">249</td><td><div class="c3">91</div></td><td></td><td></td><td></td><td><div>430</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{VARS}-&gt;{$key} = $val;</td></tr>
<tr><td class="h">250</td><td><div class="c3">91</div></td><td></td><td></td><td></td><td><div>248</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key = &#39;&#39;;</td></tr>
<tr><td class="h">251</td><td><div class="c3">91</div></td><td></td><td></td><td></td><td><div>235</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val = &#39;&#39;;</td></tr>
<tr><td class="h">252</td><td><div class="c3">91</div></td><td></td><td></td><td></td><td><div>364</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result .= $1;</td></tr>
<tr><td class="h">253</td><td colspan="6"></td></tr><tr><td class="h">254</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif( $key ) {</td></tr>
<tr><td class="h">255</td><td><div class="c3">89</div></td><td></td><td></td><td></td><td><div>367</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val    .= &quot;$delim$_&quot;;</td></tr>
<tr><td class="h">256</td><td colspan="6"></td></tr><tr><td class="h">257</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">258</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td><div>28</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result .= &quot;$delim$_&quot;;</td></tr>
<tr><td class="h">259</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">260</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">261</td><td colspan="6"></td></tr><tr><td class="h">262</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# handle %TMPL:P{&quot;...&quot;}% recursively</td></tr>
<tr><td class="h">263</td><td><div class="c3">1</div><div class="c3">4</div></td><td></td><td></td><td></td><td><div>52</div><div>16</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$result =~ s/(%TMPL\:P{.*?}%)/$this-&gt;_expandTrivialTemplate($1)/geo;</td></tr>
<tr><td class="h">264</td><td colspan="6"></td></tr><tr><td class="h">265</td><td><div class="c3">1</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>22</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$result =~ s|^(( {3})+)|&quot;\t&quot; x (length($1)/3)|geom;  # leading spaces to tabs</td></tr>
<tr><td class="h">266</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>11</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $result;</td></tr>
<tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">268</td><td colspan="6"></td></tr><tr><td class="h">269</td><td></td><td></td><td></td><td></td><td></td><td class="s"># STATIC: Return value: raw template text, or &#39;&#39; if read fails</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _readTemplateFile {</td></tr>
<tr><td class="h">271</td><td><div class="c3">13</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L271">13</a></div></td><td><div>59</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $name, $skins, $web ) = @_;</td></tr>
<tr><td class="h">272</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>46</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $session = $this-&gt;{session};</td></tr>
<tr><td class="h">273</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>45</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $store = $session-&gt;{store};</td></tr>
<tr><td class="h">274</td><td colspan="6"></td></tr><tr><td class="h">275</td><td><div class="c3">13</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L275">50</a></div></td><td></td><td></td><td><div>54</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$skins = $session-&gt;getSkin() unless defined( $skins );</td></tr>
<tr><td class="h">276</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;SKIN path is $skins\n&quot;;</td></tr>
<tr><td class="h">277</td><td><div class="c3">13</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L277">50</a></div></td><td></td><td><div>59</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web ||= $session-&gt;{webName};</td></tr>
<tr><td class="h">278</td><td><div class="c3">13</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L278">50</a></div></td><td></td><td><div>50</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$name ||= &#39;&#39;;</td></tr>
<tr><td class="h">279</td><td colspan="6"></td></tr><tr><td class="h">280</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: not i18n-friendly (can&#39;t have accented characters in skin name)</td></tr>
<tr><td class="h">281</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# zap anything suspicious</td></tr>
<tr><td class="h">282</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>43</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$name =~ s/[^A-Za-z0-9_,.]//go;</td></tr>
<tr><td class="h">283</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>36</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$skins =~ s/[^A-Za-z0-9_,.]//go;</td></tr>
<tr><td class="h">284</td><td colspan="6"></td></tr><tr><td class="h">285</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the name ends in .tmpl, then this is an explicit include from</td></tr>
<tr><td class="h">286</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the templates directory. No further searching required.</td></tr>
<tr><td class="h">287</td><td><div class="c3">13</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L287">50</a></div></td><td></td><td></td><td><div>56</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $name =~ /\.tmpl$/ ) {</td></tr>
<tr><td class="h">288</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return TWiki::readFile( $TWiki::cfg{TemplateDir}.&#39;/&#39;.$name );</td></tr>
<tr><td class="h">289</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">290</td><td colspan="6"></td></tr><tr><td class="h">291</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>35</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userdirweb = $web;</td></tr>
<tr><td class="h">292</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>36</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userdirname = $name;</td></tr>
<tr><td class="h">293</td><td><div class="c3">13</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L293">50</a></div></td><td></td><td></td><td><div>48</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $name =~ /^(.+)\.(.+?)$/ ) {</td></tr>
<tr><td class="h">294</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userdirweb = ucfirst($1);</td></tr>
<tr><td class="h">295</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userdirname = ucfirst($2);</td></tr>
<tr><td class="h">296</td><td colspan="6"></td></tr><tr><td class="h">297</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if the name can be parsed into $web.$name, then this is an attempt</td></tr>
<tr><td class="h">298</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# to explicit include that topic. No further searching required.</td></tr>
<tr><td class="h">299</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L299">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( validateTopic($session,$store,$session-&gt;{user},$userdirname,$userdirweb )) {</td></tr>
<tr><td class="h">300</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return retrieveTopic( $store, $userdirweb, $userdirname );</td></tr>
<tr><td class="h">301</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">302</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">303</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;else {</td></tr>
<tr><td class="h">304</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>39</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userdirweb = ucfirst($userdirweb);</td></tr>
<tr><td class="h">305</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>40</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userdirname = ucfirst($userdirname);</td></tr>
<tr><td class="h">306</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">307</td><td colspan="6"></td></tr><tr><td class="h">308</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>57</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @skinList = split( /\,\s*/, $skins );</td></tr>
<tr><td class="h">309</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>48</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $nrskins = $#skinList;</td></tr>
<tr><td class="h">310</td><td colspan="6"></td></tr><tr><td class="h">311</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>183</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @templatePath = split (/\s*,\s*/, $TWiki::cfg{TemplatePath});</td></tr>
<tr><td class="h">312</td><td colspan="6"></td></tr><tr><td class="h">313</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Search the $TWiki::cfg{TemplatePath} for the skinned versions</td></tr>
<tr><td class="h">314</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>38</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @candidates;</td></tr>
<tr><td class="h">315</td><td colspan="6"></td></tr><tr><td class="h">316</td><td><div class="c3">13</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L316">50</a></div></td><td></td><td></td><td><div>58</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$nrskins = 0 if $nrskins &lt; 0;</td></tr>
<tr><td class="h">317</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>42</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $template ( @templatePath ) {</td></tr>
<tr><td class="h">318</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for ( my $idx=0; $idx&lt;=$nrskins; $idx++ ) {</td></tr>
<tr><td class="h">319</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td><div>75</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $file = $template;</td></tr>
<tr><td class="h">320</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td><div>69</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $userdir = 0;</td></tr>
<tr><td class="h">321</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# also need to do %PUBURL% etc.?</td></tr>
<tr><td class="h">322</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# push the first time even if not modified</td></tr>
<tr><td class="h">323</td><td><div class="c3">26</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L323">50</a></div></td><td></td><td><div>116</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $skin = $skinList[$idx] || &#39;&#39;;</td></tr>
<tr><td class="h">324</td><td><div class="c3">26</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L324">50</a></div></td><td></td><td><div>115</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $webName = $web || &#39;&#39;;</td></tr>
<tr><td class="h">325</td><td><div class="c3">26</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L325">50</a></div></td><td></td><td><div>108</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tmplName = $name || &#39;&#39;;</td></tr>
<tr><td class="h">326</td><td><div class="c3">26</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L326">50</a></div></td><td></td><td></td><td><div>132</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ( $file =~ m/.tmpl$/ ) {</td></tr>
<tr><td class="h">327</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Could also use $Skin, $Web, $Name to indicate uppercase</td></tr>
<tr><td class="h">328</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userdir = 1;</td></tr>
<tr><td class="h">329</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$skin = ucfirst($skin);</td></tr>
<tr><td class="h">330</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$webName = $userdirweb;</td></tr>
<tr><td class="h">331</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tmplName = $userdirname;</td></tr>
<tr><td class="h">332</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">333</td><td><div class="c3">26</div><div class="c3">26</div></td><td></td><td></td><td></td><td><div>107</div><div>111</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file =~ s/\$skin/$skin/geo;</td></tr>
<tr><td class="h">334</td><td><div class="c3">26</div><div class="c3">13</div></td><td></td><td></td><td></td><td><div>84</div><div>50</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file =~ s/\$web/$webName/geo;</td></tr>
<tr><td class="h">335</td><td><div class="c3">26</div><div class="c3">26</div></td><td></td><td></td><td></td><td><div>96</div><div>97</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file =~ s/\$name/$tmplName/geo;</td></tr>
<tr><td class="h">336</td><td colspan="6"></td></tr><tr><td class="h">337</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td><div>76</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($candidatename, $candidatevalidate, $candidateretrieve);</td></tr>
<tr><td class="h">338</td><td colspan="6"></td></tr><tr><td class="h">339</td><td><div class="c3">26</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L339">50</a></div></td><td></td><td></td><td><div>92</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $userdir ) {</td></tr>
<tr><td class="h">340</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# candidate in user directory</td></tr>
<tr><td class="h">341</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($web1, $name1) = $session-&gt;normalizeWebTopicName($web, $file);</td></tr>
<tr><td class="h">342</td><td colspan="6"></td></tr><tr><td class="h">343</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L343">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( validateTopic($session,$store,$session-&gt;{user},$name1,$web1) ) {</td></tr>
<tr><td class="h">344</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L344">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if (defined($this-&gt;{files}-&gt;{&#39;topic&#39;.$session-&gt;{user},$name1,$web1}));</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#recursion prevention.</td></tr>
<tr><td class="h">346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{files}-&gt;{&#39;topic&#39;.$session-&gt;{user},$name1,$web1} = 1;</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return retrieveTopic( $store, $web1, $name1 );</td></tr>
<tr><td class="h">348</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">349</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">350</td><td><div class="c3">26</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L350">100</a></div></td><td></td><td></td><td><div>86</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( validateFile( $file )) {</td></tr>
<tr><td class="h">351</td><td><div class="c3">13</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Templates-pm--branch.html#L351">50</a></div></td><td></td><td></td><td><div>71</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if (defined($this-&gt;{files}-&gt;{$file}));</td></tr>
<tr><td class="h">352</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#recursion prevention.</td></tr>
<tr><td class="h">353</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>69</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{files}-&gt;{$file} = 1;</td></tr>
<tr><td class="h">354</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>52</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return TWiki::readFile( $file );</td></tr>
<tr><td class="h">355</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">356</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">357</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td><div>78</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">358</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">359</td><td colspan="6"></td></tr><tr><td class="h">360</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: should really</td></tr>
<tr><td class="h">361</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#throw Error::Simple( &#39;Template &#39;.$name.&#39; was not found&#39; );</td></tr>
<tr><td class="h">362</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# instead of</td></tr>
<tr><td class="h">363</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;Template $name could not be found anywhere\n&quot;;</td></tr>
<tr><td class="h">364</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#Is Failing Silently the best option here?</td></tr>
<tr><td class="h">365</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</td></tr>
<tr><td class="h">366</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">367</td><td colspan="6"></td></tr><tr><td class="h">368</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub validateFile {</td></tr>
<tr><td class="h">369</td><td><div class="c3">26</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L369">26</a></div></td><td><div>79</div></td><td class="s">&nbsp;&nbsp;&nbsp;my $file = shift;</td></tr>
<tr><td class="h">370</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td><div>279</div></td><td class="s">&nbsp;&nbsp;&nbsp;return -e $file;</td></tr>
<tr><td class="h">371</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">372</td><td colspan="6"></td></tr><tr><td class="h">373</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub validateTopic {</td></tr>
<tr><td class="h">374</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L374">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;my( $session, $store, $user, $topic, $web ) = @_;</td></tr>
<tr><td class="h">375</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--condition.html#L375">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;return $store-&gt;topicExists( $web, $topic ) &amp;&amp; </td></tr>
<tr><td class="h">376</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;$session-&gt;{security}-&gt;checkAccessPermission(</td></tr>
<tr><td class="h">377</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;view&#39;, $user, undef, undef, $topic, $web );</td></tr>
<tr><td class="h">378</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">379</td><td colspan="6"></td></tr><tr><td class="h">380</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub retrieveTopic {</td></tr>
<tr><td class="h">381</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Templates-pm--subroutine.html#L381">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;my( $store, $web, $topic ) = @_;</td></tr>
<tr><td class="h">382</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;my ( $meta, $text ) = $store-&gt;readTopic( undef, $web, $topic, undef );</td></tr>
<tr><td class="h">383</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;return $text;</td></tr>
<tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">385</td><td colspan="6"></td></tr><tr><td class="h">386</td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
