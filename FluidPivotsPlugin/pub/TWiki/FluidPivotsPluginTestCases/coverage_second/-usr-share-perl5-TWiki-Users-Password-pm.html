<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: /usr/share/perl5/TWiki/Users/Password.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">/usr/share/perl5/TWiki/Users/Password.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">14.5%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Module of TWiki Enterprise Collaboration Platform, http://TWiki.org/</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Copyright (C) 1999-2007 Peter Thoeny, peter@thoeny.org</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td class="s"># and TWiki Contributors. All Rights Reserved. TWiki Contributors</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td class="s"># are listed in the AUTHORS file in the root of this distribution.</td></tr>
<tr><td class="h">6</td><td></td><td></td><td></td><td></td><td></td><td class="s"># NOTE: Please extend that file, not this notice.</td></tr>
<tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">8</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is free software; you can redistribute it and/or</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td class="s"># modify it under the terms of the GNU General Public License</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td class="s"># as published by the Free Software Foundation; either version 2</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td class="s"># of the License, or (at your option) any later version. For</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td class="s"># more details read LICENSE in the root of this distribution.</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is distributed in the hope that it will be useful,</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td class="s"># but WITHOUT ANY WARRANTY; without even the implied warranty of</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td class="s"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td class="s"># As per the GPL, removal of this notice is prohibited.</td></tr>
<tr><td class="h">19</td><td colspan="6"></td></tr><tr><td class="h">20 - 30</td><td colspan="5"></td><td class="s"><pre>=begin twiki

---+ package TWiki::Users::Password

Base class of all password handlers. Default behaviour is no passwords,
so anyone can be anyone they like.

The methods of this class should be overridded by subclasses that want
to implement other password handling methods.

=cut</pre></td></tr>
<tr><td class="h">31</td><td colspan="6"></td></tr><tr><td class="h">32</td><td></td><td></td><td></td><td></td><td></td><td class="s">package TWiki::Users::Password;</td></tr>
<tr><td class="h">33</td><td colspan="6"></td></tr><tr><td class="h">34</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L34">1</a></div></td><td><div>5</div><div>3</div><div>4</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">35</td><td colspan="6"></td></tr><tr><td class="h">36 - 43</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ClassMethod new( $session ) -&gt; $object

Constructs a new password handler of this type, referring to $session
for any required TWiki services.

=cut</pre></td></tr>
<tr><td class="h">44</td><td colspan="6"></td></tr><tr><td class="h">45</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new {</td></tr>
<tr><td class="h">46</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L46">1</a></div></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $class, $session ) = @_;</td></tr>
<tr><td class="h">47</td><td colspan="6"></td></tr><tr><td class="h">48</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>12</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this = bless( {}, $class );</td></tr>
<tr><td class="h">49</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session} = $session;</td></tr>
<tr><td class="h">50</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $this;</td></tr>
<tr><td class="h">51</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">52</td><td colspan="6"></td></tr><tr><td class="h">53 - 62</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod finish

Complete processing after the client&#39;s HTTP request has been responded
to.
   1 breaking circular references to allow garbage collection in persistent
     environments

=cut</pre></td></tr>
<tr><td class="h">63</td><td colspan="6"></td></tr><tr><td class="h">64</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub finish {</td></tr>
<tr><td class="h">65</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L65">1</a></div></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this = shift;</td></tr>
<tr><td class="h">66</td><td colspan="6"></td></tr><tr><td class="h">67</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">68</td><td colspan="6"></td></tr><tr><td class="h">69 - 78</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod fetchPass( $login ) -&gt; $passwordE

Implements TWiki::Password

Returns encrypted password if succeeds.  Returns 0 if login is invalid.
Returns undef otherwise.

=cut</pre></td></tr>
<tr><td class="h">79</td><td colspan="6"></td></tr><tr><td class="h">80</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub fetchPass {</td></tr>
<tr><td class="h">81</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L81">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</td></tr>
<tr><td class="h">82</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">83</td><td colspan="6"></td></tr><tr><td class="h">84 - 92</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod checkPassword( $user, $passwordU ) -&gt; $boolean

Finds if the password is valid for the given login.

Returns 1 on success, undef on failure.

=cut</pre></td></tr>
<tr><td class="h">93</td><td colspan="6"></td></tr><tr><td class="h">94</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub checkPassword {</td></tr>
<tr><td class="h">95</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L95">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">96</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">97</td><td colspan="6"></td></tr><tr><td class="h">98 - 106</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod deleteUser( $user ) -&gt; $boolean

Delete users entry.

Returns 1 on success, undef on failure.

=cut</pre></td></tr>
<tr><td class="h">107</td><td colspan="6"></td></tr><tr><td class="h">108</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub deleteUser {</td></tr>
<tr><td class="h">109</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L109">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">110</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">111</td><td colspan="6"></td></tr><tr><td class="h">112 - 129</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod passwd( $user, $newPassU, $oldPassU ) -&gt; $boolean

If the $oldPassU is undef, it will try to add the user, failing
if they are already there.

If the $oldPassU matches matches the login&#39;s password, then it will
replace it with $newPassU.

If $oldPassU is not correct and not 1, will return 0.

If $oldPassU is 1, will force the change irrespective of
the existing password, adding the user if necessary.

Otherwise returns 1 on success, undef on failure.

=cut</pre></td></tr>
<tr><td class="h">130</td><td colspan="6"></td></tr><tr><td class="h">131</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub passwd {</td></tr>
<tr><td class="h">132</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L132">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this = shift;</td></tr>
<tr><td class="h">133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{error} = &#39;System does not support changing passwords&#39;;</td></tr>
<tr><td class="h">134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">135</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">136</td><td colspan="6"></td></tr><tr><td class="h">137 - 151</td><td colspan="5"></td><td class="s"><pre>=pod

---++ encrypt( $user, $passwordU, $fresh ) -&gt; $passwordE

Will return an encrypted password. Repeated calls
to encrypt with the same user/passU will return the same passE.

However if the passU is changed, and subsequently changed _back_
to the old user/passU pair, then the old passE is no longer valid.

If $fresh is true, then a new password not based on any pre-existing
salt will be used. Set this if you are generating a completely
new password.

=cut</pre></td></tr>
<tr><td class="h">152</td><td colspan="6"></td></tr><tr><td class="h">153</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub encrypt {</td></tr>
<tr><td class="h">154</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L154">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</td></tr>
<tr><td class="h">155</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">156</td><td colspan="6"></td></tr><tr><td class="h">157 - 164</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod error() -&gt; $string

Return any error raised by the last method call, or undef if the last
method call succeeded.

=cut</pre></td></tr>
<tr><td class="h">165</td><td colspan="6"></td></tr><tr><td class="h">166</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub error {</td></tr>
<tr><td class="h">167</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L167">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</td></tr>
<tr><td class="h">168</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">169</td><td colspan="6"></td></tr><tr><td class="h">170 - 177</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getEmails($user) -&gt; @emails

Fetch the email address(es) for the given username. Default behaviour
is to look up the users&#39; personal topic.

=cut</pre></td></tr>
<tr><td class="h">178</td><td colspan="6"></td></tr><tr><td class="h">179</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getEmails {</td></tr>
<tr><td class="h">180</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L180">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $login ) = @_;</td></tr>
<tr><td class="h">181</td><td colspan="6"></td></tr><tr><td class="h">182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = $this-&gt;{session}-&gt;{users}-&gt;findUser( $login, undef, 1 );</td></tr>
<tr><td class="h">183</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Users-Password-pm--branch.html#L183">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () unless $user;</td></tr>
<tr><td class="h">184</td><td colspan="6"></td></tr><tr><td class="h">185</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($meta, $text) =</td></tr>
<tr><td class="h">186</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{store}-&gt;readTopic(</td></tr>
<tr><td class="h">187</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $TWiki::cfg{UsersWebName}, $user-&gt;wikiName() );</td></tr>
<tr><td class="h">188</td><td colspan="6"></td></tr><tr><td class="h">189</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @addresses;</td></tr>
<tr><td class="h">190</td><td colspan="6"></td></tr><tr><td class="h">191</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Try the form first</td></tr>
<tr><td class="h">192</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry = $meta-&gt;get(&#39;FIELD&#39;, &#39;Email&#39;);</td></tr>
<tr><td class="h">193</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Users-Password-pm--branch.html#L193">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($entry) {</td></tr>
<tr><td class="h">194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push( @addresses, split( /;/, $entry-&gt;{value} ) );</td></tr>
<tr><td class="h">195</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">196</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Now try the topic text</td></tr>
<tr><td class="h">197</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $l (split ( /\r?\n/, $text  )) {</td></tr>
<tr><td class="h">198</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Users-Password-pm--branch.html#L198">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($l =~ /^\s+\*\s+E-?mail:\s*(.*)$/mi) {</td></tr>
<tr><td class="h">199</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @addresses, split( /;/, $1 );</td></tr>
<tr><td class="h">200</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">201</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">202</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">203</td><td colspan="6"></td></tr><tr><td class="h">204</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @addresses;</td></tr>
<tr><td class="h">205</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">206</td><td colspan="6"></td></tr><tr><td class="h">207 - 213</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod setEmails($user, @emails)

Set the email address(es) for the given username in the user topic.

=cut</pre></td></tr>
<tr><td class="h">214</td><td colspan="6"></td></tr><tr><td class="h">215</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub setEmails {</td></tr>
<tr><td class="h">216</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L216">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this = shift;</td></tr>
<tr><td class="h">217</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $login = shift;</td></tr>
<tr><td class="h">218</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mails = join( &#39;;&#39;, @_ );</td></tr>
<tr><td class="h">219</td><td colspan="6"></td></tr><tr><td class="h">220</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = $this-&gt;{session}-&gt;{users}-&gt;findUser( $login, undef, 1 );</td></tr>
<tr><td class="h">221</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Users-Password-pm--branch.html#L221">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () unless $user;</td></tr>
<tr><td class="h">222</td><td colspan="6"></td></tr><tr><td class="h">223</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($meta, $text) =</td></tr>
<tr><td class="h">224</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{store}-&gt;readTopic(</td></tr>
<tr><td class="h">225</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $TWiki::cfg{UsersWebName}, $user-&gt;wikiName() );</td></tr>
<tr><td class="h">226</td><td colspan="6"></td></tr><tr><td class="h">227</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Users-Password-pm--branch.html#L227">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($meta-&gt;get(&#39;FORM&#39;)) {</td></tr>
<tr><td class="h">228</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# use the form if there is one</td></tr>
<tr><td class="h">229</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta-&gt;putKeyed( &#39;FIELD&#39;,</td></tr>
<tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ name =&gt; &#39;Email&#39;,</td></tr>
<tr><td class="h">231</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value =&gt; $mails,</td></tr>
<tr><td class="h">232</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title =&gt; &#39;Email&#39;,</td></tr>
<tr><td class="h">233</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attributes=&gt; &#39;h&#39; } );</td></tr>
<tr><td class="h">234</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">235</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# otherwise use the topic text</td></tr>
<tr><td class="h">236</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Users-Password-pm--branch.html#L236">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless( $text =~ s/^(\s+\*\s+E-?mail:\s*).*$/$1$mails/mi ) {</td></tr>
<tr><td class="h">237</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text .= &quot;\n   * Email: $mails\n&quot;;</td></tr>
<tr><td class="h">238</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">239</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">240</td><td colspan="6"></td></tr><tr><td class="h">241</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{store}-&gt;saveTopic( $user, $TWiki::cfg{UsersWebName},</td></tr>
<tr><td class="h">242</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user-&gt;wikiName(), $text, $meta );</td></tr>
<tr><td class="h">243</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">244</td><td colspan="6"></td></tr><tr><td class="h">245</td><td></td><td></td><td></td><td></td><td></td><td class="s">#returns an array of user objects that relate to a email address</td></tr>
<tr><td class="h">246</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub findUserByEmail {</td></tr>
<tr><td class="h">247</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Users-Password-pm--subroutine.html#L247">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this = shift;</td></tr>
<tr><td class="h">248</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $email = shift;</td></tr>
<tr><td class="h">249</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: there is no way in TWiki to map from an email back to a user, so</td></tr>
<tr><td class="h">250</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we have to cheat. We do this as follows:</td></tr>
<tr><td class="h">251</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Users-Password-pm--branch.html#L251">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $this-&gt;{_MAP_OF_EMAILS} ) {</td></tr>
<tr><td class="h">252</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{_MAP_OF_EMAILS} = ();</td></tr>
<tr><td class="h">253</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $users = $this-&gt;{session}-&gt;{users}-&gt;getAllUsers();</td></tr>
<tr><td class="h">254</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $user ( @{$users} ) {</td></tr>
<tr><td class="h">255</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map { push( @{$this-&gt;{_MAP_OF_EMAILS}-&gt;{$_}}, $user); } $user-&gt;emails();</td></tr>
<tr><td class="h">256</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">257</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">258</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;{_MAP_OF_EMAILS}-&gt;{$email};</td></tr>
<tr><td class="h">259</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">260</td><td colspan="6"></td></tr><tr><td class="h">261</td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
