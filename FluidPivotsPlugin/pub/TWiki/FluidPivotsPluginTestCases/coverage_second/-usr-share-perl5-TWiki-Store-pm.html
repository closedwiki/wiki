<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: /usr/share/perl5/TWiki/Store.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">/usr/share/perl5/TWiki/Store.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">22.3%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Module of TWiki Enterprise Collaboration Platform, http://TWiki.org/</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Copyright (C) 2002-2007 Peter Thoeny, peter@thoeny.org</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td class="s"># and TWiki Contributors. All Rights Reserved. TWiki Contributors</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td class="s"># are listed in the AUTHORS file in the root of this distribution.</td></tr>
<tr><td class="h">6</td><td></td><td></td><td></td><td></td><td></td><td class="s"># NOTE: Please extend that file, not this notice.</td></tr>
<tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">8</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is free software; you can redistribute it and/or</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td class="s"># modify it under the terms of the GNU General Public License</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td class="s"># as published by the Free Software Foundation; either version 2</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td class="s"># of the License, or (at your option) any later version. For</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td class="s"># more details read LICENSE in the root of this distribution.</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is distributed in the hope that it will be useful,</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td class="s"># but WITHOUT ANY WARRANTY; without even the implied warranty of</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td class="s"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td class="s"># As per the GPL, removal of this notice is prohibited.</td></tr>
<tr><td class="h">19</td><td colspan="6"></td></tr><tr><td class="h">20 - 38</td><td colspan="5"></td><td class="s"><pre>=begin twiki

---+ package TWiki::Store

This module hosts the generic storage backend. This module provides
the interface layer between the &quot;real&quot; store provider - which is hidden
behind a handler - and the rest of the system. it is responsible for
checking for topic existance, access permissions, and all the other
general admin tasks that are common to all store implementations.

This module knows nothing about how the data is actually _stored_ -
that knowledge is entirely encapsulated in the handlers.

The general contract for methods in the class requires that errors
are signalled using exceptions. TWiki::AccessControlException is
used for access control exceptions, and Error::Simple for all other
types of error.

=cut</pre></td></tr>
<tr><td class="h">39</td><td colspan="6"></td></tr><tr><td class="h">40</td><td></td><td></td><td></td><td></td><td></td><td class="s">package TWiki::Store;</td></tr>
<tr><td class="h">41</td><td colspan="6"></td></tr><tr><td class="h">42</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L42">1</a></div></td><td><div>5</div><div>2</div><div>6</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">43</td><td colspan="6"></td></tr><tr><td class="h">44</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L44">1</a></div></td><td><div>7</div><div>2</div><div>5</div></td><td class="s">use Assert;</td></tr>
<tr><td class="h">45</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L45">1</a></div></td><td><div>7</div><div>2</div><div>8</div></td><td class="s">use Error qw( :try );</td></tr>
<tr><td class="h">46</td><td colspan="6"></td></tr><tr><td class="h">47</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L47">1</a></div></td><td><div>10</div><div>3</div><div>3</div></td><td class="s">use TWiki::Meta ();</td></tr>
<tr><td class="h">48</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L48">1</a></div></td><td><div>11</div><div>3</div><div>3</div></td><td class="s">use TWiki::Time ();</td></tr>
<tr><td class="h">49</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L49">1</a></div></td><td><div>10</div><div>3</div><div>3</div></td><td class="s">use TWiki::AccessControlException ();</td></tr>
<tr><td class="h">50</td><td colspan="6"></td></tr><tr><td class="h">51</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L51">1</a></div></td><td><div>6</div><div>3</div><div>14</div></td><td class="s">use vars qw( $STORE_FORMAT_VERSION );</td></tr>
<tr><td class="h">52</td><td colspan="6"></td></tr><tr><td class="h">53</td><td></td><td></td><td></td><td></td><td></td><td class="s">$STORE_FORMAT_VERSION = &#39;1.1&#39;;</td></tr>
<tr><td class="h">54</td><td colspan="6"></td></tr><tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td class="s">BEGIN {</td></tr>
<tr><td class="h">56</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Do a dynamic &#39;use locale&#39; for this module</td></tr>
<tr><td class="h">57</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L57">50</a></div></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L57">1</a></div></td><td><div>9</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $TWiki::cfg{UseLocale} ) {</td></tr>
<tr><td class="h">58</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require locale;</td></tr>
<tr><td class="h">59</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;import locale();</td></tr>
<tr><td class="h">60</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">61</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">62</td><td colspan="6"></td></tr><tr><td class="h">63 - 69</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ClassMethod new()

Construct a Store module, linking in the chosen sub-implementation.

=cut</pre></td></tr>
<tr><td class="h">70</td><td colspan="6"></td></tr><tr><td class="h">71</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new {</td></tr>
<tr><td class="h">72</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L72">1</a></div></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $class, $session ) = @_;</td></tr>
<tr><td class="h">73</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($session-&gt;isa(&#39;TWiki&#39;)) if DEBUG;</td></tr>
<tr><td class="h">74</td><td colspan="6"></td></tr><tr><td class="h">75</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>9</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this = bless( {}, $class );</td></tr>
<tr><td class="h">76</td><td colspan="6"></td></tr><tr><td class="h">77</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session} = $session;</td></tr>
<tr><td class="h">78</td><td colspan="6"></td></tr><tr><td class="h">79</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{IMPL} = &#39;TWiki::Store::&#39;.$TWiki::cfg{StoreImpl};</td></tr>
<tr><td class="h">80</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L80">1</a></div></td><td><div>24</div><div>3</div><div>12</div><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;eval &#39;use &#39;.$this-&gt;{IMPL};</td></tr>
<tr><td class="h">81</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L81">50</a></div></td><td></td><td></td><td><div>15</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $@ ) {</td></tr>
<tr><td class="h">82</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;$this-&gt;{IMPL} compile failed $@&quot;;</td></tr>
<tr><td class="h">83</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">84</td><td colspan="6"></td></tr><tr><td class="h">85</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>8</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $this;</td></tr>
<tr><td class="h">86</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">87</td><td colspan="6"></td></tr><tr><td class="h">88 - 97</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod finish

Complete processing after the client&#39;s HTTP request has been responded
to.
   1 breaking circular references to allow garbage collection in persistent
     environments

=cut</pre></td></tr>
<tr><td class="h">98</td><td colspan="6"></td></tr><tr><td class="h">99</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub finish {</td></tr>
<tr><td class="h">100</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L100">1</a></div></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this = shift;</td></tr>
<tr><td class="h">101</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>9</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{IMPL}-&gt;finish();</td></tr>
<tr><td class="h">102</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">103</td><td colspan="6"></td></tr><tr><td class="h">104</td><td></td><td></td><td></td><td></td><td></td><td class="s"># PRIVATE</td></tr>
<tr><td class="h">105</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Get the handler for the current store implementation.</td></tr>
<tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td class="s"># $web, $topic and $attachment _must_ be untainted.</td></tr>
<tr><td class="h">107</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _getHandler {</td></tr>
<tr><td class="h">108</td><td><div class="c3">148</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L108">148</a></div></td><td><div>569</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic, $attachment ) = @_;</td></tr>
<tr><td class="h">109</td><td colspan="6"></td></tr><tr><td class="h">110</td><td><div class="c3">148</div></td><td></td><td></td><td></td><td><div>994</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;{IMPL}-&gt;new( $this-&gt;{session}, $web, $topic, $attachment );</td></tr>
<tr><td class="h">111</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">112</td><td colspan="6"></td></tr><tr><td class="h">113 - 132</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod readTopic($user, $web, $topic, $version) -&gt; ($metaObject, $text)

Reads the given version of a topic and it&#39;s meta-data. If the version
is undef, then read the most recent version. The version number must be
an integer, or undef for the latest version.

if $user is defined, view permission will be required for the topic
read to be successful.  Access control violations are flagged by a
TWiki::AccessControlException. Permissions are checked for the user
name passed in.

If the topic contains a web specification (is of the form Web.Topic) the
web specification will override whatever is passed in $web.

The metadata and topic text are returned separately, with the metadata in a
TWiki::Meta object.  (The topic text is, as usual, just a string.)

=cut</pre></td></tr>
<tr><td class="h">133</td><td colspan="6"></td></tr><tr><td class="h">134</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub readTopic {</td></tr>
<tr><td class="h">135</td><td><div class="c3">41</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L135">41</a></div></td><td><div>191</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $user, $web, $topic, $version ) = @_;</td></tr>
<tr><td class="h">136</td><td><div class="c3">41</div></td><td></td><td></td><td></td><td><div>95</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">137</td><td><div class="c3">41</div></td><td></td><td></td><td></td><td><div>152</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">138</td><td colspan="6"></td></tr><tr><td class="h">139</td><td><div class="c3">41</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L139">50</a></div></td><td></td><td></td><td><div>181</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $version) {</td></tr>
<tr><td class="h">140</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$version = $this-&gt;cleanUpRevID( $version );</td></tr>
<tr><td class="h">141</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">142</td><td colspan="6"></td></tr><tr><td class="h">143</td><td><div class="c3">41</div></td><td></td><td></td><td></td><td><div>189</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $text = $this-&gt;readTopicRaw( $user, $web, $topic, $version );</td></tr>
<tr><td class="h">144</td><td><div class="c3">41</div></td><td></td><td></td><td></td><td><div>322</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $meta = new TWiki::Meta( $this-&gt;{session}, $web, $topic);</td></tr>
<tr><td class="h">145</td><td><div class="c3">41</div></td><td></td><td></td><td></td><td><div>205</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;extractMetaData( $meta, \$text );</td></tr>
<tr><td class="h">146</td><td colspan="6"></td></tr><tr><td class="h">147</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Override meta with that blended from pub.</td></tr>
<tr><td class="h">148</td><td><div class="c3">41</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L148">50</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L148">25</a></div></td><td></td><td><div>352</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($TWiki::cfg{AutoAttachPubFiles} &amp;&amp;</td></tr>
<tr><td class="h">149</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$web eq $this-&gt;{session}{webName} &amp;&amp; # only check the currently requested topic</td></tr>
<tr><td class="h">150</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$topic eq $this-&gt;{session}{topicName}) {</td></tr>
<tr><td class="h">151</td><td colspan="6"></td></tr><tr><td class="h">152</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @knownAttachments = $meta-&gt;find(&#39;FILEATTACHMENT&#39;);</td></tr>
<tr><td class="h">153</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @attachmentsFoundInPub = _findAttachments($this, $web, $topic, \@knownAttachments);</td></tr>
<tr><td class="h">154</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L154">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta-&gt;putAll(&#39;FILEATTACHMENT&#39;, @attachmentsFoundInPub) if @attachmentsFoundInPub;</td></tr>
<tr><td class="h">155</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">156</td><td colspan="6"></td></tr><tr><td class="h">157</td><td><div class="c3">41</div></td><td></td><td></td><td></td><td><div>518</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return( $meta, $text );</td></tr>
<tr><td class="h">158</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">159</td><td colspan="6"></td></tr><tr><td class="h">160 - 175</td><td colspan="5"></td><td class="s"><pre>=pod 

---++ ObjectMethod _findAttachments($session, $web, $topic, $knownAttachments) -&gt; @attachmentsFoundInPub

Synchronise the attachment list with what&#39;s actually on disk Returns an ARRAY
of FILEATTACHMENTs. These can be put in the new meta using
meta-&gt;put(&#39;FILEATTACHMENTS&#39;, $tree) 

This function is only called when the AutoAttachPubFiles configuration option is set.

IDEA On Windows machines where the underlying filesystem can store arbitary
meta data against files, this might replace/fulfil the COMMENT purpose

TODO consider logging when things are added to metadata

=cut</pre></td></tr>
<tr><td class="h">176</td><td colspan="6"></td></tr><tr><td class="h">177</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _findAttachments {</td></tr>
<tr><td class="h">178</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L178">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($this, $web, $topic, $attachmentsKnownInMeta) = @_;</td></tr>
<tr><td class="h">179</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $session = $this-&gt;{session};</td></tr>
<tr><td class="h">180</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($session-&gt;isa( &#39;TWiki&#39; )) if DEBUG;</td></tr>
<tr><td class="h">181</td><td colspan="6"></td></tr><tr><td class="h">182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $store = $this;</td></tr>
<tr><td class="h">183</td><td colspan="6"></td></tr><tr><td class="h">184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %filesListedInPub = $store-&gt;getAttachmentList($web, $topic);</td></tr>
<tr><td class="h">185</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %filesListedInMeta = ();</td></tr>
<tr><td class="h">186</td><td colspan="6"></td></tr><tr><td class="h">187</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# You need the following lines if you want metadata to supplement</td></tr>
<tr><td class="h">188</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the filesystem</td></tr>
<tr><td class="h">189</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L189">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $attachmentsKnownInMeta) {</td></tr>
<tr><td class="h">190</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%filesListedInMeta =</td></tr>
<tr><td class="h">191</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TWiki::Meta::indexByKey(&#39;name&#39;, @$attachmentsKnownInMeta);</td></tr>
<tr><td class="h">192</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">193</td><td colspan="6"></td></tr><tr><td class="h">194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $file (keys %filesListedInPub) {</td></tr>
<tr><td class="h">195</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L195">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($filesListedInMeta{$file}) {</td></tr>
<tr><td class="h">196</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Bring forward any missing yet wanted attributes</td></tr>
<tr><td class="h">197</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#SMELL: this will over-write (empty) any meta data field not listed here :( </td></tr>
<tr><td class="h">198</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $field qw(comment attr user version) {</td></tr>
<tr><td class="h">199</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L199">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($filesListedInMeta{$file}{$field}) {</td></tr>
<tr><td class="h">200</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filesListedInPub{$file}{$field} =</td></tr>
<tr><td class="h">201</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filesListedInMeta{$file}{$field};</td></tr>
<tr><td class="h">202</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">203</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">204</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Develop:Bugs.Item452 - WHY IS USER STILL WRONG?</td></tr>
<tr><td class="h">205</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">206</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">207</td><td colspan="6"></td></tr><tr><td class="h">208</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# A comparison of the keys of the $filesListedInMeta and %filesListedInPub </td></tr>
<tr><td class="h">209</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# would show files that were in Meta but have disappeared from Pub.</td></tr>
<tr><td class="h">210</td><td colspan="6"></td></tr><tr><td class="h">211</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# SMELL Meta really ought index its attachments in a hash by attachment</td></tr>
<tr><td class="h">212</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# name but this is not the case</td></tr>
<tr><td class="h">213</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#</td></tr>
<tr><td class="h">214</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: Do not change this from array to hash, you would lose the</td></tr>
<tr><td class="h">215</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# proper attachment sequence </td></tr>
<tr><td class="h">216</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#</td></tr>
<tr><td class="h">217</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @deindexedBecauseMetaDoesnotIndexAttachments =</td></tr>
<tr><td class="h">218</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TWiki::Meta::deindexKeyed(%filesListedInPub);</td></tr>
<tr><td class="h">219</td><td colspan="6"></td></tr><tr><td class="h">220</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @deindexedBecauseMetaDoesnotIndexAttachments;</td></tr>
<tr><td class="h">221</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">222</td><td colspan="6"></td></tr><tr><td class="h">223</td><td colspan="6"></td></tr><tr><td class="h">224 - 247</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod readTopicRaw( $user, $web, $topic, $version ) -&gt;  $topicText

Reads the given version of a topic, without separating out any embedded
meta-data. If the version is undef, then read the most recent version.
The version number must be an integer or undef.

If $user is defined, view permission will be required for the topic
read to be successful.  Access control violations are flagged by a
TWiki::AccessControlException. Permissions are checked for the user
name passed in.

If the topic contains a web specification (is of the form Web.Topic) the
web specification will override whatever is passed in $web.

SMELL: DO NOT CALL THIS METHOD UNLESS YOU HAVE NO CHOICE. This method breaks
encapsulation of the store, as it assumes meta is stored embedded in the text.
Other implementors of store will be forced to insert meta-data to ensure
correct operation of View raw=debug and the &#39;repRev&#39; mode of Edit.

$web and $topic _must_ be untainted.

=cut</pre></td></tr>
<tr><td class="h">248</td><td colspan="6"></td></tr><tr><td class="h">249</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub readTopicRaw {</td></tr>
<tr><td class="h">250</td><td><div class="c3">45</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L250">45</a></div></td><td><div>198</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $user, $web, $topic, $version ) = @_;</td></tr>
<tr><td class="h">251</td><td><div class="c3">45</div></td><td></td><td></td><td></td><td><div>122</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">252</td><td><div class="c3">45</div></td><td></td><td></td><td></td><td><div>136</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">253</td><td colspan="6"></td></tr><tr><td class="h">254</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# test if topic contains a webName to override $web</td></tr>
<tr><td class="h">255</td><td><div class="c3">45</div></td><td></td><td></td><td></td><td><div>243</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;( $web, $topic ) =</td></tr>
<tr><td class="h">256</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;normalizeWebTopicName( $web, $topic );</td></tr>
<tr><td class="h">257</td><td colspan="6"></td></tr><tr><td class="h">258</td><td><div class="c3">45</div></td><td></td><td></td><td></td><td><div>137</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $text;</td></tr>
<tr><td class="h">259</td><td colspan="6"></td></tr><tr><td class="h">260</td><td><div class="c3">45</div></td><td></td><td></td><td></td><td><div>173</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">261</td><td><div class="c3">45</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L261">50</a></div></td><td></td><td></td><td><div>338</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $version ) {</td></tr>
<tr><td class="h">262</td><td><div class="c3">45</div></td><td></td><td></td><td></td><td><div>208</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = $handler-&gt;getLatestRevision();</td></tr>
<tr><td class="h">263</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">264</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = $handler-&gt;getRevision( $version );</td></tr>
<tr><td class="h">265</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">266</td><td colspan="6"></td></tr><tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Note: passing undef as meta will cause extraction of the meta</td></tr>
<tr><td class="h">268</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# from the (raw) text passed</td></tr>
<tr><td class="h">269</td><td><div class="c3">45</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L269">50</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L269">67</a></div></td><td></td><td><div>316</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">271</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;view&#39;, $user, $text, undef, $topic, $web )) {</td></tr>
<tr><td class="h">272</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException(</td></tr>
<tr><td class="h">273</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;VIEW&#39;, $user, $web, $topic,</td></tr>
<tr><td class="h">274</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">275</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">276</td><td colspan="6"></td></tr><tr><td class="h">277</td><td><div class="c3">45</div></td><td></td><td></td><td></td><td><div>414</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $text;</td></tr>
<tr><td class="h">278</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">279</td><td colspan="6"></td></tr><tr><td class="h">280 - 290</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod moveAttachment( $oldWeb, $oldTopic, $oldAttachment, $newWeb, $newTopic, $newAttachment, $user  )

Move an attachment from one topic to another.

The caller to this routine should check that all topics are valid.

All parameters must be defined, and must be untainted.

=cut</pre></td></tr>
<tr><td class="h">291</td><td colspan="6"></td></tr><tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub moveAttachment {</td></tr>
<tr><td class="h">293</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L293">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $oldWeb, $oldTopic, $oldAttachment,</td></tr>
<tr><td class="h">294</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newWeb, $newTopic, $newAttachment, $user ) = @_;</td></tr>
<tr><td class="h">295</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">297</td><td colspan="6"></td></tr><tr><td class="h">298</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;lockTopic( $user, $oldWeb, $oldTopic );</td></tr>
<tr><td class="h">299</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">300</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L300">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my( $ometa, $otext ) = $this-&gt;readTopic( undef, $oldWeb, $oldTopic );</td></tr>
<tr><td class="h">301</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L301">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L301">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">302</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">303</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;change&#39;, $user, $otext, $ometa, $oldTopic, $oldWeb )) {</td></tr>
<tr><td class="h">304</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException(</td></tr>
<tr><td class="h">305</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;CHANGE&#39;, $user, $oldWeb, $oldTopic,</td></tr>
<tr><td class="h">306</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">307</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">308</td><td colspan="6"></td></tr><tr><td class="h">309</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $nmeta, $ntext ) = $this-&gt;readTopic( undef, $newWeb, $newTopic );</td></tr>
<tr><td class="h">310</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L310">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L310">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">311</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">312</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;change&#39;, $user, $ntext, $nmeta, $newTopic, $newWeb )) {</td></tr>
<tr><td class="h">313</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException(</td></tr>
<tr><td class="h">314</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;CHANGE&#39;, $user, $newWeb, $newTopic,</td></tr>
<tr><td class="h">315</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">316</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">317</td><td colspan="6"></td></tr><tr><td class="h">318</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Remove file attachment from old topic</td></tr>
<tr><td class="h">319</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $handler =</td></tr>
<tr><td class="h">320</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getHandler( $oldWeb, $oldTopic, $oldAttachment );</td></tr>
<tr><td class="h">321</td><td colspan="6"></td></tr><tr><td class="h">322</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;moveAttachment( $newWeb, $newTopic, $newAttachment );</td></tr>
<tr><td class="h">323</td><td colspan="6"></td></tr><tr><td class="h">324</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fileAttachment =</td></tr>
<tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ometa-&gt;get( &#39;FILEATTACHMENT&#39;, $oldAttachment );</td></tr>
<tr><td class="h">326</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ometa-&gt;remove( &#39;FILEATTACHMENT&#39;, $oldAttachment );</td></tr>
<tr><td class="h">327</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_noHandlersSave( $user, $oldWeb, $oldTopic, $otext, $ometa,</td></tr>
<tr><td class="h">328</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ notify =&gt; 0 } );</td></tr>
<tr><td class="h">329</td><td colspan="6"></td></tr><tr><td class="h">330</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Add file attachment to new topic</td></tr>
<tr><td class="h">331</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fileAttachment-&gt;{name} = $newAttachment;</td></tr>
<tr><td class="h">332</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fileAttachment-&gt;{movefrom} = $oldWeb.&#39;.&#39;.$oldTopic.&#39;.&#39;.$oldAttachment;</td></tr>
<tr><td class="h">333</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fileAttachment-&gt;{moveby}   = $user-&gt;webDotWikiName();</td></tr>
<tr><td class="h">334</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fileAttachment-&gt;{movedto}  = $newWeb.&#39;.&#39;.$newTopic.&#39;.&#39;.$newAttachment;</td></tr>
<tr><td class="h">335</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fileAttachment-&gt;{movedwhen} = time();</td></tr>
<tr><td class="h">336</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nmeta-&gt;putKeyed( &#39;FILEATTACHMENT&#39;, $fileAttachment );</td></tr>
<tr><td class="h">337</td><td colspan="6"></td></tr><tr><td class="h">338</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_noHandlersSave( $user, $newWeb, $newTopic, $ntext,</td></tr>
<tr><td class="h">339</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nmeta, { dontlog =&gt; 1,</td></tr>
<tr><td class="h">340</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;notify =&gt; 0,</td></tr>
<tr><td class="h">341</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comment =&gt; &#39;moved&#39; } );</td></tr>
<tr><td class="h">342</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeLog(</td></tr>
<tr><td class="h">343</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;move&#39;,</td></tr>
<tr><td class="h">344</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fileAttachment-&gt;{movefrom}.&#39; moved to &#39;.</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fileAttachment-&gt;{movedto}, $user-&gt;webDotWikiName() );</td></tr>
<tr><td class="h">346</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} finally {</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L347">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unlockTopic( $user, $oldWeb, $oldTopic );</td></tr>
<tr><td class="h">348</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unlockTopic( $user, $newWeb, $newTopic );</td></tr>
<tr><td class="h">349</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">350</td><td colspan="6"></td></tr><tr><td class="h">351</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# alert plugins of attachment move</td></tr>
<tr><td class="h">352</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{plugins}-&gt;afterRenameHandler( $oldWeb, $oldTopic, $oldAttachment,</td></tr>
<tr><td class="h">353</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newWeb, $newTopic, $newAttachment );</td></tr>
<tr><td class="h">354</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">355</td><td colspan="6"></td></tr><tr><td class="h">356 - 373</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getAttachmentStream( $user, $web, $topic, $attName ) -&gt; \*STREAM

   * =$user= - the user doing the reading, or undef if no access checks
   * =$web= - The web
   * =$topic= - The topic
   * =$attName= - Name of the attachment

Open a standard input stream from an attachment.

If $user is defined, view permission will be required for the topic
read to be successful.  Access control violations and errors will
cause exceptions to be thrown.

Permissions are checked for the user name passed in.

=cut</pre></td></tr>
<tr><td class="h">374</td><td colspan="6"></td></tr><tr><td class="h">375</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getAttachmentStream {</td></tr>
<tr><td class="h">376</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L376">1</a></div></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $user, $web, $topic, $att ) = @_;</td></tr>
<tr><td class="h">377</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>2</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">378</td><td colspan="6"></td></tr><tr><td class="h">379</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L379">50</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L379">33</a></div></td><td></td><td><div>8</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">380</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">381</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;view&#39;, $user, undef, undef, $topic, $web )) {</td></tr>
<tr><td class="h">382</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException( &#39;VIEW&#39;, $user, $web, $topic,</td></tr>
<tr><td class="h">383</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">385</td><td colspan="6"></td></tr><tr><td class="h">386</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic, $att );</td></tr>
<tr><td class="h">387</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>9</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;getStream();</td></tr>
<tr><td class="h">388</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">389</td><td colspan="6"></td></tr><tr><td class="h">390 - 396</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getAttachmentList($web, $topic)

returns @($attachmentName =&gt; [stat]) for any given web, topic

=cut</pre></td></tr>
<tr><td class="h">397</td><td colspan="6"></td></tr><tr><td class="h">398</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getAttachmentList {</td></tr>
<tr><td class="h">399</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L399">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic ) = @_;</td></tr>
<tr><td class="h">400</td><td colspan="6"></td></tr><tr><td class="h">401</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">402</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">403</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;getAttachmentList($web, $topic);</td></tr>
<tr><td class="h">404</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">405</td><td colspan="6"></td></tr><tr><td class="h">406 - 412</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod attachmentExists( $web, $topic, $att ) -&gt; $boolean

Determine if the attachment already exists on the given topic

=cut</pre></td></tr>
<tr><td class="h">413</td><td colspan="6"></td></tr><tr><td class="h">414</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub attachmentExists {</td></tr>
<tr><td class="h">415</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L415">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic, $att ) = @_;</td></tr>
<tr><td class="h">416</td><td colspan="6"></td></tr><tr><td class="h">417</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">418</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic, $att );</td></tr>
<tr><td class="h">419</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;storedDataExists();</td></tr>
<tr><td class="h">420</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">421</td><td colspan="6"></td></tr><tr><td class="h">422 - 428</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod _removeAutoAttachmentsFromMeta

This is where we are going to remove from meta any entry that is marked as an automatic attachment.

=cut</pre></td></tr>
<tr><td class="h">429</td><td colspan="6"></td></tr><tr><td class="h">430</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _removeAutoAttachmentsFromMeta {</td></tr>
<tr><td class="h">431</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L431">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($this, $meta) = @_;</td></tr>
<tr><td class="h">432</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    use Data::Dumper;</td></tr>
<tr><td class="h">433</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    die &quot;removeAutoAttachmentsFromMeta&quot;.Dumper($meta);</td></tr>
<tr><td class="h">434</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $meta;</td></tr>
<tr><td class="h">435</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">436</td><td colspan="6"></td></tr><tr><td class="h">437 - 443</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod moveTopic(  $oldWeb, $oldTopic, $newWeb, $newTopic, $user )

All parameters must be defined and must be untainted.

=cut</pre></td></tr>
<tr><td class="h">444</td><td colspan="6"></td></tr><tr><td class="h">445</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub moveTopic {</td></tr>
<tr><td class="h">446</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L446">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $oldWeb, $oldTopic, $newWeb, $newTopic, $user ) = @_;</td></tr>
<tr><td class="h">447</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">448</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">449</td><td colspan="6"></td></tr><tr><td class="h">450</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $oldWeb, $oldTopic, &#39;&#39; );</td></tr>
<tr><td class="h">451</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rev = $handler-&gt;numRevisions();</td></tr>
<tr><td class="h">452</td><td colspan="6"></td></tr><tr><td class="h">453</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# will block</td></tr>
<tr><td class="h">454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;lockTopic( $user, $oldWeb, $oldTopic );</td></tr>
<tr><td class="h">455</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">456</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L456">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $otext = $this-&gt;readTopicRaw( undef, $oldWeb, $oldTopic );</td></tr>
<tr><td class="h">457</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Note: undef $meta param will cause $otext to be parsed for meta</td></tr>
<tr><td class="h">458</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L458">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L458">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">459</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">460</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;change&#39;, $user, $otext, undef, $oldTopic, $oldWeb )) {</td></tr>
<tr><td class="h">461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException(</td></tr>
<tr><td class="h">462</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;CHANGE&#39;, $user,</td></tr>
<tr><td class="h">463</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$oldWeb, $oldTopic,</td></tr>
<tr><td class="h">464</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">465</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">466</td><td colspan="6"></td></tr><tr><td class="h">467</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $nmeta, $ntext );</td></tr>
<tr><td class="h">468</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L468">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $this-&gt;topicExists( $newWeb, $newTopic )) {</td></tr>
<tr><td class="h">469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $nmeta, $ntext ) = $this-&gt;readTopic( undef, $newWeb, $newTopic );</td></tr>
<tr><td class="h">470</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">471</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L471">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L471">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">472</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">473</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;change&#39;, $user, $ntext, $nmeta, $newTopic, $newWeb )) {</td></tr>
<tr><td class="h">474</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException(</td></tr>
<tr><td class="h">475</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;CHANGE&#39;, $user, $newWeb, $newTopic,</td></tr>
<tr><td class="h">476</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">477</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">478</td><td colspan="6"></td></tr><tr><td class="h">479</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;moveTopic( $newWeb, $newTopic );</td></tr>
<tr><td class="h">480</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} finally {</td></tr>
<tr><td class="h">481</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L481">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unlockTopic( $user, $oldWeb, $oldTopic );</td></tr>
<tr><td class="h">482</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">483</td><td colspan="6"></td></tr><tr><td class="h">484</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L484">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $newWeb ne $oldWeb ) {</td></tr>
<tr><td class="h">485</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Record that it was moved away</td></tr>
<tr><td class="h">486</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_recordChange( $oldWeb, $oldTopic, $user, $rev );</td></tr>
<tr><td class="h">487</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">488</td><td colspan="6"></td></tr><tr><td class="h">489</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_recordChange( $newWeb, $newTopic, $user, $rev );</td></tr>
<tr><td class="h">490</td><td colspan="6"></td></tr><tr><td class="h">491</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Log rename</td></tr>
<tr><td class="h">492</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L492">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $TWiki::cfg{Log}{rename} ) {</td></tr>
<tr><td class="h">493</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $old = $oldWeb.&#39;.&#39;.$oldTopic;</td></tr>
<tr><td class="h">494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $new = $newWeb.&#39;.&#39;.$newTopic;</td></tr>
<tr><td class="h">495</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeLog( &#39;rename&#39;, $old, &quot;moved to $new&quot;, $user );</td></tr>
<tr><td class="h">496</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">497</td><td colspan="6"></td></tr><tr><td class="h">498</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# alert plugins of topic move</td></tr>
<tr><td class="h">499</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{plugins}-&gt;afterRenameHandler( $oldWeb, $oldTopic, &#39;&#39;,</td></tr>
<tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newWeb, $newTopic, &#39;&#39; );</td></tr>
<tr><td class="h">501</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">502</td><td colspan="6"></td></tr><tr><td class="h">503</td><td></td><td></td><td></td><td></td><td></td><td class="s"># update .changes for statistics and mailer</td></tr>
<tr><td class="h">504</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _recordChange {</td></tr>
<tr><td class="h">505</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L505">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic, $user, $rev, $more ) = @_;</td></tr>
<tr><td class="h">506</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L506">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$more ||= &#39;&#39;;</td></tr>
<tr><td class="h">507</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @foo = map { my @row = split(/\t/, $_); \@row }</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;split( /[\r\n]+/, $this-&gt;readMetaData( $web, &#39;changes&#39; ));</td></tr>
<tr><td class="h">509</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: make the 500 configurable? Or trim on the basis of age?</td></tr>
<tr><td class="h">510</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L510">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;shift( @foo) if( $#foo &gt; 500 );</td></tr>
<tr><td class="h">511</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push( @foo, [ $topic, $user-&gt;login(), time(), $rev, $more ] );</td></tr>
<tr><td class="h">512</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;saveMetaData(</td></tr>
<tr><td class="h">513</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$web, &#39;changes&#39;,</td></tr>
<tr><td class="h">514</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join( &quot;\n&quot;,</td></tr>
<tr><td class="h">515</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map { join( &quot;\t&quot;, @$_); } @foo ));</td></tr>
<tr><td class="h">516</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">517</td><td colspan="6"></td></tr><tr><td class="h">518 - 526</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod moveWeb( $oldWeb, $newWeb, $user )

Move a web.

All parrameters must be defined and must be untainted.

=cut</pre></td></tr>
<tr><td class="h">527</td><td colspan="6"></td></tr><tr><td class="h">528</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub moveWeb {</td></tr>
<tr><td class="h">529</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L529">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $oldWeb, $newWeb, $user ) = @_;</td></tr>
<tr><td class="h">530</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">532</td><td colspan="6"></td></tr><tr><td class="h">533</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$oldWeb =~ s/\./\//go;</td></tr>
<tr><td class="h">534</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$newWeb =~ s/\./\//go;</td></tr>
<tr><td class="h">535</td><td colspan="6"></td></tr><tr><td class="h">536</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my (@webList) = $this-&gt;getListOfWebs(&#39;public&#39;, $oldWeb);</td></tr>
<tr><td class="h">537</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unshift(@webList,$oldWeb);</td></tr>
<tr><td class="h">538</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $webIter (@webList) {</td></tr>
<tr><td class="h">539</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L539">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $webIter ) {</td></tr>
<tr><td class="h">540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @webTopicList = $this-&gt;getTopicNames( $webIter );</td></tr>
<tr><td class="h">541</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $webTopic (@webTopicList) {</td></tr>
<tr><td class="h">542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;lockTopic( $user, $webIter, $webTopic );</td></tr>
<tr><td class="h">543</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">544</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">545</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">546</td><td colspan="6"></td></tr><tr><td class="h">547</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @newParentPath = split(/\//,$newWeb);</td></tr>
<tr><td class="h">548</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;pop( @newParentPath );</td></tr>
<tr><td class="h">549</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $newParent = join( &#39;/&#39;, @newParentPath );</td></tr>
<tr><td class="h">550</td><td colspan="6"></td></tr><tr><td class="h">551</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $oldWeb );</td></tr>
<tr><td class="h">552</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;moveWeb( $newWeb );</td></tr>
<tr><td class="h">553</td><td colspan="6"></td></tr><tr><td class="h">554</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;(@webList) = $this-&gt;getListOfWebs(&#39;public&#39;, $newWeb);</td></tr>
<tr><td class="h">555</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unshift(@webList, $newWeb);</td></tr>
<tr><td class="h">556</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $webIter (@webList) {</td></tr>
<tr><td class="h">557</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L557">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $webIter ) {</td></tr>
<tr><td class="h">558</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @webTopicList = $this-&gt;getTopicNames( $webIter );</td></tr>
<tr><td class="h">559</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $webTopic (@webTopicList) {</td></tr>
<tr><td class="h">560</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unlockTopic( $user, $webIter, $webTopic );</td></tr>
<tr><td class="h">561</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">562</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">563</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">564</td><td colspan="6"></td></tr><tr><td class="h">565</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Log rename</td></tr>
<tr><td class="h">566</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L566">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $TWiki::cfg{Log}{rename} ) {</td></tr>
<tr><td class="h">567</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeLog( &#39;renameweb&#39;, $oldWeb, &#39;moved to &#39;.$newWeb, $user );</td></tr>
<tr><td class="h">568</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">569</td><td colspan="6"></td></tr><tr><td class="h">570</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# alert plugins of web move</td></tr>
<tr><td class="h">571</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{plugins}-&gt;afterRenameHandler( $oldWeb, &#39;&#39;, &#39;&#39;, $newWeb, &#39;&#39;, &#39;&#39; );</td></tr>
<tr><td class="h">572</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">573</td><td colspan="6"></td></tr><tr><td class="h">574 - 587</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod readAttachment( $user, $web, $topic, $attachment, $theRev  ) -&gt; $text

Read the given version of an attachment, returning the content.

View permission on the topic is required for the
read to be successful.  Access control violations are flagged by a
TWiki::AccessControlException. Permissions are checked for the user
passed in.

If $theRev is not given, the most recent rev is assumed.

=cut</pre></td></tr>
<tr><td class="h">588</td><td colspan="6"></td></tr><tr><td class="h">589</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub readAttachment {</td></tr>
<tr><td class="h">590</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L590">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $user, $web, $topic, $attachment, $theRev ) = @_;</td></tr>
<tr><td class="h">591</td><td colspan="6"></td></tr><tr><td class="h">592</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">593</td><td colspan="6"></td></tr><tr><td class="h">594</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L594">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L594">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">595</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">596</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;view&#39;, $user, undef, undef, $topic, $web )) {</td></tr>
<tr><td class="h">597</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException(</td></tr>
<tr><td class="h">598</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;VIEW&#39;, $user, $web, $topic,</td></tr>
<tr><td class="h">599</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">600</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">601</td><td colspan="6"></td></tr><tr><td class="h">602</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic, $attachment );</td></tr>
<tr><td class="h">603</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;getRevision( $theRev );</td></tr>
<tr><td class="h">604</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">605</td><td colspan="6"></td></tr><tr><td class="h">606 - 615</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getRevisionNumber ( $web, $topic, $attachment  ) -&gt; $integer

Get the revision number of the most recent revision. Returns
the integer revision number or &#39;&#39; if the topic doesn&#39;t exist.

WORKS FOR ATTACHMENTS AS WELL AS TOPICS

=cut</pre></td></tr>
<tr><td class="h">616</td><td colspan="6"></td></tr><tr><td class="h">617</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getRevisionNumber {</td></tr>
<tr><td class="h">618</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L618">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic, $attachment ) = @_;</td></tr>
<tr><td class="h">619</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">620</td><td colspan="6"></td></tr><tr><td class="h">621</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L621">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$attachment = &#39;&#39; unless $attachment;</td></tr>
<tr><td class="h">622</td><td colspan="6"></td></tr><tr><td class="h">623</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic, $attachment );</td></tr>
<tr><td class="h">624</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;numRevisions();</td></tr>
<tr><td class="h">625</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">626</td><td colspan="6"></td></tr><tr><td class="h">627 - 634</td><td colspan="5"></td><td class="s"><pre>=pod

---+++ ObjectMethod getWorkArea( $key ) -&gt; $directorypath

Gets a private directory uniquely identified by $key. The directory is
intended as a work area for plugins. The directory will exist.

=cut</pre></td></tr>
<tr><td class="h">635</td><td colspan="6"></td></tr><tr><td class="h">636</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getWorkArea {</td></tr>
<tr><td class="h">637</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L637">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $key ) = @_;</td></tr>
<tr><td class="h">638</td><td colspan="6"></td></tr><tr><td class="h">639</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( );</td></tr>
<tr><td class="h">640</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;getWorkArea( $key );</td></tr>
<tr><td class="h">641</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">642</td><td colspan="6"></td></tr><tr><td class="h">643 - 655</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getRevisionDiff ( $user, $web, $topic, $rev1, $rev2, $contextLines  ) -&gt; \@diffArray

Return reference to an array of [ diffType, $right, $left ]
   * =$user= - the user object, or undef to suppress access control checks
   * =$web= - the web
   * =$topic= - the topic
   * =$rev1= Integer revision number
   * =$rev2= Integer revision number
   * =$contextLines= - number of lines of context required

=cut</pre></td></tr>
<tr><td class="h">656</td><td colspan="6"></td></tr><tr><td class="h">657</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getRevisionDiff {</td></tr>
<tr><td class="h">658</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L658">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $user, $web, $topic, $rev1, $rev2, $contextLines ) = @_;</td></tr>
<tr><td class="h">659</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">660</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(defined($contextLines)) if DEBUG;</td></tr>
<tr><td class="h">661</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L661">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $user ) {</td></tr>
<tr><td class="h">662</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r1;</td></tr>
<tr><td class="h">663</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">664</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Make sure both revs are readable.</td></tr>
<tr><td class="h">665</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L665">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r1 = $this-&gt;readTopicRaw( $user, $web, $topic, $rev1 );</td></tr>
<tr><td class="h">666</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch TWiki::AccessControlException with {</td></tr>
<tr><td class="h">667</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L667">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r1 = undef;</td></tr>
<tr><td class="h">668</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">669</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r2;</td></tr>
<tr><td class="h">670</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">671</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L671">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r2 = $this-&gt;readTopicRaw( $user, $web, $topic, $rev2 );</td></tr>
<tr><td class="h">672</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch TWiki::AccessControlException with {</td></tr>
<tr><td class="h">673</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L673">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r2 = undef;</td></tr>
<tr><td class="h">674</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">675</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rd;</td></tr>
<tr><td class="h">676</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L676">0</a></div><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L676">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( !defined( $r1 )) {</td></tr>
<tr><td class="h">677</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rd = [[ &#39;-&#39;, &quot; *Revision $rev1 is unreadable* &quot;, &#39;&#39; ]];</td></tr>
<tr><td class="h">678</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L678">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( !defined( $r2 )) {</td></tr>
<tr><td class="h">679</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push( @$rd, [ &#39;+&#39;, &#39;&#39;, &quot; *Revision $rev2 is unreadable* &quot; ] );</td></tr>
<tr><td class="h">680</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">681</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( split( /\r?\n/, $r2 )) {</td></tr>
<tr><td class="h">682</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push( @$rd, [ &#39;+&#39;, &#39;&#39;, $_ ] );</td></tr>
<tr><td class="h">683</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">684</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">685</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif( !defined( $r2 )) {</td></tr>
<tr><td class="h">686</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rd = [[ &#39;+&#39;, &#39;&#39;, &quot; *Revision $rev2 is unreadable* &quot; ]];</td></tr>
<tr><td class="h">687</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( split( /\r?\n/, $r1 )) {</td></tr>
<tr><td class="h">688</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push( @$rd, [ &#39;-&#39;, $_, &#39;&#39; ] );</td></tr>
<tr><td class="h">689</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">690</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">691</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L691">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $rd if $rd;</td></tr>
<tr><td class="h">692</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">693</td><td colspan="6"></td></tr><tr><td class="h">694</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rcs = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">695</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rcs-&gt;revisionDiff( $rev1, $rev2, $contextLines );</td></tr>
<tr><td class="h">696</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">697</td><td colspan="6"></td></tr><tr><td class="h">698 - 721</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getRevisionInfo($web, $topic, $rev, $attachment) -&gt; ( $date, $user, $rev, $comment )

Get revision info of a topic.
   * =$web= Web name, optional, e.g. =&#39;Main&#39;=
   * =$topic= Topic name, required, e.g. =&#39;TokyoOffice&#39;=
   * =$rev= revision number. If 0, undef, or out-of-range, will get info about the most recent revision.
   * =$attachment= attachment filename; undef for a topic
Return list with: ( last update date, last user object, =
| $date | in epochSec |
| $user | user *object* |
| $rev | the revision number |
| $comment | WHAT COMMENT? |
e.g. =( 1234561, &#39;phoeny&#39;, 5, &#39;no comment&#39; )

NOTE NOTE NOTE if you are working within the TWiki code DO NOT USE THIS
FUNCTION FOR GETTING REVISION INFO OF TOPICS - use
TWiki::Meta::getRevisionInfo instead. This is essential to allow clean
transition to a topic object model later, and avoids the risk of confusion
coming from meta and Store revision information being out of step.
(it&#39;s OK to use it for attachments)

=cut</pre></td></tr>
<tr><td class="h">722</td><td colspan="6"></td></tr><tr><td class="h">723</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getRevisionInfo {</td></tr>
<tr><td class="h">724</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L724">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic, $rev, $attachment ) = @_;</td></tr>
<tr><td class="h">725</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">726</td><td colspan="6"></td></tr><tr><td class="h">727</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L727">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rev ||= 0;</td></tr>
<tr><td class="h">728</td><td colspan="6"></td></tr><tr><td class="h">729</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler =</td></tr>
<tr><td class="h">730</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getHandler( $web, $topic, $attachment );</td></tr>
<tr><td class="h">731</td><td colspan="6"></td></tr><tr><td class="h">732</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $rrev, $date, $user, $comment ) =</td></tr>
<tr><td class="h">733</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;getRevisionInfo( $rev );</td></tr>
<tr><td class="h">734</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rev = $rrev;</td></tr>
<tr><td class="h">735</td><td colspan="6"></td></tr><tr><td class="h">736</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L736">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$user = $this-&gt;{session}-&gt;{users}-&gt;findUser( $user ) if $user;</td></tr>
<tr><td class="h">737</td><td colspan="6"></td></tr><tr><td class="h">738</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ( $date, $user, $rev, $comment );</td></tr>
<tr><td class="h">739</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">740</td><td colspan="6"></td></tr><tr><td class="h">741 - 755</td><td colspan="5"></td><td class="s"><pre>=pod

---++ StaticMethod dataEncode( $uncoded ) -&gt; $coded

Encode meta-data fields, escaping out selected characters. The encoding
is chosen to avoid problems with parsing the attribute values, while
minimising the number of characters encoded so searches can still work
(fairly) sensibly.

The encoding has to be exported because TWiki (and plugins) use
encoded field data in other places e.g. RDiff, mainly as a shorthand
for the properly parsed meta object. Some day we may be able to
eliminate that....

=cut</pre></td></tr>
<tr><td class="h">756</td><td colspan="6"></td></tr><tr><td class="h">757</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub dataEncode {</td></tr>
<tr><td class="h">758</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L758">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $datum = shift;</td></tr>
<tr><td class="h">759</td><td colspan="6"></td></tr><tr><td class="h">760</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$datum =~ s/([%&quot;\r\n{}])/&#39;%&#39;.sprintf(&#39;%02x&#39;,ord($1))/ge;</td></tr>
<tr><td class="h">761</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $datum;</td></tr>
<tr><td class="h">762</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">763</td><td colspan="6"></td></tr><tr><td class="h">764 - 775</td><td colspan="5"></td><td class="s"><pre>=pod

---++ StaticMethod dataDecode( $encoded ) -&gt; $decoded

Decode escapes in a string that was encoded using dataEncode

The encoding has to be exported because TWiki (and plugins) use
encoded field data in other places e.g. RDiff, mainly as a shorthand
for the properly parsed meta object. Some day we may be able to
eliminate that....

=cut</pre></td></tr>
<tr><td class="h">776</td><td colspan="6"></td></tr><tr><td class="h">777</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub dataDecode {</td></tr>
<tr><td class="h">778</td><td><div class="c3">421</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L778">421</a></div></td><td><div>1206</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $datum = shift;</td></tr>
<tr><td class="h">779</td><td colspan="6"></td></tr><tr><td class="h">780</td><td><div class="c3">421</div><div class="c3">2</div></td><td></td><td></td><td></td><td><div>1121</div><div>11</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$datum =~ s/%([\da-f]{2})/chr(hex($1))/gei;</td></tr>
<tr><td class="h">781</td><td><div class="c3">421</div></td><td></td><td></td><td></td><td><div>1512</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $datum;</td></tr>
<tr><td class="h">782</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">783</td><td colspan="6"></td></tr><tr><td class="h">784</td><td></td><td></td><td></td><td></td><td></td><td class="s"># STATIC Build a hash by parsing name=value comma separated pairs</td></tr>
<tr><td class="h">785</td><td></td><td></td><td></td><td></td><td></td><td class="s"># SMELL: duplication of TWiki::Attrs, using a different</td></tr>
<tr><td class="h">786</td><td></td><td></td><td></td><td></td><td></td><td class="s"># system of escapes :-(</td></tr>
<tr><td class="h">787</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _readKeyValues {</td></tr>
<tr><td class="h">788</td><td><div class="c3">159</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L788">159</a></div></td><td><div>768</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $args, $format ) = @_;</td></tr>
<tr><td class="h">789</td><td><div class="c3">159</div></td><td></td><td></td><td></td><td><div>516</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">790</td><td colspan="6"></td></tr><tr><td class="h">791</td><td><div class="c3">159</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L791">100</a></div></td><td></td><td></td><td><div>772</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$format =~ s/[^\d\.]+//g if $format;</td></tr>
<tr><td class="h">792</td><td><div class="c3">159</div></td><td></td><td><div class="c1"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L792">75</a></div></td><td></td><td><div>2098</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $oldStyle = ( !$format || $format =~ /[^\d.]/ || $format &lt; 1.1 );</td></tr>
<tr><td class="h">793</td><td colspan="6"></td></tr><tr><td class="h">794</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Format of data is name=&#39;value&#39; name1=&#39;value1&#39; [...]</td></tr>
<tr><td class="h">795</td><td><div class="c3">159</div><div class="c3">1009</div></td><td></td><td></td><td></td><td><div>930</div><div>3740</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$args =~ s/\s*([^=]+)=&quot;([^&quot;]*)&quot;/_singleKey($1,$2,$res,$oldStyle)/ge;</td></tr>
<tr><td class="h">796</td><td colspan="6"></td></tr><tr><td class="h">797</td><td><div class="c3">159</div></td><td></td><td></td><td></td><td><div>859</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">798</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">799</td><td colspan="6"></td></tr><tr><td class="h">800</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _singleKey {</td></tr>
<tr><td class="h">801</td><td><div class="c3">1009</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L801">1009</a></div></td><td><div>4316</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $key, $value, $res, $oldStyle ) = @_;</td></tr>
<tr><td class="h">802</td><td colspan="6"></td></tr><tr><td class="h">803</td><td><div class="c3">1009</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L803">100</a></div></td><td></td><td></td><td><div>3584</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $oldStyle ) {</td></tr>
<tr><td class="h">804</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Old decoding retained for backward compatibility</td></tr>
<tr><td class="h">805</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# (this encoding is badly broken)</td></tr>
<tr><td class="h">806</td><td><div class="c3">588</div></td><td></td><td></td><td></td><td><div>1608</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value =~ s/%_N_%/\n/g;</td></tr>
<tr><td class="h">807</td><td><div class="c3">588</div></td><td></td><td></td><td></td><td><div>1795</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value =~ s/%_Q_%/\&quot;/g;</td></tr>
<tr><td class="h">808</td><td><div class="c3">588</div></td><td></td><td></td><td></td><td><div>1679</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value =~ s/%_P_%/%/g;</td></tr>
<tr><td class="h">809</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">810</td><td><div class="c3">421</div></td><td></td><td></td><td></td><td><div>1374</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = dataDecode( $value );</td></tr>
<tr><td class="h">811</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">812</td><td colspan="6"></td></tr><tr><td class="h">813</td><td><div class="c3">1009</div></td><td></td><td></td><td></td><td><div>3631</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{$key} = $value;</td></tr>
<tr><td class="h">814</td><td colspan="6"></td></tr><tr><td class="h">815</td><td><div class="c3">1009</div></td><td></td><td></td><td></td><td><div>4853</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</td></tr>
<tr><td class="h">816</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">817</td><td colspan="6"></td></tr><tr><td class="h">818 - 840</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod saveTopic( $user, $web, $topic, $text, $meta, $options  )

   * =$user= - user doing the saving (object)
   * =$web= - web for topic
   * =$topic= - topic to atach to
   * =$text= - topic text
   * =$meta= - topic meta-data
   * =$options= - Ref to hash of options
=$options= may include:
| =dontlog= | don&#39;t log this change in twiki log |
| =hide= | if the attachment is to be hidden in normal topic view |
| =comment= | comment for save |
| =file= | Temporary file name to upload |
| =minor= | True if this is a minor change (used in log) |
| =savecmd= | Save command |
| =forcedate= | grr |
| =unlock= | |

Save a new revision of the topic, calling plugins handlers as appropriate.

=cut</pre></td></tr>
<tr><td class="h">841</td><td colspan="6"></td></tr><tr><td class="h">842</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub saveTopic {</td></tr>
<tr><td class="h">843</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L843">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $user, $web, $topic, $text, $meta, $options ) = @_;</td></tr>
<tr><td class="h">844</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">845</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">846</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">847</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$meta = $this-&gt;_removeAutoAttachmentsFromMeta($meta);</td></tr>
<tr><td class="h">848</td><td colspan="6"></td></tr><tr><td class="h">849</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L849">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$options = {} unless defined( $options );</td></tr>
<tr><td class="h">850</td><td colspan="6"></td></tr><tr><td class="h">851</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L851">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L851">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">852</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">853</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;change&#39;, $user, undef, undef, $topic, $web )) {</td></tr>
<tr><td class="h">854</td><td colspan="6"></td></tr><tr><td class="h">855</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException(</td></tr>
<tr><td class="h">856</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;CHANGE&#39;, $user, $web, $topic,</td></tr>
<tr><td class="h">857</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">858</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">859</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $plugins = $this-&gt;{session}-&gt;{plugins};</td></tr>
<tr><td class="h">860</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Semantics inherited from Cairo. See</td></tr>
<tr><td class="h">861</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TWiki:Codev.BugBeforeSaveHandlerBroken</td></tr>
<tr><td class="h">862</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L862">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $plugins-&gt;haveHandlerFor( &#39;beforeSaveHandler&#39; )) {</td></tr>
<tr><td class="h">863</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $before = &#39;&#39;;</td></tr>
<tr><td class="h">864</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L864">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $meta ) {</td></tr>
<tr><td class="h">865</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# write the meta into the topic text. Nasty compatibility</td></tr>
<tr><td class="h">866</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# requirement.</td></tr>
<tr><td class="h">867</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = _writeMeta( $meta, $text );</td></tr>
<tr><td class="h">868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$before = $meta-&gt;stringify();</td></tr>
<tr><td class="h">869</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">870</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$plugins-&gt;beforeSaveHandler( $text, $topic, $web, $meta );</td></tr>
<tr><td class="h">871</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# remove meta again</td></tr>
<tr><td class="h">872</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $after = new TWiki::Meta( $this-&gt;{session}, $web, $topic);</td></tr>
<tr><td class="h">873</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;extractMetaData( $after, \$text );</td></tr>
<tr><td class="h">874</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If there are no changes in the $meta object, take the meta</td></tr>
<tr><td class="h">875</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# from the text. Nasty compatibility requirement.</td></tr>
<tr><td class="h">876</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L876">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L876">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( !$meta || $meta-&gt;stringify() eq $before ){</td></tr>
<tr><td class="h">877</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta = $after;</td></tr>
<tr><td class="h">878</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">879</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">880</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $error;</td></tr>
<tr><td class="h">881</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">882</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L882">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_noHandlersSave( $user, $web, $topic, $text, $meta, $options );</td></tr>
<tr><td class="h">883</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} catch Error::Simple with {</td></tr>
<tr><td class="h">884</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L884">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error = shift;</td></tr>
<tr><td class="h">885</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">886</td><td colspan="6"></td></tr><tr><td class="h">887</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Semantics inherited from Cairo. See</td></tr>
<tr><td class="h">888</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TWiki:Codev.BugBeforeSaveHandlerBroken</td></tr>
<tr><td class="h">889</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L889">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $plugins-&gt;haveHandlerFor( &#39;afterSaveHandler&#39; )) {</td></tr>
<tr><td class="h">890</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L890">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $meta ) {</td></tr>
<tr><td class="h">891</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = _writeMeta( $meta, $text );</td></tr>
<tr><td class="h">892</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">893</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L893">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$plugins-&gt;afterSaveHandler( $text, $topic, $web,</td></tr>
<tr><td class="h">894</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error?$error-&gt;{-text}:&#39;&#39;, $meta );</td></tr>
<tr><td class="h">895</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">896</td><td colspan="6"></td></tr><tr><td class="h">897</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L897">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;throw $error if $error;</td></tr>
<tr><td class="h">898</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">899</td><td colspan="6"></td></tr><tr><td class="h">900 - 924</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod saveAttachment ($web, $topic, $attachment, $user, $opts )

   * =$user= - user doing the saving
   * =$web= - web for topic
   * =$topic= - topic to atach to
   * =$attachment= - name of the attachment
   * =$opts= - Ref to hash of options
=$opts= may include:
| =dontlog= | don&#39;t log this change in twiki log |
| =comment= | comment for save |
| =hide= | if the attachment is to be hidden in normal topic view |
| =stream= | Stream of file to upload |
| =file= | Name of a file to use for the attachment data. ignored is stream is set. |
| =filepath= | Client path to file |
| =filesize= | Size of uploaded data |
| =filedate= | Date |

Saves a new revision of the attachment, invoking plugin handlers as
appropriate.

If file is not set, this is a properties-only save.

=cut</pre></td></tr>
<tr><td class="h">925</td><td colspan="6"></td></tr><tr><td class="h">926</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub saveAttachment {</td></tr>
<tr><td class="h">927</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L927">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic, $attachment, $user, $opts ) = @_;</td></tr>
<tr><td class="h">928</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">929</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(defined($opts)) if DEBUG;</td></tr>
<tr><td class="h">931</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $action;</td></tr>
<tr><td class="h">932</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $plugins = $this-&gt;{session}-&gt;{plugins};</td></tr>
<tr><td class="h">933</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $attrs;</td></tr>
<tr><td class="h">934</td><td colspan="6"></td></tr><tr><td class="h">935</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;lockTopic( $user, $web, $topic );</td></tr>
<tr><td class="h">936</td><td colspan="6"></td></tr><tr><td class="h">937</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">938</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# update topic</td></tr>
<tr><td class="h">939</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L939">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L939">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my( $meta, $text ) = $this-&gt;readTopic( undef, $web, $topic, undef );</td></tr>
<tr><td class="h">940</td><td colspan="6"></td></tr><tr><td class="h">941</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L941">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L941">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $user &amp;&amp;</td></tr>
<tr><td class="h">942</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$this-&gt;{session}-&gt;{security}-&gt;checkAccessPermission</td></tr>
<tr><td class="h">943</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( &#39;change&#39;, $user, $text, $meta, $topic, $web )) {</td></tr>
<tr><td class="h">944</td><td colspan="6"></td></tr><tr><td class="h">945</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw TWiki::AccessControlException(</td></tr>
<tr><td class="h">946</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;CHANGE&#39;, $user, $web, $topic,</td></tr>
<tr><td class="h">947</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{security}-&gt;getReason());</td></tr>
<tr><td class="h">948</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">949</td><td colspan="6"></td></tr><tr><td class="h">950</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L950">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L950">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $opts-&gt;{file} &amp;&amp; !$opts-&gt;{stream} ) {</td></tr>
<tr><td class="h">951</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L951">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;open($opts-&gt;{stream}, &quot;&lt;$opts-&gt;{file}&quot;) ||</td></tr>
<tr><td class="h">952</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw Error::Simple(&#39;Could not open &#39;.$opts-&gt;{file} );</td></tr>
<tr><td class="h">953</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L953">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;binmode($opts-&gt;{stream}) ||</td></tr>
<tr><td class="h">954</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw Error::Simple( $opts-&gt;{file}.&#39; binmode failed: &#39;.$! );</td></tr>
<tr><td class="h">955</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">956</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L956">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $opts-&gt;{stream} ) {</td></tr>
<tr><td class="h">957</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$action = &#39;upload&#39;;</td></tr>
<tr><td class="h">958</td><td colspan="6"></td></tr><tr><td class="h">959</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs = {</td></tr>
<tr><td class="h">960</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attachment =&gt; $attachment,</td></tr>
<tr><td class="h">961</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream =&gt; $opts-&gt;{stream},</td></tr>
<tr><td class="h">962</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user =&gt; $user-&gt;webDotWikiName()</td></tr>
<tr><td class="h">963</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">964</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L964">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{comment} = $opts-&gt;{comment}</td></tr>
<tr><td class="h">965</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined($opts-&gt;{comment}));</td></tr>
<tr><td class="h">966</td><td colspan="6"></td></tr><tr><td class="h">967</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic, $attachment );</td></tr>
<tr><td class="h">968</td><td colspan="6"></td></tr><tr><td class="h">969</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tmpFile;</td></tr>
<tr><td class="h">970</td><td colspan="6"></td></tr><tr><td class="h">971</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L971">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $plugins-&gt;haveHandlerFor( &#39;beforeAttachmentSaveHandler&#39; )) {</td></tr>
<tr><td class="h">972</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: legacy spec of beforeAttachmentSaveHandler requires</td></tr>
<tr><td class="h">973</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# a local copy of the stream. This could be a problem for</td></tr>
<tr><td class="h">974</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# very big data files.</td></tr>
<tr><td class="h">975</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L975">1</a></div></td><td><div>9</div><div>3</div><div>12</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;use File::Temp;</td></tr>
<tr><td class="h">976</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fh;</td></tr>
<tr><td class="h">977</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Note: do *not* rely on UNLINK =&gt; 1, because in a mod_perl</td></tr>
<tr><td class="h">978</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# context the destructor may not be called for a *long* time.</td></tr>
<tr><td class="h">979</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Call tempfile in a list context so that file does not get</td></tr>
<tr><td class="h">980</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# deleted when closed.</td></tr>
<tr><td class="h">981</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $fh, $tmpFile ) = File::Temp::tempfile();</td></tr>
<tr><td class="h">982</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;binmode( $fh );</td></tr>
<tr><td class="h">983</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# transfer 512KB blocks</td></tr>
<tr><td class="h">984</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $transfer;</td></tr>
<tr><td class="h">985</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r;</td></tr>
<tr><td class="h">986</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while( $r = sysread( $opts-&gt;{stream}, $transfer, 0x80000 )) {</td></tr>
<tr><td class="h">987</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;syswrite( $fh, $transfer, $r );</td></tr>
<tr><td class="h">988</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">989</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close( $fh );</td></tr>
<tr><td class="h">990</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{tmpFilename} = $tmpFile;</td></tr>
<tr><td class="h">991</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$plugins-&gt;beforeAttachmentSaveHandler( $attrs, $topic, $web );</td></tr>
<tr><td class="h">992</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;open( $opts-&gt;{stream}, &quot;&lt;$tmpFile&quot; );</td></tr>
<tr><td class="h">993</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;binmode( $opts-&gt;{stream} );</td></tr>
<tr><td class="h">994</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">995</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $error;</td></tr>
<tr><td class="h">996</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">997</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;addRevisionFromStream( $opts-&gt;{stream},</td></tr>
<tr><td class="h">998</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{comment},</td></tr>
<tr><td class="h">999</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user-&gt;wikiName() );</td></tr>
<tr><td class="h">1000</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch Error::Simple with {</td></tr>
<tr><td class="h">1001</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error = shift;</td></tr>
<tr><td class="h">1002</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1003</td><td colspan="6"></td></tr><tr><td class="h">1004</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1004">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1004">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unlink( $tmpFile ) if( $tmpFile &amp;&amp; -e $tmpFile );</td></tr>
<tr><td class="h">1005</td><td colspan="6"></td></tr><tr><td class="h">1006</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1006">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $plugins-&gt;haveHandlerFor( &#39;afterAttachmentSaveHandler&#39; )) {</td></tr>
<tr><td class="h">1007</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1007">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$plugins-&gt;afterAttachmentSaveHandler( $attrs, $topic, $web,</td></tr>
<tr><td class="h">1008</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error ? </td></tr>
<tr><td class="h">1009</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error-&gt;{-text} : &#39;&#39; );</td></tr>
<tr><td class="h">1010</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1011</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1011">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw $error if $error;</td></tr>
<tr><td class="h">1012</td><td colspan="6"></td></tr><tr><td class="h">1013</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1013">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{name} ||= $attachment;</td></tr>
<tr><td class="h">1014</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fileVersion = $this-&gt;getRevisionNumber( $web, $topic,</td></tr>
<tr><td class="h">1015</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attachment );</td></tr>
<tr><td class="h">1016</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{version} = $fileVersion;</td></tr>
<tr><td class="h">1017</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1017">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{path} = $opts-&gt;{filepath} if (defined($opts-&gt;{filepath}));</td></tr>
<tr><td class="h">1018</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1018">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{size} = $opts-&gt;{filesize} if (defined($opts-&gt;{filesize}));</td></tr>
<tr><td class="h">1019</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1019">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{date} = $opts-&gt;{filedate} if (defined($opts-&gt;{filedate}));</td></tr>
<tr><td class="h">1020</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1020">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{attr} = ( $opts-&gt;{hide} ) ? &#39;h&#39; : &#39;&#39;;</td></tr>
<tr><td class="h">1021</td><td colspan="6"></td></tr><tr><td class="h">1022</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta-&gt;putKeyed( &#39;FILEATTACHMENT&#39;, $attrs );</td></tr>
<tr><td class="h">1023</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1024</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$action = &#39;save&#39;;</td></tr>
<tr><td class="h">1025</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs = $meta-&gt;get( &#39;FILEATTACHMENT&#39;, $attachment );</td></tr>
<tr><td class="h">1026</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{name} = $attachment;</td></tr>
<tr><td class="h">1027</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1027">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{attr} = ( $opts-&gt;{hide} ) ? &#39;h&#39; : &#39;&#39;;</td></tr>
<tr><td class="h">1028</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1028">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attrs-&gt;{comment} = $opts-&gt;{comment} if (defined($opts-&gt;{comment}));</td></tr>
<tr><td class="h">1029</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta-&gt;putKeyed( &#39;FILEATTACHMENT&#39;, $attrs );</td></tr>
<tr><td class="h">1030</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1031</td><td colspan="6"></td></tr><tr><td class="h">1032</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1032">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $opts-&gt;{createlink} ) {</td></tr>
<tr><td class="h">1033</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text .= $this-&gt;{session}-&gt;{attach}-&gt;getAttachmentLink(</td></tr>
<tr><td class="h">1034</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user, $web, $topic, $attachment, $meta );</td></tr>
<tr><td class="h">1035</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1036</td><td colspan="6"></td></tr><tr><td class="h">1037</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;saveTopic( $user, $web, $topic, $text, $meta, {} );</td></tr>
<tr><td class="h">1038</td><td colspan="6"></td></tr><tr><td class="h">1039</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} finally {</td></tr>
<tr><td class="h">1040</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1040">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unlockTopic( $user, $web, $topic );</td></tr>
<tr><td class="h">1041</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1042</td><td colspan="6"></td></tr><tr><td class="h">1043</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1043">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1043">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( ( ! $opts-&gt;{dontlog} ) &amp;&amp; ( $TWiki::cfg{Log}{$action} ) ) {</td></tr>
<tr><td class="h">1044</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeLog( $action, $web.&#39;.&#39;.$topic, $attachment, $user );</td></tr>
<tr><td class="h">1045</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1046</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1047</td><td colspan="6"></td></tr><tr><td class="h">1048</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Save a topic or attachment _without_ invoking plugin handlers.</td></tr>
<tr><td class="h">1049</td><td></td><td></td><td></td><td></td><td></td><td class="s"># FIXME: does rev info from meta work if user saves a topic with no change?</td></tr>
<tr><td class="h">1050</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _noHandlersSave {</td></tr>
<tr><td class="h">1051</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1051">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $user, $web, $topic, $text, $meta, $options ) = @_;</td></tr>
<tr><td class="h">1052</td><td colspan="6"></td></tr><tr><td class="h">1053</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1054</td><td colspan="6"></td></tr><tr><td class="h">1055</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1055">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$meta ||= new TWiki::Meta( $this-&gt;{session}, $web, $topic );</td></tr>
<tr><td class="h">1056</td><td colspan="6"></td></tr><tr><td class="h">1057</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">1058</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1058">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $currentRev = $handler-&gt;numRevisions() || 0;</td></tr>
<tr><td class="h">1059</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $nextRev = $currentRev + 1;</td></tr>
<tr><td class="h">1060</td><td colspan="6"></td></tr><tr><td class="h">1061</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1061">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1061">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $currentRev &amp;&amp; !$options-&gt;{forcenewrevision} ) {</td></tr>
<tr><td class="h">1062</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# See if we want to replace the existing top revision</td></tr>
<tr><td class="h">1063</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mtime1 = $handler-&gt;getTimestamp();</td></tr>
<tr><td class="h">1064</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mtime2 = time();</td></tr>
<tr><td class="h">1065</td><td colspan="6"></td></tr><tr><td class="h">1066</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1066">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( abs( $mtime2 - $mtime1 ) &lt;</td></tr>
<tr><td class="h">1067</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TWiki::cfg{ReplaceIfEditedAgainWithin} ) {</td></tr>
<tr><td class="h">1068</td><td colspan="6"></td></tr><tr><td class="h">1069</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my( $rev, $date, $revuser, $comment ) =</td></tr>
<tr><td class="h">1070</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;getRevisionInfo( $currentRev );</td></tr>
<tr><td class="h">1071</td><td colspan="6"></td></tr><tr><td class="h">1072</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# same user?</td></tr>
<tr><td class="h">1073</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1073">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(  $revuser eq $user-&gt;wikiName() ) {</td></tr>
<tr><td class="h">1074</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;repRev( $user, $web, $topic, $text,</td></tr>
<tr><td class="h">1075</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta, $options );</td></tr>
<tr><td class="h">1076</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">1077</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1078</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1079</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1080</td><td colspan="6"></td></tr><tr><td class="h">1081</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1081">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $meta ) {</td></tr>
<tr><td class="h">1082</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addTOPICINFO( $meta, $nextRev, time(), $user, 0 );</td></tr>
<tr><td class="h">1083</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = _writeMeta( $meta, $text );</td></tr>
<tr><td class="h">1084</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1085</td><td colspan="6"></td></tr><tr><td class="h">1086</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# will block</td></tr>
<tr><td class="h">1087</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;lockTopic( $user, $web, $topic );</td></tr>
<tr><td class="h">1088</td><td colspan="6"></td></tr><tr><td class="h">1089</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">1090</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1090">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;addRevisionFromText( $text, $options-&gt;{comment},</td></tr>
<tr><td class="h">1091</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user-&gt;wikiName() );</td></tr>
<tr><td class="h">1092</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# just in case they are not sequential</td></tr>
<tr><td class="h">1093</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nextRev = $handler-&gt;numRevisions();</td></tr>
<tr><td class="h">1094</td><td colspan="6"></td></tr><tr><td class="h">1095</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1095">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $extra = $options-&gt;{minor} ? &#39;minor&#39; : &#39;&#39;;</td></tr>
<tr><td class="h">1096</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_recordChange( $web, $topic, $user, $nextRev, $extra );</td></tr>
<tr><td class="h">1097</td><td colspan="6"></td></tr><tr><td class="h">1098</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1098">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1098">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( ( $TWiki::cfg{Log}{save} ) &amp;&amp; ! ( $options-&gt;{dontlog} ) ) {</td></tr>
<tr><td class="h">1099</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeLog( &#39;save&#39;, $web.&#39;.&#39;.$topic,</td></tr>
<tr><td class="h">1100</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extra, $user );</td></tr>
<tr><td class="h">1101</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1102</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} finally {</td></tr>
<tr><td class="h">1103</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1103">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unlockTopic( $user, $web, $topic );</td></tr>
<tr><td class="h">1104</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1105</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1106</td><td colspan="6"></td></tr><tr><td class="h">1107 - 1126</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod repRev( $user, $web, $topic, $text, $meta, $options )

Replace last (top) revision with different text.

Parameters and return value as saveTopic, except
   * =$options= - as for saveTopic, with the extra option:
      * =timetravel= - if we want to force the deposited revision to look as much like the revision specified in =$rev= as possible.
      * =operation= - set to the name of the operation performing the save. This is used only in the log, and is normally =cmd= or =save=. It defaults to =save=.

Used to try to avoid the deposition of &#39;unecessary&#39; revisions, for example
where a user quickly goes back and fixes a spelling error.

Also provided as a means for administrators to rewrite history (timetravel).

It is up to the store implementation if this is different
to a normal save or not.

=cut</pre></td></tr>
<tr><td class="h">1127</td><td colspan="6"></td></tr><tr><td class="h">1128</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub repRev {</td></tr>
<tr><td class="h">1129</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1129">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $user, $web, $topic, $text, $meta, $options ) = @_;</td></tr>
<tr><td class="h">1130</td><td colspan="6"></td></tr><tr><td class="h">1131</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($meta &amp;&amp; $meta-&gt;isa(&#39;TWiki::Meta&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1132</td><td colspan="6"></td></tr><tr><td class="h">1133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $revdate, $revuser, $rev ) = $meta-&gt;getRevisionInfo();</td></tr>
<tr><td class="h">1134</td><td colspan="6"></td></tr><tr><td class="h">1135</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# RCS requires a newline for the last line,</td></tr>
<tr><td class="h">1136</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1136">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text .= &quot;\n&quot; unless $text =~ /\n$/s;</td></tr>
<tr><td class="h">1137</td><td colspan="6"></td></tr><tr><td class="h">1138</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1138">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $options-&gt;{timetravel} ) {</td></tr>
<tr><td class="h">1139</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We are trying to force the rev to be saved with the same date</td></tr>
<tr><td class="h">1140</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# and user as the prior rev. However, exactly the same date may</td></tr>
<tr><td class="h">1141</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# cause some revision control systems to barf, so to avoid this we</td></tr>
<tr><td class="h">1142</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# add 1 minute to the rev time. Note that this mode of operation</td></tr>
<tr><td class="h">1143</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# will normally require sysadmin privilege, as it can result in</td></tr>
<tr><td class="h">1144</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# confused rev dates if abused.</td></tr>
<tr><td class="h">1145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$revdate += 60;</td></tr>
<tr><td class="h">1146</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1147</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# use defaults (current time, current user)</td></tr>
<tr><td class="h">1148</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$revdate = time();</td></tr>
<tr><td class="h">1149</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$revuser = $user;</td></tr>
<tr><td class="h">1150</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1151</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;addTOPICINFO( $meta, $rev, $revdate, $revuser, 1 );</td></tr>
<tr><td class="h">1152</td><td colspan="6"></td></tr><tr><td class="h">1153</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text = _writeMeta( $meta, $text );</td></tr>
<tr><td class="h">1154</td><td colspan="6"></td></tr><tr><td class="h">1155</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;lockTopic( $user, $web, $topic );</td></tr>
<tr><td class="h">1156</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">1157</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1157">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">1158</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;replaceRevision( $text, $options-&gt;{comment},</td></tr>
<tr><td class="h">1159</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$revuser-&gt;wikiName(), $revdate );</td></tr>
<tr><td class="h">1160</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} finally {</td></tr>
<tr><td class="h">1161</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1161">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unlockTopic( $user, $web, $topic );</td></tr>
<tr><td class="h">1162</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1163</td><td colspan="6"></td></tr><tr><td class="h">1164</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1164">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1164">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( ( $TWiki::cfg{Log}{save} ) &amp;&amp; ! ( $options-&gt;{dontlog} ) ) {</td></tr>
<tr><td class="h">1165</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# write log entry</td></tr>
<tr><td class="h">1166</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $extra = &quot;repRev $rev by &quot; . $revuser-&gt;login() .</td></tr>
<tr><td class="h">1167</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39; &#39;. TWiki::Time::formatTime( $revdate, &#39;$rcs&#39;, &#39;gmtime&#39; );</td></tr>
<tr><td class="h">1168</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1168">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extra   .= &#39; minor&#39; if( $options-&gt;{minor} );</td></tr>
<tr><td class="h">1169</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1169">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeLog( $options-&gt;{operation} || &#39;save&#39;,</td></tr>
<tr><td class="h">1170</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$web.&#39;.&#39;.$topic, $extra, $user );</td></tr>
<tr><td class="h">1171</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1172</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1173</td><td colspan="6"></td></tr><tr><td class="h">1174 - 1189</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod delRev( $user, $web, $topic, $text, $meta, $options )

Parameters and return value as saveTopic.

Provided as a means for administrators to rewrite history.

Delete last entry in repository, restoring the previous
revision.

It is up to the store implementation whether this actually
does delete a revision or not; some implementations will
simply promote the previous revision up to the head.

=cut</pre></td></tr>
<tr><td class="h">1190</td><td colspan="6"></td></tr><tr><td class="h">1191</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delRev {</td></tr>
<tr><td class="h">1192</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1192">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $user, $web, $topic ) = @_;</td></tr>
<tr><td class="h">1193</td><td colspan="6"></td></tr><tr><td class="h">1194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rev = $this-&gt;getRevisionNumber( $web, $topic );</td></tr>
<tr><td class="h">1195</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1195">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $rev &lt;= 1 ) {</td></tr>
<tr><td class="h">1196</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw Error::Simple( &#39;Cannot delete initial revision of &#39;.</td></tr>
<tr><td class="h">1197</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$web.&#39;.&#39;.$topic );</td></tr>
<tr><td class="h">1198</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1199</td><td colspan="6"></td></tr><tr><td class="h">1200</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;lockTopic( $user, $web, $topic );</td></tr>
<tr><td class="h">1201</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;try {</td></tr>
<tr><td class="h">1202</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1202">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">1203</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;deleteRevision();</td></tr>
<tr><td class="h">1204</td><td colspan="6"></td></tr><tr><td class="h">1205</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# restore last topic from repository</td></tr>
<tr><td class="h">1206</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;restoreLatestRevision($user-&gt;{wikiname});</td></tr>
<tr><td class="h">1207</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} finally {</td></tr>
<tr><td class="h">1208</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1208">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unlockTopic( $user, $web, $topic );</td></tr>
<tr><td class="h">1209</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1210</td><td colspan="6"></td></tr><tr><td class="h">1211</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: delete entry in .changes</td></tr>
<tr><td class="h">1212</td><td colspan="6"></td></tr><tr><td class="h">1213</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# write log entry</td></tr>
<tr><td class="h">1214</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeLog( &#39;cmd&#39;, $web.&#39;.&#39;.$topic, &#39;delRev by &#39;.</td></tr>
<tr><td class="h">1215</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user-&gt;login().&quot;: $rev&quot;, $user );</td></tr>
<tr><td class="h">1216</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1217</td><td colspan="6"></td></tr><tr><td class="h">1218 - 1234</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod lockTopic( $web, $topic )

Grab a topic lock on the given topic. A topic lock will cause other
processes that also try to claim a lock to block. A lock has a
maximum lifetime of 2 minutes, so operations on a locked topic
must be completed within that time. You cannot rely on the
lock timeout clearing the lock, though; that should always
be done by calling unlockTopic. The best thing to do is to guard
the locked section with a try..finally clause. See man Error for more info.

Topic locks are used to make store operations atomic. They are
_note_ the locks used when a topic is edited; those are Leases
(see =getLease=)

=cut</pre></td></tr>
<tr><td class="h">1235</td><td colspan="6"></td></tr><tr><td class="h">1236</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub lockTopic {</td></tr>
<tr><td class="h">1237</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1237">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $locker, $web, $topic ) = @_;</td></tr>
<tr><td class="h">1238</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1239</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($locker-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1240</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($web &amp;&amp; $topic) if DEBUG;</td></tr>
<tr><td class="h">1241</td><td colspan="6"></td></tr><tr><td class="h">1242</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">1243</td><td colspan="6"></td></tr><tr><td class="h">1244</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while ( 1 ) {</td></tr>
<tr><td class="h">1245</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $user, $time ) = $handler-&gt;isLocked();</td></tr>
<tr><td class="h">1246</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1246">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1246">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if ( !$user || $locker-&gt;wikiName() eq $user );</td></tr>
<tr><td class="h">1247</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeWarning( &quot;Lock on $web.$topic for &quot;.</td></tr>
<tr><td class="h">1248</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$locker-&gt;wikiName().</td></tr>
<tr><td class="h">1249</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; denied by $user&quot; );</td></tr>
<tr><td class="h">1250</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# see how old the lock is. If it&#39;s older than 2 minutes,</td></tr>
<tr><td class="h">1251</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# break it anyway. Locks are atomic, and should never be</td></tr>
<tr><td class="h">1252</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# held that long, by _any_ process.</td></tr>
<tr><td class="h">1253</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1253">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( time() - $time &gt; 2 * 60 ) {</td></tr>
<tr><td class="h">1254</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;writeWarning</td></tr>
<tr><td class="h">1255</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $locker-&gt;wikiName().&quot; broke ${user}s lock on $web.$topic&quot; );</td></tr>
<tr><td class="h">1256</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;setLock( 0 );</td></tr>
<tr><td class="h">1257</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last;</td></tr>
<tr><td class="h">1258</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1259</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# wait a couple of seconds before trying again</td></tr>
<tr><td class="h">1260</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(2);</td></tr>
<tr><td class="h">1261</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1262</td><td colspan="6"></td></tr><tr><td class="h">1263</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;setLock( 1, $locker-&gt;wikiName() );</td></tr>
<tr><td class="h">1264</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1265</td><td colspan="6"></td></tr><tr><td class="h">1266 - 1279</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod unlockTopic( $user, $web, $topic )

Release the topic lock on the given topic. A topic lock will cause other
processes that also try to claim a lock to block. It is important to
release a topic lock after a guard section is complete. This should
normally be done in a &#39;finally&#39; block. See man Error for more info.

Topic locks are used to make store operations atomic. They are
_note_ the locks used when a topic is edited; those are Leases
(see =getLease=)

=cut</pre></td></tr>
<tr><td class="h">1280</td><td colspan="6"></td></tr><tr><td class="h">1281</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unlockTopic {</td></tr>
<tr><td class="h">1282</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1282">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $user, $web, $topic ) = @_;</td></tr>
<tr><td class="h">1283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1285</td><td colspan="6"></td></tr><tr><td class="h">1286</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">1287</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;setLock( 0, $user-&gt;wikiName() );</td></tr>
<tr><td class="h">1288</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1289</td><td colspan="6"></td></tr><tr><td class="h">1290 - 1299</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod webExists( $web ) -&gt; $boolean

Test if web exists
   * =$web= - Web name, required, e.g. =&#39;Sandbox&#39;=

A web _has_ to have a home topic to be a web.

=cut</pre></td></tr>
<tr><td class="h">1300</td><td colspan="6"></td></tr><tr><td class="h">1301</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub webExists {</td></tr>
<tr><td class="h">1302</td><td><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1302">8</a></div></td><td><div>27</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web ) = @_;</td></tr>
<tr><td class="h">1303</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td><div>20</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1304</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td><div>25</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">1305</td><td colspan="6"></td></tr><tr><td class="h">1306</td><td><div class="c3">8</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1306">50</a></div></td><td></td><td></td><td><div>38</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless defined $web;</td></tr>
<tr><td class="h">1307</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td><div>37</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $TWiki::cfg{WebPrefsTopicName} );</td></tr>
<tr><td class="h">1308</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td><div>35</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;storedDataExists();</td></tr>
<tr><td class="h">1309</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1310</td><td colspan="6"></td></tr><tr><td class="h">1311 - 1319</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod topicExists( $web, $topic ) -&gt; $boolean

Test if topic exists
   * =$web= - Web name, optional, e.g. =&#39;Main&#39;=
   * =$topic= - Topic name, required, e.g. =&#39;TokyoOffice&#39;=, or =&quot;Main.TokyoOffice&quot;=

=cut</pre></td></tr>
<tr><td class="h">1320</td><td colspan="6"></td></tr><tr><td class="h">1321</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub topicExists {</td></tr>
<tr><td class="h">1322</td><td><div class="c3">86</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1322">86</a></div></td><td><div>324</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic ) = @_;</td></tr>
<tr><td class="h">1323</td><td><div class="c3">86</div></td><td></td><td></td><td></td><td><div>300</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">1324</td><td><div class="c3">86</div></td><td></td><td></td><td></td><td><div>321</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1325</td><td><div class="c3">86</div></td><td></td><td></td><td></td><td><div>198</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(defined($topic)) if DEBUG;</td></tr>
<tr><td class="h">1326</td><td colspan="6"></td></tr><tr><td class="h">1327</td><td><div class="c3">86</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1327">50</a></div></td><td></td><td></td><td><div>413</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $topic;</td></tr>
<tr><td class="h">1328</td><td colspan="6"></td></tr><tr><td class="h">1329</td><td><div class="c3">86</div></td><td></td><td></td><td></td><td><div>351</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">1330</td><td><div class="c3">86</div></td><td></td><td></td><td></td><td><div>412</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;storedDataExists();</td></tr>
<tr><td class="h">1331</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1332</td><td colspan="6"></td></tr><tr><td class="h">1333</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Expect meta data at top of file, but willing to accept it anywhere.</td></tr>
<tr><td class="h">1334</td><td></td><td></td><td></td><td></td><td></td><td class="s"># If we have an old file format without meta data, then convert.</td></tr>
<tr><td class="h">1335</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1336</td><td></td><td></td><td></td><td></td><td></td><td class="s"># If autoattachments is on then get this from the filestore rather than meta data</td></tr>
<tr><td class="h">1337</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1338</td><td></td><td></td><td></td><td></td><td></td><td class="s"># SMELL: SIDE-EFFECTING FUNCTION meta-data is stripped from the $rtext</td></tr>
<tr><td class="h">1339</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1340</td><td></td><td></td><td></td><td></td><td></td><td class="s"># SMELL: Calls to this method from outside of Store</td></tr>
<tr><td class="h">1341</td><td></td><td></td><td></td><td></td><td></td><td class="s"># should be avoided at all costs, as it exports the assumption that</td></tr>
<tr><td class="h">1342</td><td></td><td></td><td></td><td></td><td></td><td class="s"># meta-data is embedded in text.</td></tr>
<tr><td class="h">1343</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1344</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub extractMetaData {</td></tr>
<tr><td class="h">1345</td><td><div class="c3">44</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1345">44</a></div></td><td><div>155</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $meta, $rtext ) = @_;</td></tr>
<tr><td class="h">1346</td><td><div class="c3">44</div></td><td></td><td></td><td></td><td><div>107</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1347</td><td><div class="c3">44</div></td><td></td><td></td><td></td><td><div>110</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(defined($$rtext)) if DEBUG;</td></tr>
<tr><td class="h">1348</td><td colspan="6"></td></tr><tr><td class="h">1349</td><td><div class="c3">44</div></td><td></td><td></td><td></td><td><div>141</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $format = $STORE_FORMAT_VERSION;</td></tr>
<tr><td class="h">1350</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# head meta-data</td></tr>
<tr><td class="h">1351</td><td><div class="c3">44</div><div class="c3">43</div><div class="c3">43</div></td><td></td><td></td><td></td><td><div>421</div><div>200</div><div>464</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$rtext =~ s(^%META:TOPICINFO{(.*)}%\r?\n)</td></tr>
<tr><td class="h">1352</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($meta-&gt;put( &#39;TOPICINFO&#39;, _readKeyValues( $1 ));&#39;&#39;)gem;</td></tr>
<tr><td class="h">1353</td><td colspan="6"></td></tr><tr><td class="h">1354</td><td><div class="c3">44</div></td><td></td><td></td><td></td><td><div>222</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ti = $meta-&gt;get( &#39;TOPICINFO&#39; );</td></tr>
<tr><td class="h">1355</td><td><div class="c3">44</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1355">100</a></div></td><td></td><td></td><td><div>207</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $ti ) {</td></tr>
<tr><td class="h">1356</td><td><div class="c3">43</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1356">33</a></div></td><td></td><td><div>224</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$format = $ti-&gt;{format} || $STORE_FORMAT_VERSION;</td></tr>
<tr><td class="h">1357</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Make sure we update the topic format</td></tr>
<tr><td class="h">1358</td><td><div class="c3">43</div></td><td></td><td></td><td></td><td><div>153</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ti-&gt;{format} = $STORE_FORMAT_VERSION;</td></tr>
<tr><td class="h">1359</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1360</td><td colspan="6"></td></tr><tr><td class="h">1361</td><td><div class="c3">44</div></td><td></td><td></td><td></td><td><div>140</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $endMeta = 0;</td></tr>
<tr><td class="h">1362</td><td colspan="6"></td></tr><tr><td class="h">1363</td><td><div class="c3">44</div><div class="c3">116</div><div class="c3">116</div></td><td></td><td></td><td></td><td><div>479</div><div>317</div><div>447</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$rtext =~ s(^%META:([^{]+){(.*)}%\r?\n)</td></tr>
<tr><td class="h">1364</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($endMeta=1;$meta-&gt;putKeyed( $1, _readKeyValues( $2, $format )),&#39;&#39;)gem;</td></tr>
<tr><td class="h">1365</td><td colspan="6"></td></tr><tr><td class="h">1366</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# eat the extra newline put in to separate text from tail meta-data</td></tr>
<tr><td class="h">1367</td><td><div class="c3">44</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1367">100</a></div></td><td></td><td></td><td><div>274</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$rtext =~ s/\n$//s if $endMeta;</td></tr>
<tr><td class="h">1368</td><td colspan="6"></td></tr><tr><td class="h">1369</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# If there is no meta data then convert from old format</td></tr>
<tr><td class="h">1370</td><td><div class="c3">44</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1370">100</a></div><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1370">50</a></div></td><td></td><td></td><td><div>223</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( ! $meta-&gt;count( &#39;TOPICINFO&#39; ) ) {</td></tr>
<tr><td class="h">1371</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1371">50</a></div></td><td></td><td></td><td><div>15</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $$rtext =~ /&lt;!--TWikiAttachment--&gt;/ ) {</td></tr>
<tr><td class="h">1372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$rtext = $this-&gt;{session}-&gt;{attach}-&gt;migrateToFileAttachmentMacro( $meta,</td></tr>
<tr><td class="h">1373</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$rtext );</td></tr>
<tr><td class="h">1374</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1375</td><td colspan="6"></td></tr><tr><td class="h">1376</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1376">50</a></div></td><td></td><td></td><td><div>17</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $$rtext =~ /&lt;!--TWikiCat--&gt;/ ) {</td></tr>
<tr><td class="h">1377</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require TWiki::Compatibility;</td></tr>
<tr><td class="h">1378</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$rtext = TWiki::Compatibility::upgradeCategoryTable( $this-&gt;{session}, $meta-&gt;web(), $meta-&gt;topic(),</td></tr>
<tr><td class="h">1379</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta, $$rtext );</td></tr>
<tr><td class="h">1380</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1381</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif( $format eq &#39;1.0beta&#39; ) {</td></tr>
<tr><td class="h">1382</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# This format used live at DrKW for a few months</td></tr>
<tr><td class="h">1383</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1383">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $$rtext =~ /&lt;!--TWikiCat--&gt;/ ) {</td></tr>
<tr><td class="h">1384</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require TWiki::Compatibility;</td></tr>
<tr><td class="h">1385</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$rtext = TWiki::Compatibility::upgradeCategoryTable( $this-&gt;{session}, $meta-&gt;web(), $meta-&gt;topic(),</td></tr>
<tr><td class="h">1386</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta,</td></tr>
<tr><td class="h">1387</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$rtext );</td></tr>
<tr><td class="h">1388</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1389</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{attach}-&gt;upgradeFrom1v0beta( $meta );</td></tr>
<tr><td class="h">1390</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1390">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $meta-&gt;count( &#39;TOPICMOVED&#39; ) ) {</td></tr>
<tr><td class="h">1391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $moved = $meta-&gt;get( &#39;TOPICMOVED&#39; );</td></tr>
<tr><td class="h">1392</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = $this-&gt;{session}-&gt;{users}-&gt;findUser( $moved-&gt;{by} );</td></tr>
<tr><td class="h">1393</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1393">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$moved-&gt;{by} = $u-&gt;wikiName() if $u;</td></tr>
<tr><td class="h">1394</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meta-&gt;put( &#39;TOPICMOVED&#39;, $moved );</td></tr>
<tr><td class="h">1395</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1396</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1397</td><td colspan="6"></td></tr><tr><td class="h">1398</td><td><div class="c3">44</div></td><td></td><td></td><td></td><td><div>161</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$format =~ s/[^\d\.]//g;</td></tr>
<tr><td class="h">1399</td><td><div class="c3">44</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1399">100</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1399">67</a></div></td><td></td><td><div>488</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $format &amp;&amp; $format &lt; 1.1 ) {</td></tr>
<tr><td class="h">1400</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# compatibility; topics version 1.0 and earlier equivalenced tab</td></tr>
<tr><td class="h">1401</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# with three spaces. Respect that.</td></tr>
<tr><td class="h">1402</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>603</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$rtext =~ s/\t/   /g;</td></tr>
<tr><td class="h">1403</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1404</td><td colspan="6"></td></tr><tr><td class="h">1405</td><td><div class="c3">44</div></td><td></td><td></td><td></td><td><div>213</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $meta;</td></tr>
<tr><td class="h">1406</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1407</td><td colspan="6"></td></tr><tr><td class="h">1408 - 1415</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getTopicParent (  $web, $topic  ) -&gt; $string

Get the name of the topic parent. Needs to be fast because
of use by Render.pm.

=cut</pre></td></tr>
<tr><td class="h">1416</td><td colspan="6"></td></tr><tr><td class="h">1417</td><td></td><td></td><td></td><td></td><td></td><td class="s"># SMELL: does not honour access controls</td></tr>
<tr><td class="h">1418</td><td colspan="6"></td></tr><tr><td class="h">1419</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getTopicParent {</td></tr>
<tr><td class="h">1420</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1420">1</a></div></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic ) = @_;</td></tr>
<tr><td class="h">1421</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>2</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1422</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(defined($web)) if DEBUG;</td></tr>
<tr><td class="h">1423</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(defined($topic)) if DEBUG;</td></tr>
<tr><td class="h">1424</td><td colspan="6"></td></tr><tr><td class="h">1425</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1425">50</a></div></td><td></td><td></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $this-&gt;topicExists( $web, $topic );</td></tr>
<tr><td class="h">1426</td><td colspan="6"></td></tr><tr><td class="h">1427</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">1428</td><td colspan="6"></td></tr><tr><td class="h">1429</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>15</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $strm = $handler-&gt;getStream();</td></tr>
<tr><td class="h">1430</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $data = &#39;&#39;;</td></tr>
<tr><td class="h">1431</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>29</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while( ( my $line = &lt;$strm&gt; ) ) {</td></tr>
<tr><td class="h">1432</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1432">100</a></div></td><td></td><td></td><td><div>14</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $line !~ /^%META:/ ) {</td></tr>
<tr><td class="h">1433</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last;</td></tr>
<tr><td class="h">1434</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1435</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>9</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data .= $line;</td></tr>
<tr><td class="h">1436</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1437</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1438</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>15</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;close( $strm );</td></tr>
<tr><td class="h">1439</td><td colspan="6"></td></tr><tr><td class="h">1440</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>10</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $meta = new TWiki::Meta( $this-&gt;{session}, $web, $topic );</td></tr>
<tr><td class="h">1441</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;extractMetaData( $meta, \$data );</td></tr>
<tr><td class="h">1442</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parentMeta = $meta-&gt;get( &#39;TOPICPARENT&#39; );</td></tr>
<tr><td class="h">1443</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1443">50</a></div></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $parentMeta-&gt;{name} if $parentMeta;</td></tr>
<tr><td class="h">1444</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">1445</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1446</td><td colspan="6"></td></tr><tr><td class="h">1447 - 1454</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getTopicLatestRevTime (  $web, $topic  ) -&gt; $epochSecs

Get an approximate rev time for the latest rev of the topic. This method
is used to optimise searching. Needs to be as fast as possible.

=cut</pre></td></tr>
<tr><td class="h">1455</td><td colspan="6"></td></tr><tr><td class="h">1456</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getTopicLatestRevTime {</td></tr>
<tr><td class="h">1457</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1457">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $web, $topic ) = @_;</td></tr>
<tr><td class="h">1458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">1459</td><td colspan="6"></td></tr><tr><td class="h">1460</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">1461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;getLatestRevisionTime();</td></tr>
<tr><td class="h">1462</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1463</td><td colspan="6"></td></tr><tr><td class="h">1464 - 1471</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod readMetaData( $web, $name ) -&gt; $text

Read a named meta-data string. If web is given the meta-data
is stored alongside a web.

=cut</pre></td></tr>
<tr><td class="h">1472</td><td colspan="6"></td></tr><tr><td class="h">1473</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub readMetaData {</td></tr>
<tr><td class="h">1474</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1474">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $web, $name ) = @_;</td></tr>
<tr><td class="h">1475</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1476</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">1477</td><td colspan="6"></td></tr><tr><td class="h">1478</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web );</td></tr>
<tr><td class="h">1479</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;readMetaData( $name );</td></tr>
<tr><td class="h">1480</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1481</td><td colspan="6"></td></tr><tr><td class="h">1482</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Add TOPICINFO type data to the object, as specified by the parameters.</td></tr>
<tr><td class="h">1483</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    * =$rev= - the revision number</td></tr>
<tr><td class="h">1484</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    * =$time= - the time stamp</td></tr>
<tr><td class="h">1485</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    * =$user= - the user object</td></tr>
<tr><td class="h">1486</td><td></td><td></td><td></td><td></td><td></td><td class="s"># SMELL: Duplicate rev control info in the topic</td></tr>
<tr><td class="h">1487</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub addTOPICINFO {</td></tr>
<tr><td class="h">1488</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1488">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $meta, $rev, $time, $user, $repRev ) = @_;</td></tr>
<tr><td class="h">1489</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1489">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rev = 1 if $rev &lt; 1;</td></tr>
<tr><td class="h">1490</td><td colspan="6"></td></tr><tr><td class="h">1491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %options =</td></tr>
<tr><td class="h">1492</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</td></tr>
<tr><td class="h">1493</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# compatibility; older versions of the code use</td></tr>
<tr><td class="h">1494</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# RCS rev numbers save with them so old code can</td></tr>
<tr><td class="h">1495</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# read these topics</td></tr>
<tr><td class="h">1496</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;version =&gt; &#39;1.&#39;.$rev,</td></tr>
<tr><td class="h">1497</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date    =&gt; $time,</td></tr>
<tr><td class="h">1498</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;author  =&gt; $user-&gt;wikiName(),</td></tr>
<tr><td class="h">1499</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;format  =&gt; $TWiki::Store::STORE_FORMAT_VERSION,</td></tr>
<tr><td class="h">1500</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1501</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if this is a reprev, then store the revision that was affected.</td></tr>
<tr><td class="h">1502</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Required so we can tell when a merge is based on something that</td></tr>
<tr><td class="h">1503</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is *not* the original rev where another users&#39; edit started.</td></tr>
<tr><td class="h">1504</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# See Bugs:Item1897.</td></tr>
<tr><td class="h">1505</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1505">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$options{reprev} = &#39;1.&#39;.$rev if $repRev;</td></tr>
<tr><td class="h">1506</td><td colspan="6"></td></tr><tr><td class="h">1507</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$meta-&gt;put( &#39;TOPICINFO&#39;, \%options );</td></tr>
<tr><td class="h">1508</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1509</td><td colspan="6"></td></tr><tr><td class="h">1510 - 1517</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod saveMetaData( $web, $name ) -&gt; $text

Write a named meta-data string. If web is given the meta-data
is stored alongside a web.

=cut</pre></td></tr>
<tr><td class="h">1518</td><td colspan="6"></td></tr><tr><td class="h">1519</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub saveMetaData {</td></tr>
<tr><td class="h">1520</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1520">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $web, $name, $text ) = @_;</td></tr>
<tr><td class="h">1521</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1522</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">1523</td><td colspan="6"></td></tr><tr><td class="h">1524</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web );</td></tr>
<tr><td class="h">1525</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;saveMetaData( $name, $text );</td></tr>
<tr><td class="h">1526</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1527</td><td colspan="6"></td></tr><tr><td class="h">1528 - 1536</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getTopicNames( $web ) -&gt; @topics

Get list of all topics in a web
   * =$web= - Web name, required, e.g. =&#39;Sandbox&#39;=
Return a topic list, e.g. =( &#39;WebChanges&#39;,  &#39;WebHome&#39;, &#39;WebIndex&#39;, &#39;WebNotify&#39; )=

=cut</pre></td></tr>
<tr><td class="h">1537</td><td colspan="6"></td></tr><tr><td class="h">1538</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getTopicNames {</td></tr>
<tr><td class="h">1539</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1539">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web ) = @_ ;</td></tr>
<tr><td class="h">1540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1541</td><td colspan="6"></td></tr><tr><td class="h">1542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">1543</td><td colspan="6"></td></tr><tr><td class="h">1544</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web );</td></tr>
<tr><td class="h">1545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;getTopicNames();</td></tr>
<tr><td class="h">1546</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1547</td><td colspan="6"></td></tr><tr><td class="h">1548 - 1563</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getListOfWebs( $filter ) -&gt; @webNames

Gets a list of webs, filtered according to the spec in the $filter,
which may include one of:
   1 &#39;user&#39; (for only user webs)
   2 &#39;template&#39; (for only template webs)
$filter may also contain the word &#39;public&#39; which will further filter
webs on whether NOSEARCHALL is specified for them or not.
&#39;allowed&#39; filters out webs that the user is denied access to by a *WEBVIEW.

If $TWiki::cfg{EnableHierarchicalWebs} is set, will also list
sub-webs recursively.

=cut</pre></td></tr>
<tr><td class="h">1564</td><td colspan="6"></td></tr><tr><td class="h">1565</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getListOfWebs {</td></tr>
<tr><td class="h">1566</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1566">1</a></div></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $filter, $web ) = @_;</td></tr>
<tr><td class="h">1567</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1568</td><td><div class="c3">1</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1568">50</a></div></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$filter ||= &#39;&#39;;</td></tr>
<tr><td class="h">1569</td><td><div class="c3">1</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1569">50</a></div></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web ||= &#39;&#39;;</td></tr>
<tr><td class="h">1570</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#g;</td></tr>
<tr><td class="h">1571</td><td colspan="6"></td></tr><tr><td class="h">1572</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @webList = $this-&gt;_getSubWebs( $web );</td></tr>
<tr><td class="h">1573</td><td colspan="6"></td></tr><tr><td class="h">1574</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1574">50</a></div><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1574">0</a></div></td><td></td><td></td><td><div>8</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $filter =~ /\buser\b/ ) {</td></tr>
<tr><td class="h">1575</td><td><div class="c3">1</div><div class="c3">6</div></td><td></td><td></td><td></td><td><div>3</div><div>26</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@webList = grep { !/(?:^_|\/_)/, } @webList;</td></tr>
<tr><td class="h">1576</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif( $filter =~ /\btemplate\b/ ) {</td></tr>
<tr><td class="h">1577</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@webList = grep { /(?:^_|\/_)/, } @webList;</td></tr>
<tr><td class="h">1578</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1579</td><td colspan="6"></td></tr><tr><td class="h">1580</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = $this-&gt;{session}-&gt;{user};</td></tr>
<tr><td class="h">1581</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1581">50</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1581">33</a></div></td><td></td><td><div>12</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $filter =~ /\bpublic\b/ &amp;&amp; !$user-&gt;isAdmin()) {</td></tr>
<tr><td class="h">1582</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $prefs = $this-&gt;{session}-&gt;{prefs};</td></tr>
<tr><td class="h">1583</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $wn = $this-&gt;{session}-&gt;{webName};</td></tr>
<tr><td class="h">1584</td><td><div class="c3">4</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1584">100</a></div></td><td></td><td></td><td><div>27</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@webList =</td></tr>
<tr><td class="h">1585</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep {</td></tr>
<tr><td class="h">1586</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_ eq $wn ||</td></tr>
<tr><td class="h">1587</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$prefs-&gt;getWebPreferencesValue( &#39;NOSEARCHALL&#39;, $_ )</td></tr>
<tr><td class="h">1588</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} @webList;</td></tr>
<tr><td class="h">1589</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1590</td><td colspan="6"></td></tr><tr><td class="h">1591</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1591">50</a></div></td><td></td><td></td><td><div>9</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $filter =~ /\ballowed\b/ ) {</td></tr>
<tr><td class="h">1592</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $security = $this-&gt;{session}-&gt;{security};</td></tr>
<tr><td class="h">1593</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td><div>16</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@webList =</td></tr>
<tr><td class="h">1594</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep {</td></tr>
<tr><td class="h">1595</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$security-&gt;checkAccessPermission(</td></tr>
<tr><td class="h">1596</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;view&#39;, $user, undef, undef, undef, $_ )</td></tr>
<tr><td class="h">1597</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} @webList;</td></tr>
<tr><td class="h">1598</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1599</td><td colspan="6"></td></tr><tr><td class="h">1600</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>12</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return sort @webList;</td></tr>
<tr><td class="h">1601</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1602</td><td colspan="6"></td></tr><tr><td class="h">1603</td><td></td><td></td><td></td><td></td><td></td><td class="s"># get a list of directories within the named web directory. If hierarchical</td></tr>
<tr><td class="h">1604</td><td></td><td></td><td></td><td></td><td></td><td class="s"># webs are enabled, returns a deep list e.g. web, web/subweb,</td></tr>
<tr><td class="h">1605</td><td></td><td></td><td></td><td></td><td></td><td class="s"># web/subweb/subsubweb</td></tr>
<tr><td class="h">1606</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _getSubWebs {</td></tr>
<tr><td class="h">1607</td><td><div class="c3">7</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1607">7</a></div></td><td><div>24</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web ) = @_ ;</td></tr>
<tr><td class="h">1608</td><td colspan="6"></td></tr><tr><td class="h">1609</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td><div>23</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web );</td></tr>
<tr><td class="h">1610</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td><div>35</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @tmpList = $handler-&gt;getWebNames();</td></tr>
<tr><td class="h">1611</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# filter only those webs that meet the webExists criteria</td></tr>
<tr><td class="h">1612</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td><div>18</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @webList;</td></tr>
<tr><td class="h">1613</td><td><div class="c3">7</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1613">100</a></div></td><td></td><td></td><td><div>25</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $web ) {</td></tr>
<tr><td class="h">1614</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# sub-web</td></tr>
<tr><td class="h">1615</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@webList = sort</td></tr>
<tr><td class="h">1616</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $this-&gt;webExists( $_ ) } # filter dirs with no WebHome</td></tr>
<tr><td class="h">1617</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td><div>26</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map { $web.&#39;/&#39;.$_ }           # add hierarchical path</td></tr>
<tr><td class="h">1618</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@tmpList;</td></tr>
<tr><td class="h">1619</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1620</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# root level (no parent web)</td></tr>
<tr><td class="h">1621</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td><div>31</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@webList = sort</td></tr>
<tr><td class="h">1622</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $this-&gt;webExists( $_ ) } # filter dirs with no WebHome</td></tr>
<tr><td class="h">1623</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@tmpList;</td></tr>
<tr><td class="h">1624</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1625</td><td colspan="6"></td></tr><tr><td class="h">1626</td><td><div class="c3">7</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1626">50</a></div></td><td></td><td></td><td><div>37</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $TWiki::cfg{EnableHierarchicalWebs} ) {</td></tr>
<tr><td class="h">1627</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td><div>20</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @subWebList = ();</td></tr>
<tr><td class="h">1628</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td><div>27</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $subWeb ( @webList ) {</td></tr>
<tr><td class="h">1629</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td><div>28</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push( @subWebList, $this-&gt;_getSubWebs( $subWeb ));</td></tr>
<tr><td class="h">1630</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1631</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td><div>22</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push( @webList, @subWebList );</td></tr>
<tr><td class="h">1632</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1633</td><td colspan="6"></td></tr><tr><td class="h">1634</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td><div>34</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @webList;</td></tr>
<tr><td class="h">1635</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1636</td><td colspan="6"></td></tr><tr><td class="h">1637 - 1653</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod createWeb( $user, $newWeb, $baseWeb, $opts )

$newWeb is the name of the new web.

$baseWeb is the name of an existing web (a template web). If the
base web is a system web, all topics in it
will be copied into the new web. If it is a normal web, only topics starting
with &#39;Web&#39; will be copied. If no base web is specified, an empty web
(with no topics) will be created. If it is specified but does not exist,
an error will be thrown.

$opts is a ref to a hash that contains settings to be modified in
the web preferences topic in the new web.

=cut</pre></td></tr>
<tr><td class="h">1654</td><td colspan="6"></td></tr><tr><td class="h">1655</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub createWeb {</td></tr>
<tr><td class="h">1656</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1656">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $user, $newWeb, $baseWeb, $opts ) = @_;</td></tr>
<tr><td class="h">1657</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1658</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1659</td><td colspan="6"></td></tr><tr><td class="h">1660</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1660">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $baseWeb ) {</td></tr>
<tr><td class="h">1661</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# For a web to be a web, it has to have at least one topic</td></tr>
<tr><td class="h">1662</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $meta = new TWiki::Meta( $this-&gt;{session}, $newWeb,</td></tr>
<tr><td class="h">1663</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TWiki::cfg{WebPrefsTopicName} );</td></tr>
<tr><td class="h">1664</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;saveTopic( $user, $newWeb, $TWiki::cfg{WebPrefsTopicName},</td></tr>
<tr><td class="h">1665</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Preferences&quot;, $meta );</td></tr>
<tr><td class="h">1666</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">1667</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1668</td><td colspan="6"></td></tr><tr><td class="h">1669</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1669">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $this-&gt;webExists( $baseWeb )) {</td></tr>
<tr><td class="h">1670</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw Error::Simple( &#39;Base web &#39;.$baseWeb.&#39; does not exist&#39; );</td></tr>
<tr><td class="h">1671</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1672</td><td colspan="6"></td></tr><tr><td class="h">1673</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$newWeb =~ s#\.#/#go;</td></tr>
<tr><td class="h">1674</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1674">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$baseWeb =~ s#\.#/#go if $baseWeb;</td></tr>
<tr><td class="h">1675</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# copy topics from base web</td></tr>
<tr><td class="h">1676</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @topicList = $this-&gt;getTopicNames( $baseWeb );</td></tr>
<tr><td class="h">1677</td><td colspan="6"></td></tr><tr><td class="h">1678</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1678">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $baseWeb =~ /^_/ ) {</td></tr>
<tr><td class="h">1679</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# not a system web, so filter for only Web* topics</td></tr>
<tr><td class="h">1680</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@topicList = grep { /^Web/ } @topicList;</td></tr>
<tr><td class="h">1681</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1682</td><td colspan="6"></td></tr><tr><td class="h">1683</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $topic ( @topicList ) {</td></tr>
<tr><td class="h">1684</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;copyTopic( $user, $baseWeb, $topic, $newWeb, $topic );</td></tr>
<tr><td class="h">1685</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1686</td><td colspan="6"></td></tr><tr><td class="h">1687</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# create meta-data files</td></tr>
<tr><td class="h">1688</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;saveMetaData( $newWeb, &#39;changes&#39;, &#39;&#39;);</td></tr>
<tr><td class="h">1689</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;saveMetaData( $newWeb, &#39;mailnotify&#39;, &#39;&#39;);</td></tr>
<tr><td class="h">1690</td><td colspan="6"></td></tr><tr><td class="h">1691</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# patch WebPreferences in new web</td></tr>
<tr><td class="h">1692</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $wpt = $TWiki::cfg{WebPrefsTopicName};</td></tr>
<tr><td class="h">1693</td><td colspan="6"></td></tr><tr><td class="h">1694</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1694">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $this-&gt;topicExists( $newWeb, $wpt );</td></tr>
<tr><td class="h">1695</td><td colspan="6"></td></tr><tr><td class="h">1696</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $meta, $text ) =</td></tr>
<tr><td class="h">1697</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;readTopic( undef, $newWeb, $wpt, undef );</td></tr>
<tr><td class="h">1698</td><td colspan="6"></td></tr><tr><td class="h">1699</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1699">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $opts ) {</td></tr>
<tr><td class="h">1700</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $key ( %$opts ) {</td></tr>
<tr><td class="h">1701</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text =~ s/($TWiki::regex{setRegex}$key\s*=).*?$/$1 $opts-&gt;{$key}/gm;</td></tr>
<tr><td class="h">1702</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1703</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1704</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;saveTopic( $user, $newWeb, $wpt, $text, $meta );</td></tr>
<tr><td class="h">1705</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1706</td><td colspan="6"></td></tr><tr><td class="h">1707 - 1720</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod removeWeb( $user, $web )

   * =$user= - user doing the removing (for the history)
   * =$web= - web being removed

Destroy a web, utterly. Removed the data and attachments in the web.

Use with great care!

The web must be a known web to be removed this way.

=cut</pre></td></tr>
<tr><td class="h">1721</td><td colspan="6"></td></tr><tr><td class="h">1722</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub removeWeb {</td></tr>
<tr><td class="h">1723</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1723">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $user, $web ) = @_;</td></tr>
<tr><td class="h">1724</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT( $web ) if DEBUG;</td></tr>
<tr><td class="h">1725</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">1726</td><td colspan="6"></td></tr><tr><td class="h">1727</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1727">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $this-&gt;webExists( $web )) {</td></tr>
<tr><td class="h">1728</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw Error::Simple( &#39;No such web &#39;.$web );</td></tr>
<tr><td class="h">1729</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1730</td><td colspan="6"></td></tr><tr><td class="h">1731</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web );</td></tr>
<tr><td class="h">1732</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;removeWeb();</td></tr>
<tr><td class="h">1733</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1734</td><td colspan="6"></td></tr><tr><td class="h">1735</td><td></td><td></td><td></td><td></td><td></td><td class="s"># STATIC Write a meta-data key=value pair</td></tr>
<tr><td class="h">1736</td><td></td><td></td><td></td><td></td><td></td><td class="s"># The encoding is reversed in _readKeyValues</td></tr>
<tr><td class="h">1737</td><td></td><td></td><td></td><td></td><td></td><td class="s"># SMELL: this uses a really bad escape encoding</td></tr>
<tr><td class="h">1738</td><td></td><td></td><td></td><td></td><td></td><td class="s"># 1. it doesn&#39;t handle all characters that need escaping.</td></tr>
<tr><td class="h">1739</td><td></td><td></td><td></td><td></td><td></td><td class="s"># 2. it&#39;s excessively noisy</td></tr>
<tr><td class="h">1740</td><td></td><td></td><td></td><td></td><td></td><td class="s"># 3. it&#39;s not a reversible encoding; \r&#39;s are lost</td></tr>
<tr><td class="h">1741</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _writeKeyValue {</td></tr>
<tr><td class="h">1742</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1742">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $key, $value ) = @_;</td></tr>
<tr><td class="h">1743</td><td colspan="6"></td></tr><tr><td class="h">1744</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1744">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( defined( $value )) {</td></tr>
<tr><td class="h">1745</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = dataEncode( $value );</td></tr>
<tr><td class="h">1746</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1747</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = &#39;&#39;;</td></tr>
<tr><td class="h">1748</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1749</td><td colspan="6"></td></tr><tr><td class="h">1750</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $key.&#39;=&quot;&#39;.$value.&#39;&quot;&#39;;</td></tr>
<tr><td class="h">1751</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1752</td><td colspan="6"></td></tr><tr><td class="h">1753</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Write all the key=value pairs for the types listed</td></tr>
<tr><td class="h">1754</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _writeTypes {</td></tr>
<tr><td class="h">1755</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1755">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $meta, @types ) = @_;</td></tr>
<tr><td class="h">1756</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($meta-&gt;isa(&#39;TWiki::Meta&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1757</td><td colspan="6"></td></tr><tr><td class="h">1758</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $text = &#39;&#39;;</td></tr>
<tr><td class="h">1759</td><td colspan="6"></td></tr><tr><td class="h">1760</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1760">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $types[0] eq &#39;not&#39; ) {</td></tr>
<tr><td class="h">1761</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# write all types that are not in the list</td></tr>
<tr><td class="h">1762</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %seen;</td></tr>
<tr><td class="h">1763</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@seen{ @types } = ();</td></tr>
<tr><td class="h">1764</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@types = ();  # empty &quot;not in list&quot;</td></tr>
<tr><td class="h">1765</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $key ( keys %$meta ) {</td></tr>
<tr><td class="h">1766</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1766">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1766">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push( @types, $key ) unless</td></tr>
<tr><td class="h">1767</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(exists $seen{ $key } || $key =~ /^_/);</td></tr>
<tr><td class="h">1768</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1769</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1770</td><td colspan="6"></td></tr><tr><td class="h">1771</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $type ( @types ) {</td></tr>
<tr><td class="h">1772</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $data = $meta-&gt;{$type};</td></tr>
<tr><td class="h">1773</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $item ( @$data ) {</td></tr>
<tr><td class="h">1774</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sep = &#39;&#39;;</td></tr>
<tr><td class="h">1775</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text .= &#39;%META:&#39;.$type.&#39;{&#39;;</td></tr>
<tr><td class="h">1776</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $name = $item-&gt;{name};</td></tr>
<tr><td class="h">1777</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1777">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $name ) {</td></tr>
<tr><td class="h">1778</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If there&#39;s a name field, put first to make regexp based searching easier</td></tr>
<tr><td class="h">1779</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text .= _writeKeyValue( &#39;name&#39;, $item-&gt;{name} );</td></tr>
<tr><td class="h">1780</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sep = &#39; &#39;;</td></tr>
<tr><td class="h">1781</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1782</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $key ( sort keys %$item ) {</td></tr>
<tr><td class="h">1783</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1783">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $key ne &#39;name&#39; ) {</td></tr>
<tr><td class="h">1784</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text .= $sep;</td></tr>
<tr><td class="h">1785</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text .= _writeKeyValue( $key, $item-&gt;{$key} );</td></tr>
<tr><td class="h">1786</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sep = &#39; &#39;;</td></tr>
<tr><td class="h">1787</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1788</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1789</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text .= &#39;}%&#39;.&quot;\n&quot;;</td></tr>
<tr><td class="h">1790</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1791</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1792</td><td colspan="6"></td></tr><tr><td class="h">1793</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $text;</td></tr>
<tr><td class="h">1794</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1795</td><td colspan="6"></td></tr><tr><td class="h">1796</td><td></td><td></td><td></td><td></td><td></td><td class="s"># STATIC Meta data for start of topic</td></tr>
<tr><td class="h">1797</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _writeStart {</td></tr>
<tr><td class="h">1798</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1798">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $meta ) = @_;</td></tr>
<tr><td class="h">1799</td><td colspan="6"></td></tr><tr><td class="h">1800</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return _writeTypes( $meta, qw/TOPICINFO TOPICPARENT/ );</td></tr>
<tr><td class="h">1801</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1802</td><td colspan="6"></td></tr><tr><td class="h">1803</td><td></td><td></td><td></td><td></td><td></td><td class="s"># STATIC Meta data for end of topic</td></tr>
<tr><td class="h">1804</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _writeEnd {</td></tr>
<tr><td class="h">1805</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1805">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $meta ) = @_;</td></tr>
<tr><td class="h">1806</td><td colspan="6"></td></tr><tr><td class="h">1807</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $text = _writeTypes($meta, qw/FORM FIELD FILEATTACHMENT TOPICMOVED/ );</td></tr>
<tr><td class="h">1808</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# append remaining meta data</td></tr>
<tr><td class="h">1809</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text .= _writeTypes( $meta, qw/not TOPICINFO TOPICPARENT FORM FIELD FILEATTACHMENT TOPICMOVED/ );</td></tr>
<tr><td class="h">1810</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $text;</td></tr>
<tr><td class="h">1811</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1812</td><td colspan="6"></td></tr><tr><td class="h">1813</td><td></td><td></td><td></td><td></td><td></td><td class="s"># STATIC Prepend/append meta data to topic</td></tr>
<tr><td class="h">1814</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _writeMeta {</td></tr>
<tr><td class="h">1815</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1815">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $meta, $text ) = @_;</td></tr>
<tr><td class="h">1816</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($meta-&gt;isa(&#39;TWiki::Meta&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1817</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1817">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text ||= &#39;&#39;;</td></tr>
<tr><td class="h">1818</td><td colspan="6"></td></tr><tr><td class="h">1819</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $start = _writeStart( $meta );</td></tr>
<tr><td class="h">1820</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $end = _writeEnd( $meta );</td></tr>
<tr><td class="h">1821</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text = $start . $text;</td></tr>
<tr><td class="h">1822</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1822">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$end = &quot;\n&quot;.$end if $end;</td></tr>
<tr><td class="h">1823</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text .= $end;</td></tr>
<tr><td class="h">1824</td><td colspan="6"></td></tr><tr><td class="h">1825</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $text;</td></tr>
<tr><td class="h">1826</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1827</td><td colspan="6"></td></tr><tr><td class="h">1828 - 1835</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getDebugText($meta, $text) -&gt; $text

Generate a debug text form of the text/meta, for use in debug displays,
by annotating the text with meta informtion.

=cut</pre></td></tr>
<tr><td class="h">1836</td><td colspan="6"></td></tr><tr><td class="h">1837</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getDebugText {</td></tr>
<tr><td class="h">1838</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1838">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $meta, $text ) = @_;</td></tr>
<tr><td class="h">1839</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1840</td><td colspan="6"></td></tr><tr><td class="h">1841</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return _writeMeta( $meta, $text );</td></tr>
<tr><td class="h">1842</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1843</td><td colspan="6"></td></tr><tr><td class="h">1844 - 1853</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod cleanUpRevID( $rev ) -&gt; $integer

Cleans up (maps) a user-supplied revision ID and converts it to an integer
number that can be incremented to create a new revision number.

This method should be used to sanitise user-provided revision IDs.

=cut</pre></td></tr>
<tr><td class="h">1854</td><td colspan="6"></td></tr><tr><td class="h">1855</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub cleanUpRevID {</td></tr>
<tr><td class="h">1856</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1856">1</a></div></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $rev ) = @_;</td></tr>
<tr><td class="h">1857</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1858</td><td colspan="6"></td></tr><tr><td class="h">1859</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1859">50</a></div></td><td></td><td></td><td><div>8</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $rev;</td></tr>
<tr><td class="h">1860</td><td colspan="6"></td></tr><tr><td class="h">1861</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rev =~ s/^r(ev)?//i;</td></tr>
<tr><td class="h">1862</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rev =~ s/^\d+\.//; # clean up RCS rev number</td></tr>
<tr><td class="h">1863</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rev =~ s/[^\d]//g; # digits only</td></tr>
<tr><td class="h">1864</td><td colspan="6"></td></tr><tr><td class="h">1865</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return TWiki::Sandbox::untaintUnchecked( $rev );</td></tr>
<tr><td class="h">1866</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1867</td><td colspan="6"></td></tr><tr><td class="h">1868 - 1876</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod copyTopic($user, $fromweb, $fromtopic, $toweb, $totopic)

Copy a topic and all it&#39;s attendant data from one web to another.

SMELL: Does not fix up meta-data!

=cut</pre></td></tr>
<tr><td class="h">1877</td><td colspan="6"></td></tr><tr><td class="h">1878</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub copyTopic {</td></tr>
<tr><td class="h">1879</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1879">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $user, $fromWeb, $fromTopic, $toWeb, $toTopic ) = @_;</td></tr>
<tr><td class="h">1880</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT($this-&gt;isa(&#39;TWiki::Store&#39;)) if DEBUG;</td></tr>
<tr><td class="h">1881</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$fromWeb =~ s#\.#/#go;</td></tr>
<tr><td class="h">1882</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$toWeb =~ s#\.#/#go;</td></tr>
<tr><td class="h">1883</td><td colspan="6"></td></tr><tr><td class="h">1884</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $fromWeb, $fromTopic );</td></tr>
<tr><td class="h">1885</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;copyTopic( $toWeb, $toTopic );</td></tr>
<tr><td class="h">1886</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1887</td><td colspan="6"></td></tr><tr><td class="h">1888 - 1906</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod searchMetaData($params) -&gt; $text

Search meta-data associated with topics. Parameters are passed in the $params hash,
which may contain:
| =type= | =topicmoved=, =parent= or =field= |
| =topic= | topic to search for, for =topicmoved= and =parent= |
| =name= | form field to search, for =field= type searches. May be a regex. |
| =value= | form field value. May be a regex. |
| =title= | Title prepended to the returned search results |
| =default= | defualt value if there are no results |
| =web= | web to search in, default is all webs |
The idea is that people can search for meta-data values without having to be
aware of how or where meta-data is stored.

SMELL: should be replaced with a proper SQL-like search, c.f. Plugins.DBCacheContrib.

=cut</pre></td></tr>
<tr><td class="h">1907</td><td colspan="6"></td></tr><tr><td class="h">1908</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub searchMetaData {</td></tr>
<tr><td class="h">1909</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1909">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $params ) = @_;</td></tr>
<tr><td class="h">1910</td><td colspan="6"></td></tr><tr><td class="h">1911</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1911">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $attrType = $params-&gt;{type} || &#39;FIELD&#39;;</td></tr>
<tr><td class="h">1912</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1912">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $attrWeb = $params-&gt;{web} || $this-&gt;{session}-&gt;{webName};</td></tr>
<tr><td class="h">1913</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1913">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $attrTopic = $params-&gt;{topic} || $this-&gt;{session}-&gt;{topicName};</td></tr>
<tr><td class="h">1914</td><td colspan="6"></td></tr><tr><td class="h">1915</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $searchVal = &#39;XXX&#39;;</td></tr>
<tr><td class="h">1916</td><td colspan="6"></td></tr><tr><td class="h">1917</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1917">0</a></div><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1917">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $attrType eq &#39;parent&#39; ) {</td></tr>
<tr><td class="h">1918</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$searchVal = &quot;%META:TOPICPARENT[{].*name=\\\&quot;($attrWeb\\.)?$attrTopic\\\&quot;.*[}]%&quot;;</td></tr>
<tr><td class="h">1919</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $attrType eq &#39;topicmoved&#39; ) {</td></tr>
<tr><td class="h">1920</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$searchVal = &quot;%META:TOPICMOVED[{].*from=\\\&quot;$attrWeb\.$attrTopic\\\&quot;.*[}]%&quot;;</td></tr>
<tr><td class="h">1921</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1922</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$searchVal = &quot;%META:&quot;.uc( $attrType ).&quot;[{].*&quot;;</td></tr>
<tr><td class="h">1923</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1923">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$searchVal .= &quot;name=\\\&quot;$params-&gt;{name}\\\&quot;.*&quot;</td></tr>
<tr><td class="h">1924</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $params-&gt;{name});</td></tr>
<tr><td class="h">1925</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1925">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$searchVal .= &quot;value=\\\&quot;$params-&gt;{value}\\\&quot;.*&quot;</td></tr>
<tr><td class="h">1926</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $params-&gt;{value});</td></tr>
<tr><td class="h">1927</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$searchVal .= &quot;[}]%&quot;;</td></tr>
<tr><td class="h">1928</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1929</td><td colspan="6"></td></tr><tr><td class="h">1930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $text = &#39;&#39;;</td></tr>
<tr><td class="h">1931</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1931">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($params-&gt;{format}) {</td></tr>
<tr><td class="h">1932</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = $this-&gt;{session}-&gt;{search}-&gt;searchWeb</td></tr>
<tr><td class="h">1933</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</td></tr>
<tr><td class="h">1934</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;format	       =&gt; $params-&gt;{format},</td></tr>
<tr><td class="h">1935</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;search        =&gt; $searchVal,</td></tr>
<tr><td class="h">1936</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;web           =&gt; $attrWeb,</td></tr>
<tr><td class="h">1937</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type          =&gt; &#39;regex&#39;,</td></tr>
<tr><td class="h">1938</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nosummary     =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1939</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nosearch      =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1940</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noheader      =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1941</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nototal       =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1942</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noempty       =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1943</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;template      =&gt; &#39;searchmeta&#39;,</td></tr>
<tr><td class="h">1944</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inline        =&gt; 1,</td></tr>
<tr><td class="h">1945</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1946</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1947</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;{session}-&gt;{search}-&gt;searchWeb</td></tr>
<tr><td class="h">1948</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</td></tr>
<tr><td class="h">1949</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_callback     =&gt; \&amp;_collate,</td></tr>
<tr><td class="h">1950</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_cbdata       =&gt; \$text,,</td></tr>
<tr><td class="h">1951</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;search        =&gt; $searchVal,</td></tr>
<tr><td class="h">1952</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;web           =&gt; $attrWeb,</td></tr>
<tr><td class="h">1953</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type          =&gt; &#39;regex&#39;,</td></tr>
<tr><td class="h">1954</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nosummary     =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1955</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nosearch      =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1956</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noheader      =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1957</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nototal       =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1958</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noempty       =&gt; &#39;on&#39;,</td></tr>
<tr><td class="h">1959</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;template      =&gt; &#39;searchmeta&#39;,</td></tr>
<tr><td class="h">1960</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inline        =&gt; 1,</td></tr>
<tr><td class="h">1961</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1962</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1963</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1963">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $attrTitle = $params-&gt;{title} || &#39;&#39;;</td></tr>
<tr><td class="h">1964</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L1964">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $text ) {</td></tr>
<tr><td class="h">1965</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = $attrTitle.$text;</td></tr>
<tr><td class="h">1966</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1967</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--condition.html#L1967">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $attrDefault = $params-&gt;{default} || &#39;&#39;;</td></tr>
<tr><td class="h">1968</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = $attrTitle.$attrDefault;</td></tr>
<tr><td class="h">1969</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1970</td><td colspan="6"></td></tr><tr><td class="h">1971</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $text;</td></tr>
<tr><td class="h">1972</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1973</td><td colspan="6"></td></tr><tr><td class="h">1974</td><td></td><td></td><td></td><td></td><td></td><td class="s"># callback for search function to collate</td></tr>
<tr><td class="h">1975</td><td></td><td></td><td></td><td></td><td></td><td class="s"># results</td></tr>
<tr><td class="h">1976</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _collate {</td></tr>
<tr><td class="h">1977</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L1977">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ref = shift;</td></tr>
<tr><td class="h">1978</td><td colspan="6"></td></tr><tr><td class="h">1979</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$ref .= join( &#39; &#39;, @_ );</td></tr>
<tr><td class="h">1980</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1981</td><td colspan="6"></td></tr><tr><td class="h">1982 - 2005</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod searchInWebContent($searchString, $web, \@topics, \%options ) -&gt; \%map

Search for a string in the content of a web. The search must be over all
content and all formatted meta-data, though the latter search type is
deprecated (use searchMetaData instead).

   * =$searchString= - the search string, in egrep format if regex
   * =$web= - The web to search in
   * =\@topics= - reference to a list of topics to search
   * =\%options= - reference to an options hash
The =\%options= hash may contain the following options:
   * =type= - if =regex= will perform a egrep-syntax RE search (default &#39;&#39;)
   * =casesensitive= - false to ignore case (defaulkt true)
   * =files_without_match= - true to return files only (default false)

The return value is a reference to a hash which maps each matching topic
name to a list of the lines in that topic that matched the search,
as would be returned by &#39;grep&#39;. If =files_without_match= is specified, it will
return on the first match in each topic (i.e. it will return only one
match per topic, and will not return matching lines).

=cut</pre></td></tr>
<tr><td class="h">2006</td><td colspan="6"></td></tr><tr><td class="h">2007</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub searchInWebContent {</td></tr>
<tr><td class="h">2008</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L2008">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $searchString, $web, $topics, $options ) = @_;</td></tr>
<tr><td class="h">2009</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$web =~ s#\.#/#go;</td></tr>
<tr><td class="h">2010</td><td colspan="6"></td></tr><tr><td class="h">2011</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web );</td></tr>
<tr><td class="h">2012</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;searchInWebContent( $searchString, $topics, $options );</td></tr>
<tr><td class="h">2013</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2014</td><td colspan="6"></td></tr><tr><td class="h">2015 - 2027</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getRevisionAtTime( $web, $topic, $time ) -&gt; $rev

   * =$web= - web for topic
   * =$topic= - topic
   * =$time= - time (in epoch secs) for the rev

Get the revision number of a topic at a specific time.
Returns a single-digit rev number or undef if it couldn&#39;t be determined
(either because the topic isn&#39;t that old, or there was a problem)

=cut</pre></td></tr>
<tr><td class="h">2028</td><td colspan="6"></td></tr><tr><td class="h">2029</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getRevisionAtTime {</td></tr>
<tr><td class="h">2030</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L2030">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $this, $web, $topic, $time ) = @_;</td></tr>
<tr><td class="h">2031</td><td colspan="6"></td></tr><tr><td class="h">2032</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">2033</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $handler-&gt;getRevisionAtTime( $time );</td></tr>
<tr><td class="h">2034</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2035</td><td colspan="6"></td></tr><tr><td class="h">2036 - 2050</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod getLease( $web, $topic ) -&gt; $lease

   * =$web= - web for topic
   * =$topic= - topic

If there is an lease on the topic, return the lease, otherwise undef.
A lease is a block of meta-information about a topic that can be
recovered (this is a hash containing =user=, =taken= and =expires=).
Leases are taken out when a topic is edited. Only one lease
can be active on a topic at a time. Leases are used to warn if
another user is already editing a topic.

=cut</pre></td></tr>
<tr><td class="h">2051</td><td colspan="6"></td></tr><tr><td class="h">2052</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getLease {</td></tr>
<tr><td class="h">2053</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L2053">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic ) = @_;</td></tr>
<tr><td class="h">2054</td><td colspan="6"></td></tr><tr><td class="h">2055</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">2056</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lease = $handler-&gt;getLease();</td></tr>
<tr><td class="h">2057</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L2057">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $lease ) {</td></tr>
<tr><td class="h">2058</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $user = $this-&gt;{session}-&gt;{users}-&gt;findUser( $lease-&gt;{user} );</td></tr>
<tr><td class="h">2059</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ASSERT( $user-&gt;isa(&#39;TWiki::User&#39;)) if DEBUG;</td></tr>
<tr><td class="h">2060</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lease-&gt;{user} = $user;</td></tr>
<tr><td class="h">2061</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2062</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $lease;</td></tr>
<tr><td class="h">2063</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2064</td><td colspan="6"></td></tr><tr><td class="h">2065 - 2073</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod setLease( $web, $topic, $user, $length )

Take out an lease on the given topic for this user for $length seconds.

See =getLease= for more details about Leases.

=cut</pre></td></tr>
<tr><td class="h">2074</td><td colspan="6"></td></tr><tr><td class="h">2075</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub setLease {</td></tr>
<tr><td class="h">2076</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L2076">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic, $user, $length ) = @_;</td></tr>
<tr><td class="h">2077</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT( $user-&gt;isa( &#39;TWiki::User&#39;) ) if DEBUG;</td></tr>
<tr><td class="h">2078</td><td colspan="6"></td></tr><tr><td class="h">2079</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">2080</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lease;</td></tr>
<tr><td class="h">2081</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Store-pm--branch.html#L2081">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $user ) {</td></tr>
<tr><td class="h">2082</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $t = time();</td></tr>
<tr><td class="h">2083</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lease = { user =&gt; $user-&gt;wikiName(),</td></tr>
<tr><td class="h">2084</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires =&gt; $t + $length,</td></tr>
<tr><td class="h">2085</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;taken =&gt; $t };</td></tr>
<tr><td class="h">2086</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2087</td><td colspan="6"></td></tr><tr><td class="h">2088</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;setLease( $lease );</td></tr>
<tr><td class="h">2089</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2090</td><td colspan="6"></td></tr><tr><td class="h">2091 - 2099</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod clearLease( $web, $topic )

Cancel the current lease.

See =getLease= for more details about Leases.

=cut</pre></td></tr>
<tr><td class="h">2100</td><td colspan="6"></td></tr><tr><td class="h">2101</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub clearLease {</td></tr>
<tr><td class="h">2102</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L2102">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web, $topic ) = @_;</td></tr>
<tr><td class="h">2103</td><td colspan="6"></td></tr><tr><td class="h">2104</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web, $topic );</td></tr>
<tr><td class="h">2105</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;setLease( undef );</td></tr>
<tr><td class="h">2106</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2107</td><td colspan="6"></td></tr><tr><td class="h">2108 - 2115</td><td colspan="5"></td><td class="s"><pre>=pod

---++ ObjectMethod removeSpuriousLeases( $web )

Remove leases that are not related to a topic. These can get left behind in
some store implementations when a topic is created, but never saved.

=cut</pre></td></tr>
<tr><td class="h">2116</td><td colspan="6"></td></tr><tr><td class="h">2117</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub removeSpuriousLeases {</td></tr>
<tr><td class="h">2118</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Store-pm--subroutine.html#L2118">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $this, $web ) = @_;</td></tr>
<tr><td class="h">2119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $handler = $this-&gt;_getHandler( $web );</td></tr>
<tr><td class="h">2120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$handler-&gt;removeSpuriousLeases();</td></tr>
<tr><td class="h">2121</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2122</td><td colspan="6"></td></tr><tr><td class="h">2123</td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
<tr><td class="h">2124</td><td colspan="6"></td></tr></table>
</body>
</html>
