<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: /usr/share/perl5/TWiki/Plugins/WysiwygPlugin.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">/usr/share/perl5/TWiki/Plugins/WysiwygPlugin.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">17.3%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Copyright (C) 2005 ILOG http://www.ilog.fr</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td class="s"># and TWiki Contributors. All Rights Reserved. TWiki Contributors</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td class="s"># are listed in the AUTHORS file in the root of this distribution.</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td class="s"># NOTE: Please extend that file, not this notice.</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">6</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is free software; you can redistribute it and/or</td></tr>
<tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td class="s"># modify it under the terms of the GNU General Public License</td></tr>
<tr><td class="h">8</td><td></td><td></td><td></td><td></td><td></td><td class="s"># as published by the Free Software Foundation; either version 2</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td class="s"># of the License, or (at your option) any later version. For</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td class="s"># more details read LICENSE in the root of the TWiki distribution.</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is distributed in the hope that it will be useful,</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td class="s"># but WITHOUT ANY WARRANTY; without even the implied warranty of</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td class="s"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td class="s"># As per the GPL, removal of this notice is prohibited.</td></tr>
<tr><td class="h">17</td><td colspan="6"></td></tr><tr><td class="h">18 - 49</td><td colspan="5"></td><td class="s"><pre>=pod

---+ package WysiwygPlugin

This plugin is responsible for translating TML to HTML before an edit starts
and translating the resultant HTML back into TML.
The flow of control is as follows:
   1 User hits &quot;edit&quot;
   2 if the skin is WYWIWYGPLUGIN_WYWIWYGSKIN, the beforeEditHandler
      filters the edit
   3 The &#39;edit&#39; template is instantiated with all the js and css
   4 editor invokes view URL with the &#39;wysiwyg_edit=1&#39; parameter to
     obtain the clean document
      * The earliest possible handler is implemented by the plugin in this
        mode. This handler formats the text and then saves it so the rest
        of twiki rendering can&#39;t do anything to it. At the end of rendering
        it drops the saved text back in.
   5 User edits
   6 editor saves by posting to &#39;save&#39; with the &#39;wysiwyg_edit=1&#39; parameter
   7 the beforeSaveHandler sees this and converts the HTML back to tml
Note: In the case of a new topic, you might expect to see the &quot;create topic&quot;
screen in the editor when it goesback to twiki for the topic content. This
doesn&#39;t happen because the earliest possible handler is called on the topic
content and not the template. The template is effectively ignored and a blank
document is sent to the editor.

Attachment uploads can be handled by URL requests from the editor to the TWiki
upload script. If these uploads are done in an IFRAME, then the redirect at
the end of the upload is done in the IFRAME and the user doesn&#39;t see the
upload screens. This avoids the need to add any scripts to the bin dir.

=cut</pre></td></tr>
<tr><td class="h">50</td><td colspan="6"></td></tr><tr><td class="h">51</td><td></td><td></td><td></td><td></td><td></td><td class="s">package TWiki::Plugins::WysiwygPlugin;</td></tr>
<tr><td class="h">52</td><td colspan="6"></td></tr><tr><td class="h">53</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L53">1</a></div></td><td><div>5</div><div>3</div><div>6</div></td><td class="s">use CGI qw( -any );</td></tr>
<tr><td class="h">54</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L54">1</a></div></td><td><div>6</div><div>3</div><div>5</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">55</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L55">1</a></div></td><td><div>7</div><div>2</div><div>5</div></td><td class="s">use TWiki::Func;</td></tr>
<tr><td class="h">56</td><td colspan="6"></td></tr><tr><td class="h">57</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L57">1</a></div></td><td><div>6</div><div>3</div><div>5</div></td><td class="s">use vars qw( $VERSION $RELEASE $MODERN $SKIN $SHORTDESCRIPTION );</td></tr>
<tr><td class="h">58</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L58">1</a></div></td><td><div>6</div><div>3</div><div>5</div></td><td class="s">use vars qw( $html2tml $tml2html $recursionBlock $imgMap $cairoCalled );</td></tr>
<tr><td class="h">59</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L59">1</a></div></td><td><div>6</div><div>3</div><div>4</div></td><td class="s">use vars qw( %TWikiCompatibility @refs );</td></tr>
<tr><td class="h">60</td><td colspan="6"></td></tr><tr><td class="h">61</td><td></td><td></td><td></td><td></td><td></td><td class="s">$SHORTDESCRIPTION = &#39;Translator framework for Wysiwyg editors&#39;;</td></tr>
<tr><td class="h">62</td><td colspan="6"></td></tr><tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td class="s">$VERSION = &#39;$Rev: 12422 $&#39;;</td></tr>
<tr><td class="h">64</td><td colspan="6"></td></tr><tr><td class="h">65</td><td></td><td></td><td></td><td></td><td></td><td class="s">$RELEASE = &#39;Dakar&#39;;</td></tr>
<tr><td class="h">66</td><td colspan="6"></td></tr><tr><td class="h">67</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub initPlugin {</td></tr>
<tr><td class="h">68</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L68">1</a></div></td><td><div>6</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $topic, $web, $user, $installWeb ) = @_;</td></tr>
<tr><td class="h">69</td><td colspan="6"></td></tr><tr><td class="h">70</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L70">50</a></div></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( defined( &amp;TWiki::Func::normalizeWebTopicName )) {</td></tr>
<tr><td class="h">71</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>3</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$MODERN = 1;</td></tr>
<tr><td class="h">72</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">73</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: nasty global var needed for Cairo</td></tr>
<tr><td class="h">74</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cairoCalled = 0;</td></tr>
<tr><td class="h">75</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">76</td><td colspan="6"></td></tr><tr><td class="h">77</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$SKIN = TWiki::Func::getPreferencesValue( &#39;WYSIWYGPLUGIN_WYSIWYGSKIN&#39; );</td></tr>
<tr><td class="h">78</td><td colspan="6"></td></tr><tr><td class="h">79</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# %OWEB%.%OTOPIC% is the topic where the initial content should be</td></tr>
<tr><td class="h">80</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# grabbed from, as defined in templates/edit.skin.tmpl</td></tr>
<tr><td class="h">81</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;TWiki::Func::registerTagHandler(&#39;OWEB&#39;,\&amp;_OWEBTAG);</td></tr>
<tr><td class="h">82</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;TWiki::Func::registerTagHandler(&#39;OTOPIC&#39;,\&amp;_OTOPICTAG);</td></tr>
<tr><td class="h">83</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;TWiki::Func::registerTagHandler(&#39;WYSIWYG_TEXT&#39;,\&amp;_WYSIWYG_TEXT);</td></tr>
<tr><td class="h">84</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;TWiki::Func::registerTagHandler(&#39;JAVASCRIPT_TEXT&#39;,\&amp;_JAVASCRIPT_TEXT);</td></tr>
<tr><td class="h">85</td><td colspan="6"></td></tr><tr><td class="h">86</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Plugin correctly initialized</td></tr>
<tr><td class="h">87</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td><div>4</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">88</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">89</td><td colspan="6"></td></tr><tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _OWEBTAG {</td></tr>
<tr><td class="h">91</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L91">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my($session, $params, $theTopic, $theWeb) = @_;</td></tr>
<tr><td class="h">92</td><td colspan="6"></td></tr><tr><td class="h">93</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $query = TWiki::Func::getCgiQuery();</td></tr>
<tr><td class="h">94</td><td colspan="6"></td></tr><tr><td class="h">95</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L95">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$theWeb&quot; unless $query;</td></tr>
<tr><td class="h">96</td><td colspan="6"></td></tr><tr><td class="h">97</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L97">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if(defined($query-&gt;param(&#39;templatetopic&#39;))) {</td></tr>
<tr><td class="h">98</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @split=split(/\./,$query-&gt;param(&#39;templatetopic&#39;));</td></tr>
<tr><td class="h">99</td><td colspan="6"></td></tr><tr><td class="h">100</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L100">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($#split==0) {</td></tr>
<tr><td class="h">101</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $theWeb;</td></tr>
<tr><td class="h">102</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">103</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $split[0];</td></tr>
<tr><td class="h">104</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">105</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">106</td><td colspan="6"></td></tr><tr><td class="h">107</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $theWeb;</td></tr>
<tr><td class="h">108</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">109</td><td colspan="6"></td></tr><tr><td class="h">110</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _OTOPICTAG {</td></tr>
<tr><td class="h">111</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L111">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my($session, $params, $theTopic, $theWeb) = @_;</td></tr>
<tr><td class="h">112</td><td colspan="6"></td></tr><tr><td class="h">113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $query = TWiki::Func::getCgiQuery();</td></tr>
<tr><td class="h">114</td><td colspan="6"></td></tr><tr><td class="h">115</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L115">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$theTopic&quot; unless $query;</td></tr>
<tr><td class="h">116</td><td colspan="6"></td></tr><tr><td class="h">117</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L117">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if(defined($query-&gt;param(&#39;templatetopic&#39;))) {</td></tr>
<tr><td class="h">118</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @split=split(/\./,$query-&gt;param(&#39;templatetopic&#39;));</td></tr>
<tr><td class="h">119</td><td colspan="6"></td></tr><tr><td class="h">120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $split[$#split];</td></tr>
<tr><td class="h">121</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">122</td><td colspan="6"></td></tr><tr><td class="h">123</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $theTopic;</td></tr>
<tr><td class="h">124</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">125</td><td colspan="6"></td></tr><tr><td class="h">126</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This handler is used to determine whether the topic is editable by</td></tr>
<tr><td class="h">127</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Wysiwyg or not. The only thing it does is to redirect to a normal edit</td></tr>
<tr><td class="h">128</td><td></td><td></td><td></td><td></td><td></td><td class="s"># url if the skin is set to $SKIN and nasty content is found.</td></tr>
<tr><td class="h">129</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub beforeEditHandler {</td></tr>
<tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#my( $text, $topic, $web, $meta ) = @_;</td></tr>
<tr><td class="h">131</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L131">0</a></div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L131">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $SKIN;</td></tr>
<tr><td class="h">132</td><td colspan="6"></td></tr><tr><td class="h">133</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L133">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( TWiki::Func::getSkin() =~ /\b$SKIN\b/o ) {</td></tr>
<tr><td class="h">134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $exclusions = TWiki::Func::getPreferencesValue(</td></tr>
<tr><td class="h">135</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;WYSIWYG_EXCLUDE&#39; );</td></tr>
<tr><td class="h">136</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $calls_ok = TWiki::Func::getPreferencesValue(</td></tr>
<tr><td class="h">137</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;WYSIWYG_EDITABLE_CALLS&#39; );</td></tr>
<tr><td class="h">138</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L138">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless $exclusions;</td></tr>
<tr><td class="h">139</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $not_ok = 0;</td></tr>
<tr><td class="h">140</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L140">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L140">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $exclusions =~ /calls/</td></tr>
<tr><td class="h">141</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; $_[0] =~ /%((?!($calls_ok){)[A-Z_]+{.*?})%/s ) {</td></tr>
<tr><td class="h">142</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;WYSIWYG_DEBUG: has calls $1\n&quot;;</td></tr>
<tr><td class="h">143</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$not_ok = 1;</td></tr>
<tr><td class="h">144</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">145</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L145">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L145">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $exclusions =~ /variables/ &amp;&amp; $_[0] =~ /%([A-Z_]+)%/s ) {</td></tr>
<tr><td class="h">146</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;$exclusions WYSIWYG_DEBUG: has variables $1\n&quot;;</td></tr>
<tr><td class="h">147</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$not_ok = 1;</td></tr>
<tr><td class="h">148</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">149</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L149">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L149">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $exclusions =~ /html/ &amp;&amp;</td></tr>
<tr><td class="h">150</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_[0] =~ /&lt;\/?((?!literal|verbatim|noautolink|nop|br)\w+)/ ) {</td></tr>
<tr><td class="h">151</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;WYSIWYG_DEBUG: has html: $1\n&quot;;</td></tr>
<tr><td class="h">152</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$not_ok = 1;</td></tr>
<tr><td class="h">153</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">154</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L154">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L154">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $exclusions =~ /comments/ &amp;&amp; $_[0] =~ /&lt;[!]--/ ) {</td></tr>
<tr><td class="h">155</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;WYSIWYG_DEBUG: has comments\n&quot;;</td></tr>
<tr><td class="h">156</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$not_ok = 1;</td></tr>
<tr><td class="h">157</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">158</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L158">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L158">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $exclusions =~ /pre/ &amp;&amp; $_[0] =~ /&lt;pre\w/ ) {</td></tr>
<tr><td class="h">159</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;WYSIWYG_DEBUG: has pre\n&quot;;</td></tr>
<tr><td class="h">160</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$not_ok = 1;</td></tr>
<tr><td class="h">161</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">162</td><td colspan="6"></td></tr><tr><td class="h">163</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L163">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $not_ok ) {</td></tr>
<tr><td class="h">164</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# redirect</td></tr>
<tr><td class="h">165</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $query = TWiki::Func::getCgiQuery();</td></tr>
<tr><td class="h">166</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $p qw( skin cover ) {</td></tr>
<tr><td class="h">167</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $arg = $query-&gt;param( $p );</td></tr>
<tr><td class="h">168</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L168">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L168">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $arg &amp;&amp; $arg =~ s/\b$SKIN\b//o ) {</td></tr>
<tr><td class="h">169</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L169">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $arg =~ /^[\s,]*$/ ) {</td></tr>
<tr><td class="h">170</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query-&gt;delete( $p );</td></tr>
<tr><td class="h">171</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">172</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query-&gt;param( -name=&gt;$p, -value=&gt;$arg );</td></tr>
<tr><td class="h">173</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">174</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">175</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $url = $query-&gt;url( -full=&gt;1, -path=&gt;1, -query=&gt;1 );</td></tr>
<tr><td class="h">177</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TWiki::Func::redirectCgiQuery( $query, $url );</td></tr>
<tr><td class="h">178</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Bring this session to an untimely end</td></tr>
<tr><td class="h">179</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit 0;</td></tr>
<tr><td class="h">180</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">181</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">182</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">183</td><td colspan="6"></td></tr><tr><td class="h">184</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Invoked when the selected skin is in use to convert HTML to</td></tr>
<tr><td class="h">185</td><td></td><td></td><td></td><td></td><td></td><td class="s"># TML (best offorts)</td></tr>
<tr><td class="h">186</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub beforeSaveHandler {</td></tr>
<tr><td class="h">187</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#my( $text, $topic, $web ) = @_;</td></tr>
<tr><td class="h">188</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L188">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $query = TWiki::Func::getCgiQuery();</td></tr>
<tr><td class="h">189</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L189">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $query;</td></tr>
<tr><td class="h">190</td><td colspan="6"></td></tr><tr><td class="h">191</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L191">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless defined( $query-&gt;param( &#39;wysiwyg_edit&#39; ));</td></tr>
<tr><td class="h">192</td><td colspan="6"></td></tr><tr><td class="h">193</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L193">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $html2tml ) {</td></tr>
<tr><td class="h">194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require TWiki::Plugins::WysiwygPlugin::HTML2TML;</td></tr>
<tr><td class="h">195</td><td colspan="6"></td></tr><tr><td class="h">196</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$html2tml = new TWiki::Plugins::WysiwygPlugin::HTML2TML();</td></tr>
<tr><td class="h">197</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">198</td><td colspan="6"></td></tr><tr><td class="h">199</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @rescue;</td></tr>
<tr><td class="h">200</td><td colspan="6"></td></tr><tr><td class="h">201</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: really, really bad smell; bloody core should NOT pass text</td></tr>
<tr><td class="h">202</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# with embedded meta to plugins! It is VERY BAD DESIGN!!!</td></tr>
<tr><td class="h">203</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$_[0] =~ s/^(%META:[A-Z]+{.*?}%)\s*$/push(@rescue,$1);&#39;&lt;!--META_&#39;.</td></tr>
<tr><td class="h">204</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scalar(@rescue).&#39;_META--&gt;&#39;/gem;</td></tr>
<tr><td class="h">205</td><td colspan="6"></td></tr><tr><td class="h">206</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L206">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $MODERN ) {</td></tr>
<tr><td class="h">207</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# undo the munging that has already been done (grrrrrrrrrr!!!!)</td></tr>
<tr><td class="h">208</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_[0] =~ s/\t/   /g;</td></tr>
<tr><td class="h">209</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">210</td><td colspan="6"></td></tr><tr><td class="h">211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = {</td></tr>
<tr><td class="h">212</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;web =&gt; $_[2],</td></tr>
<tr><td class="h">213</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topic =&gt; $_[1],</td></tr>
<tr><td class="h">214</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convertImage =&gt; \&amp;convertImage,</td></tr>
<tr><td class="h">215</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewriteURL =&gt; \&amp;postConvertURL,</td></tr>
<tr><td class="h">216</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;very_clean =&gt; 1, # aggressively polish saved HTML</td></tr>
<tr><td class="h">217</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">218</td><td colspan="6"></td></tr><tr><td class="h">219</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Let&#39;s just set this and see what happens....</td></tr>
<tr><td class="h">220</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{very_clean} = 1;</td></tr>
<tr><td class="h">221</td><td colspan="6"></td></tr><tr><td class="h">222</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$_[0] = $html2tml-&gt;convert( $_[0], $opts );</td></tr>
<tr><td class="h">223</td><td colspan="6"></td></tr><tr><td class="h">224</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L224">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $MODERN ) {</td></tr>
<tr><td class="h">225</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# redo the munging</td></tr>
<tr><td class="h">226</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_[0] =~ s/   /\t/g;</td></tr>
<tr><td class="h">227</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">228</td><td colspan="6"></td></tr><tr><td class="h">229</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$_[0] =~ s/\n&lt;!--META_(\d+)_META--&gt;/\n$rescue[$1-1]/gs;</td></tr>
<tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Add a newline if one has been eaten</td></tr>
<tr><td class="h">231</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$_[0] =~ s/&lt;!--META_(\d+)_META--&gt;/\n$rescue[$1-1]/g;</td></tr>
<tr><td class="h">232</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">233</td><td colspan="6"></td></tr><tr><td class="h">234</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Handler used to process text in a =view= URL to generate text/html</td></tr>
<tr><td class="h">235</td><td></td><td></td><td></td><td></td><td></td><td class="s"># containing the HTML of the topic to be edited.</td></tr>
<tr><td class="h">236</td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">237</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Invoked when the selected skin is in use to convert the text to HTML</td></tr>
<tr><td class="h">238</td><td></td><td></td><td></td><td></td><td></td><td class="s"># We can&#39;t use the beforeEditHandler, because the editor loads up and then</td></tr>
<tr><td class="h">239</td><td></td><td></td><td></td><td></td><td></td><td class="s"># uses a URL to fetch the text to be edited. This handler is designed to</td></tr>
<tr><td class="h">240</td><td></td><td></td><td></td><td></td><td></td><td class="s"># provide the text for that request. It&#39;s a real struggle, because the</td></tr>
<tr><td class="h">241</td><td></td><td></td><td></td><td></td><td></td><td class="s"># commonTagsHandler is called so many times that getting the right</td></tr>
<tr><td class="h">242</td><td></td><td></td><td></td><td></td><td></td><td class="s"># call is hard, and then preventing a repeat call is harder!</td></tr>
<tr><td class="h">243</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub beforeCommonTagsHandler {</td></tr>
<tr><td class="h">244</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#my ( $text, $topic, $web )</td></tr>
<tr><td class="h">245</td><td><div class="c3">16</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L245">50</a></div></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L245">16</a></div></td><td><div>86</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $recursionBlock;</td></tr>
<tr><td class="h">246</td><td><div class="c3">16</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L246">50</a></div></td><td></td><td></td><td><div>72</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $MODERN ) {</td></tr>
<tr><td class="h">247</td><td><div class="c3">16</div></td><td><div class="c3" title="T/F"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L247">100</a></div></td><td></td><td></td><td><div>83</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless TWiki::Func::getContext()-&gt;{body_text};</td></tr>
<tr><td class="h">248</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">249</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# DANGEROUS SMELL: only way to tell what we are processing is</td></tr>
<tr><td class="h">250</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the order of the calls to commonTagsHandler - the first call after</td></tr>
<tr><td class="h">251</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# initPlugin is the body text in Cairo. We only want to process the</td></tr>
<tr><td class="h">252</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# body text.</td></tr>
<tr><td class="h">253</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L253">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return if( $cairoCalled );</td></tr>
<tr><td class="h">254</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cairoCalled = 1;</td></tr>
<tr><td class="h">255</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">256</td><td colspan="6"></td></tr><tr><td class="h">257</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td><div>59</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $query = TWiki::Func::getCgiQuery();</td></tr>
<tr><td class="h">258</td><td colspan="6"></td></tr><tr><td class="h">259</td><td><div class="c3">13</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L259">50</a></div></td><td></td><td></td><td><div>60</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $query;</td></tr>
<tr><td class="h">260</td><td colspan="6"></td></tr><tr><td class="h">261</td><td><div class="c3">13</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L261">50</a></div></td><td></td><td></td><td><div>91</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless defined( $query-&gt;param( &#39;wysiwyg_edit&#39; ));</td></tr>
<tr><td class="h">262</td><td colspan="6"></td></tr><tr><td class="h">263</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# stop it from processing the template without expanded</td></tr>
<tr><td class="h">264</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# %TEXT% (grr; we need a better way to tell where we</td></tr>
<tr><td class="h">265</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# are in the processing pipeline)</td></tr>
<tr><td class="h">266</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L266">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if( $_[0] =~ /^&lt;!-- WysiwygPlugin Template/ );</td></tr>
<tr><td class="h">267</td><td colspan="6"></td></tr><tr><td class="h">268</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Have to re-read the topic because verbatim blocks have already been</td></tr>
<tr><td class="h">269</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# lifted out, and we need them.</td></tr>
<tr><td class="h">270</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $topic = $_[1];</td></tr>
<tr><td class="h">271</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $web = $_[2];</td></tr>
<tr><td class="h">272</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $meta, $text );</td></tr>
<tr><td class="h">273</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $altText = $query-&gt;param( &#39;templatetopic&#39; );</td></tr>
<tr><td class="h">274</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L274">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L274">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $altText &amp;&amp; TWiki::Func::topicExists( $web, $altText )) {</td></tr>
<tr><td class="h">275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $web, $topic ) = TWiki::Func::normalizeWebTopicName( $web, $altText );</td></tr>
<tr><td class="h">276</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">277</td><td colspan="6"></td></tr><tr><td class="h">278</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$_[0] = _WYSIWYG_TEXT($TWiki::Plugins::SESSION, {}, $topic, $web);</td></tr>
<tr><td class="h">279</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">280</td><td colspan="6"></td></tr><tr><td class="h">281</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Handler used by editors that require pre-prepared HTML embedded in the</td></tr>
<tr><td class="h">282</td><td></td><td></td><td></td><td></td><td></td><td class="s"># edit template.</td></tr>
<tr><td class="h">283</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _WYSIWYG_TEXT {</td></tr>
<tr><td class="h">284</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L284">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($session, $params, $topic, $web) = @_;</td></tr>
<tr><td class="h">285</td><td colspan="6"></td></tr><tr><td class="h">286</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Have to re-read the topic because content has already been munged</td></tr>
<tr><td class="h">287</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# by other plugins, or by the extraction of verbatim blocks.</td></tr>
<tr><td class="h">288</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $meta, $text ) = TWiki::Func::readTopic( $web, $topic );</td></tr>
<tr><td class="h">289</td><td colspan="6"></td></tr><tr><td class="h">290</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Translate the topic text to pure HTML.</td></tr>
<tr><td class="h">291</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L291">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $tml2html ) {</td></tr>
<tr><td class="h">292</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require TWiki::Plugins::WysiwygPlugin::TML2HTML;</td></tr>
<tr><td class="h">293</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tml2html = new TWiki::Plugins::WysiwygPlugin::TML2HTML();</td></tr>
<tr><td class="h">294</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">295</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$text = $tml2html-&gt;convert(</td></tr>
<tr><td class="h">296</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text,</td></tr>
<tr><td class="h">297</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">298</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;web =&gt; $web,</td></tr>
<tr><td class="h">299</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topic =&gt; $topic,</td></tr>
<tr><td class="h">300</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getViewUrl =&gt; \&amp;getViewUrl,</td></tr>
<tr><td class="h">301</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expandVarsInURL =&gt; \&amp;expandVarsInURL,</td></tr>
<tr><td class="h">302</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">303</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">304</td><td colspan="6"></td></tr><tr><td class="h">305</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Lift out the text to protect it from further TWiki rendering. It will be</td></tr>
<tr><td class="h">306</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# put back in the postRenderingHandler.</td></tr>
<tr><td class="h">307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return _liftOut( $text );</td></tr>
<tr><td class="h">308</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">309</td><td colspan="6"></td></tr><tr><td class="h">310</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Handler used to present the editable text in a javascript constant string</td></tr>
<tr><td class="h">311</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _JAVASCRIPT_TEXT {</td></tr>
<tr><td class="h">312</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L312">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($session, $params, $topic, $web) = @_;</td></tr>
<tr><td class="h">313</td><td colspan="6"></td></tr><tr><td class="h">314</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $html = _dropBack( _WYSIWYG_TEXT( @_ ));</td></tr>
<tr><td class="h">315</td><td colspan="6"></td></tr><tr><td class="h">316</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$html =~ s/([\\&#39;])/\\$1/sg;</td></tr>
<tr><td class="h">317</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$html =~ s/\r/\\r/sg;</td></tr>
<tr><td class="h">318</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$html =~ s/\n/\\n/sg;</td></tr>
<tr><td class="h">319</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$html =~ s/script/scri&#39;+&#39;pt/g;</td></tr>
<tr><td class="h">320</td><td colspan="6"></td></tr><tr><td class="h">321</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return _liftOut( &quot;&#39;$html&#39;&quot; );</td></tr>
<tr><td class="h">322</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">323</td><td colspan="6"></td></tr><tr><td class="h">324</td><td></td><td></td><td></td><td></td><td></td><td class="s"># DEPRECATED in Dakar (postRenderingHandler does the job better)</td></tr>
<tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This handler is required to re-insert blocks that were removed to protect</td></tr>
<tr><td class="h">326</td><td></td><td></td><td></td><td></td><td></td><td class="s"># them from TWiki rendering, such as TWiki variables.</td></tr>
<tr><td class="h">327</td><td></td><td></td><td></td><td></td><td></td><td class="s">$TWikiCompatibility{endRenderingHandler} = 1.1;</td></tr>
<tr><td class="h">328</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub endRenderingHandler {</td></tr>
<tr><td class="h">329</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L329">0</a></div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return postRenderingHandler( @_ );</td></tr>
<tr><td class="h">330</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">331</td><td colspan="6"></td></tr><tr><td class="h">332</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Dakar handler, replaces endRenderingHandler above</td></tr>
<tr><td class="h">333</td><td></td><td></td><td></td><td></td><td></td><td class="s"># This handler is required to re-insert blocks that were removed to protect</td></tr>
<tr><td class="h">334</td><td></td><td></td><td></td><td></td><td></td><td class="s"># them from TWiki rendering, such as TWiki variables.</td></tr>
<tr><td class="h">335</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub postRenderingHandler {</td></tr>
<tr><td class="h">336</td><td><div class="c3">3</div></td><td><div class="c0" title="T/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L336">50</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L336">33</a></div></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L336">3</a></div></td><td><div>42</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if( $recursionBlock || !$tml2html );</td></tr>
<tr><td class="h">337</td><td colspan="6"></td></tr><tr><td class="h">338</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Replace protected content.</td></tr>
<tr><td class="h">339</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$_[0] = _dropBack($_[0]);</td></tr>
<tr><td class="h">340</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">341</td><td colspan="6"></td></tr><tr><td class="h">342</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Commented out because of Bugs:Item1176</td></tr>
<tr><td class="h">343</td><td></td><td></td><td></td><td></td><td></td><td class="s"># DEPRECATED in Dakar (modifyHeaderHandler does the job better)</td></tr>
<tr><td class="h">344</td><td></td><td></td><td></td><td></td><td></td><td class="s">#$TWikiCompatibility{writeHeaderHandler} = 1.1;</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td class="s">#sub writeHeaderHandler {</td></tr>
<tr><td class="h">346</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    my $query = shift;</td></tr>
<tr><td class="h">347</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    if( $query-&gt;param( &#39;wysiwyg_edit&#39; )) {</td></tr>
<tr><td class="h">348</td><td></td><td></td><td></td><td></td><td></td><td class="s">#        return &quot;Expires: 0\nCache-control: max-age=0, must-revalidate&quot;;</td></tr>
<tr><td class="h">349</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    }</td></tr>
<tr><td class="h">350</td><td></td><td></td><td></td><td></td><td></td><td class="s">#    return &#39;&#39;;</td></tr>
<tr><td class="h">351</td><td></td><td></td><td></td><td></td><td></td><td class="s">#}</td></tr>
<tr><td class="h">352</td><td colspan="6"></td></tr><tr><td class="h">353</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Dakar modify headers.</td></tr>
<tr><td class="h">354</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub modifyHeaderHandler {</td></tr>
<tr><td class="h">355</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L355">1</a></div></td><td><div>5</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $headers, $query ) = @_;</td></tr>
<tr><td class="h">356</td><td colspan="6"></td></tr><tr><td class="h">357</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L357">50</a></div></td><td></td><td></td><td><div>7</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $query-&gt;param( &#39;wysiwyg_edit&#39; )) {</td></tr>
<tr><td class="h">358</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers-&gt;{Expires} = 0;</td></tr>
<tr><td class="h">359</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers-&gt;{&#39;Cache-control&#39;} = &#39;max-age=0, must-revalidate&#39;;</td></tr>
<tr><td class="h">360</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">361</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">362</td><td colspan="6"></td></tr><tr><td class="h">363</td><td></td><td></td><td></td><td></td><td></td><td class="s"># callback passed to the TML2HTML convertor</td></tr>
<tr><td class="h">364</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getViewUrl {</td></tr>
<tr><td class="h">365</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L365">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $web, $topic ) = @_;</td></tr>
<tr><td class="h">366</td><td colspan="6"></td></tr><tr><td class="h">367</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the Cairo documentation says getViewUrl defaults the web. It doesn&#39;t.</td></tr>
<tr><td class="h">368</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L368">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( defined $TWiki::Plugins::SESSION ) {</td></tr>
<tr><td class="h">369</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L369">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$web ||= $TWiki::webName;</td></tr>
<tr><td class="h">370</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">371</td><td colspan="6"></td></tr><tr><td class="h">372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return TWiki::Func::getViewUrl( $web, $topic );</td></tr>
<tr><td class="h">373</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">374</td><td colspan="6"></td></tr><tr><td class="h">375</td><td></td><td></td><td></td><td></td><td></td><td class="s"># The subset of vars for which bidirection transformation is supported</td></tr>
<tr><td class="h">376</td><td></td><td></td><td></td><td></td><td></td><td class="s"># in URLs only</td></tr>
<tr><td class="h">377</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L377">1</a></div></td><td><div>7</div><div>3</div><div>4</div></td><td class="s">use vars qw( @VARS );</td></tr>
<tr><td class="h">378</td><td colspan="6"></td></tr><tr><td class="h">379</td><td></td><td></td><td></td><td></td><td></td><td class="s"># The set of variables that get &quot;special treatment&quot; in URLs</td></tr>
<tr><td class="h">380</td><td></td><td></td><td></td><td></td><td></td><td class="s">@VARS = (</td></tr>
<tr><td class="h">381</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%ATTACHURL%&#39;,</td></tr>
<tr><td class="h">382</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%ATTACHURLPATH%&#39;,</td></tr>
<tr><td class="h">383</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%PUBURL%&#39;,</td></tr>
<tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%PUBURLPATH%&#39;,</td></tr>
<tr><td class="h">385</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%SCRIPTURLPATH{&quot;view&quot;}%&#39;,</td></tr>
<tr><td class="h">386</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%SCRIPTURLPATH%&#39;,</td></tr>
<tr><td class="h">387</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%SCRIPTURL{&quot;view&quot;}%&#39;,</td></tr>
<tr><td class="h">388</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%SCRIPTURL%&#39;,</td></tr>
<tr><td class="h">389</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;%SCRIPTSUFFIX%&#39;, # bit dodgy, this one</td></tr>
<tr><td class="h">390</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">391</td><td colspan="6"></td></tr><tr><td class="h">392</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Initialises the mapping from var to URL and back</td></tr>
<tr><td class="h">393</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _populateVars {</td></tr>
<tr><td class="h">394</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L394">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = shift;</td></tr>
<tr><td class="h">395</td><td colspan="6"></td></tr><tr><td class="h">396</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L396">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if( $opts-&gt;{exp} );</td></tr>
<tr><td class="h">397</td><td colspan="6"></td></tr><tr><td class="h">398</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;local $recursionBlock = 1; # block calls to beforeCommonTagshandler</td></tr>
<tr><td class="h">399</td><td colspan="6"></td></tr><tr><td class="h">400</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @exp = split(</td></tr>
<tr><td class="h">401</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\0/, TWiki::Func::expandCommonVariables(</td></tr>
<tr><td class="h">402</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join(&quot;\0&quot;, @VARS), $opts-&gt;{topic}, $opts-&gt;{web} ));</td></tr>
<tr><td class="h">403</td><td colspan="6"></td></tr><tr><td class="h">404</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for my $i (0..$#VARS) {</td></tr>
<tr><td class="h">405</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $nvar = $VARS[$i];</td></tr>
<tr><td class="h">406</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L406">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($opts-&gt;{markvars}) {</td></tr>
<tr><td class="h">407</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# SMELL: this is clunky.... but the markvars transformation has</td></tr>
<tr><td class="h">408</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# already happened by the time this is used.</td></tr>
<tr><td class="h">409</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nvar =~ s/^%(.*)%$/CGI::span({class=&gt;&quot;TMLvariable&quot;}, $1)/e;</td></tr>
<tr><td class="h">410</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{match}[$i] = $nvar;</td></tr>
<tr><td class="h">412</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L412">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$exp[$i] ||= &#39;&#39;;</td></tr>
<tr><td class="h">413</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">414</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{exp} = \@exp;</td></tr>
<tr><td class="h">415</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">416</td><td colspan="6"></td></tr><tr><td class="h">417</td><td></td><td></td><td></td><td></td><td></td><td class="s"># callback passed to the TML2HTML convertor on each</td></tr>
<tr><td class="h">418</td><td></td><td></td><td></td><td></td><td></td><td class="s"># variable in a URL used in a square bracketed link</td></tr>
<tr><td class="h">419</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub expandVarsInURL {</td></tr>
<tr><td class="h">420</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L420">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $url, $opts ) = @_;</td></tr>
<tr><td class="h">421</td><td colspan="6"></td></tr><tr><td class="h">422</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L422">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39; unless $url;</td></tr>
<tr><td class="h">423</td><td colspan="6"></td></tr><tr><td class="h">424</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;_populateVars( $opts );</td></tr>
<tr><td class="h">425</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for my $i (0..$#VARS) {</td></tr>
<tr><td class="h">426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url =~ s/$opts-&gt;{match}[$i]/$opts-&gt;{exp}-&gt;[$i]/g;</td></tr>
<tr><td class="h">427</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $url;</td></tr>
<tr><td class="h">429</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">430</td><td colspan="6"></td></tr><tr><td class="h">431</td><td></td><td></td><td></td><td></td><td></td><td class="s"># callback passed to the HTML2TML convertor</td></tr>
<tr><td class="h">432</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub postConvertURL {</td></tr>
<tr><td class="h">433</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L433">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $url, $opts ) = @_;</td></tr>
<tr><td class="h">434</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#my $orig = $url; #debug</td></tr>
<tr><td class="h">435</td><td colspan="6"></td></tr><tr><td class="h">436</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;local $recursionBlock = 1; # block calls to beforeCommonTagshandler</td></tr>
<tr><td class="h">437</td><td colspan="6"></td></tr><tr><td class="h">438</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $anchor = &#39;&#39;;</td></tr>
<tr><td class="h">439</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L439">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $url =~ s/(#.*)$// ) {</td></tr>
<tr><td class="h">440</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$anchor = $1;</td></tr>
<tr><td class="h">441</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">442</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parameters = &#39;&#39;;</td></tr>
<tr><td class="h">443</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L443">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if( $url =~ s/(\?.*)$// ) {</td></tr>
<tr><td class="h">444</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parameters = $1;</td></tr>
<tr><td class="h">445</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">446</td><td colspan="6"></td></tr><tr><td class="h">447</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;_populateVars( $opts );</td></tr>
<tr><td class="h">448</td><td colspan="6"></td></tr><tr><td class="h">449</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for my $i (0..$#VARS) {</td></tr>
<tr><td class="h">450</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L450">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $opts-&gt;{exp}-&gt;[$i];</td></tr>
<tr><td class="h">451</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url =~ s/^$opts-&gt;{exp}-&gt;[$i]/$VARS[$i]/;</td></tr>
<tr><td class="h">452</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">453</td><td colspan="6"></td></tr><tr><td class="h">454</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L454">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L454">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($url =~ m#^%SCRIPTURL(?:PATH)?(?:{&quot;view&quot;}%|%/view[^/]*)/(\w+)(?:/(\w+))?$# &amp;&amp; !$parameters) {</td></tr>
<tr><td class="h">455</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my( $web, $topic );</td></tr>
<tr><td class="h">456</td><td colspan="6"></td></tr><tr><td class="h">457</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L457">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $2 ) {</td></tr>
<tr><td class="h">458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($web, $topic) = ($1, $2);</td></tr>
<tr><td class="h">459</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">460</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$topic = $1;</td></tr>
<tr><td class="h">461</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">462</td><td colspan="6"></td></tr><tr><td class="h">463</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L463">0</a></div></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--condition.html#L463">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $web &amp;&amp; $web ne $opts-&gt;{web} ) {</td></tr>
<tr><td class="h">464</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;$orig -&gt; $web.$topic$anchor\n&quot;; #debug</td></tr>
<tr><td class="h">465</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $web.&#39;.&#39;.$topic.$anchor;</td></tr>
<tr><td class="h">466</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">467</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;$orig -&gt; $topic$anchor\n&quot;; #debug</td></tr>
<tr><td class="h">468</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $topic.$anchor;</td></tr>
<tr><td class="h">469</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">470</td><td colspan="6"></td></tr><tr><td class="h">471</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#print STDERR &quot;$orig -&gt; $url$anchor$parameters\n&quot;; #debug</td></tr>
<tr><td class="h">472</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $url.$anchor.$parameters;</td></tr>
<tr><td class="h">473</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">474</td><td colspan="6"></td></tr><tr><td class="h">475</td><td></td><td></td><td></td><td></td><td></td><td class="s"># callback used to convert an image reference into a TWiki variable</td></tr>
<tr><td class="h">476</td><td></td><td></td><td></td><td></td><td></td><td class="s"># callback passed to the HTML2TML convertor</td></tr>
<tr><td class="h">477</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub convertImage {</td></tr>
<tr><td class="h">478</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L478">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $x, $opts ) = @_;</td></tr>
<tr><td class="h">479</td><td colspan="6"></td></tr><tr><td class="h">480</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L480">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $x;</td></tr>
<tr><td class="h">481</td><td colspan="6"></td></tr><tr><td class="h">482</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;local $recursionBlock = 1; # block calls to beforeCommonTagshandler</td></tr>
<tr><td class="h">483</td><td colspan="6"></td></tr><tr><td class="h">484</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L484">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless( $imgMap ) {</td></tr>
<tr><td class="h">485</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$imgMap = {};</td></tr>
<tr><td class="h">486</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $imgs =</td></tr>
<tr><td class="h">487</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TWiki::Func::getPreferencesValue( &#39;WYSIWYGPLUGIN_ICONS&#39; );</td></tr>
<tr><td class="h">488</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L488">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $imgs ) {</td></tr>
<tr><td class="h">489</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while( $imgs =~ s/src=&quot;(.*?)&quot; alt=&quot;(.*?)&quot;// ) {</td></tr>
<tr><td class="h">490</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my( $src, $alt ) = ( $1, $2 );</td></tr>
<tr><td class="h">491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$src = TWiki::Func::expandCommonVariables(</td></tr>
<tr><td class="h">492</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$src, $opts-&gt;{topic}, $opts-&gt;{web} );</td></tr>
<tr><td class="h">493</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--branch.html#L493">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$alt .= &#39;%&#39; if $alt =~ /^%/;</td></tr>
<tr><td class="h">494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$imgMap-&gt;{$src} = $alt;</td></tr>
<tr><td class="h">495</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">496</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">497</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">498</td><td colspan="6"></td></tr><tr><td class="h">499</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $imgMap-&gt;{$x};</td></tr>
<tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">501</td><td colspan="6"></td></tr><tr><td class="h">502</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Replace content with a marker to prevent it being munged by TWiki</td></tr>
<tr><td class="h">503</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _liftOut {</td></tr>
<tr><td class="h">504</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L504">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $text ) = @_;</td></tr>
<tr><td class="h">505</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $n = scalar( @refs );</td></tr>
<tr><td class="h">506</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push( @refs, $text );</td></tr>
<tr><td class="h">507</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;\05$n\05&quot;;</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">509</td><td colspan="6"></td></tr><tr><td class="h">510</td><td></td><td></td><td></td><td></td><td></td><td class="s"># Substitute marker</td></tr>
<tr><td class="h">511</td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _dropBack {</td></tr>
<tr><td class="h">512</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="-usr-share-perl5-TWiki-Plugins-WysiwygPlugin-pm--subroutine.html#L512">0</a></div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my( $text) = @_;</td></tr>
<tr><td class="h">513</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Restore everything that was lifted out</td></tr>
<tr><td class="h">514</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while( $text =~ s/\05([0-9]+)\05/$refs[$1]/gi ) {</td></tr>
<tr><td class="h">515</td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">516</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $text;</td></tr>
<tr><td class="h">517</td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">518</td><td colspan="6"></td></tr><tr><td class="h">519</td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
