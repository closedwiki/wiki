%META:TOPICINFO{author="AntonioTerceiro" date="1120422474" format="1.0" version="1.10"}%
---+!! !TopicTranslationsPlugin

TopicTranslationsPlugin manages topics translations into several languages, by assigning suffixes
to topic names corresponding to known languages. TopicTranslationsPlugin also automatically
redirects users to the best available translation, based on the languages available and the
languages informed as acceptable by the user.


%TOC%

------

---++ Syntax Rules

Each web that is going to use TopicTranslationsPlugin must define a variable named
=%<nop/>TOPICTRANSLATIONS%=, which must contains a comma-delimited list of language
code. =%<nop/>TOPICTRANSLATIONS%= can be defined TWiki-wide, which means that those
languages will be used for the entire TWiki installation. It can also be defined
per user. If none of th above is set, the plugin setting for TopicTranslationsPlugin
with the same name (=%<nop/>TOPICTRANSLATIONS%=) will be used as a default.

For example:

<code>&nbsp;&nbsp;&nbsp;* Set TOPICTRANSLATIONS = pt-br, en, fr</code>

TopicTranslationsPlugin will then use suffixes in the topic names to "recognize"
each topic's translations. In the example above, the translations for, say,
=<nop/>SomeTopic=, will be the following:

	* =<nop/>SomeTopic= will be the original version (assumed to be written in =pt-br=)
	* =<nop/>SomeTopicEn= will be the 1<sup>st</sup> translation (in =en=)
	* =<nop/>SomeTopicFr= will be the 2<sup>nd</sup> translation (in =fr=)  

__Important:__ we'll assume that the first language listed in =%<nop/>TOPICTRANSLATIONS%=
is the default one. Thus, the topics with no language suffixes are assumed to be written in
that language.

Follows the plugin's available tags, along with examples of their usage.

---+++ =%<nop/>TRANSLATIONS{}%= 

List a topic's translations, even if they don't exist yet (so we can create them!)

Parameters for =%<nop/>TRANSLATIONS{}%= :

	* <code>"MyTopic"</code> or <code>topic="MyTopic"</code>: indicates the topic that must
	  have translations listed. Can be ="MyTopic"= or ="Web.MyTopic"=.
	  Defaults to the current topic.
	* <code>format="..."</code> : provides a custom formatting for the list of available translations.
	  This format will be used for each available language.
	  The following variables will be expanded in the format:
	  | =$language= | The language code for the current language. |
	  | =$topic= | The topic whose translations we are listing. |
	  | =$translation= | the topic corresponding to the current translation. |
	  | =$web= | the web containing the translations |
	  Defaults to ="[[$web.$translation]<nop/>[$language]]"=
	* =missingformat=: like =format=, but used for translations that were not written yet.
	  Supports the same variables as =format= and defaults to the same value of =format=.
	* <code>separator="..."</code> : text that will separate the items in the listing.
	  Defaults to =" "= (a space)
	* <code>which="..."</code>: controls which translations must be listed. Possible values are:
	  | =available= | lists only the available translations (i.e., those who *were already written*). |
	  | =missing= | lists only the missing translations (i.e., those who *weren't written yet*). |
	  | =all= | lists all the translations |
	  The default value is ="all"=.

---+++ =%<nop/>CURRENTLANGUAGE%=

The language detected for the current topic (based on the current topic's name suffix).

---+++=%<nop/>DEFAULTLANGUAGE%= 

The default language (i.e., the first of the listed in =%<nop/>TOPICTRANSLATIONS%=)

---+++ =%<nop/>INCLUDETRANSLATION{<nop/>SomeTopic}%=

Includes the translation of =<nop/>SomeTopic= that is in the same language as the current topic
(as detected based on current topic's name suffix)

Parameters =%<nop/>INCLUDETRANSLATION{}%= :

	* ="<nop/>MyTopic"= : include the suitable =<nop/>MyTopic= translation. Can be
	  ="<nop/>MyTopic"= or ="<nop/>Web.MyTopic"=.
	* <code>rev="1.2"</code> : include the topic's revision =1.2= (for example).
	  Defaults to the current revision.

The initial motivation for this tag is to include a suitable menu, for example, based on
current topic's language. But there are several other possibilities.

---++ Automatic Redirection

TopicTranslationsPlugin is capable of automatically redirecting to the available
translation best suited to the user's language. Once TopicTranslationsPlugin is
installed, this will happen by default.

	* User's language is detected by the =Accept-Language= header sent by the user agent
	  (the browser, most of the times), using the  =I18N::AcceptLanguage= Perl module.
	* The user *won't* be redirected:
		* during an action other than =view= and =viewauth= (off course)
		* if the user came from a link in another translation of the same topic.
		* if the user came from an =edit= script.
		* __Note:__ the two later cases are detected by the =Referer= header sent by the user agent.

---+++ Disabling automatic redirection

The automatic redirection can be disabled by setting the TopicTranslationsPlugin's
preference flag =DISABLE_AUTOMATIC_REDIRECTION= (i.e., setting its value to something different
from =no=, =off= and =0=).

__Note:__ in TWiki:Codev/CairoRelease, to make this work you'll have to apply the
following patch to =TWiki/Func.pm= module (got from TWiki's Subversion repository): 

<verbatim>
--- /var/lib/twiki/lib/TWiki/Func.pm	 2005-07-02 13:33:46.893777128 -0300
+++ Func.pm	  2005-07-02 13:37:22.187047576 -0300
@@ -407,8 +407,9 @@
 sub getPluginPreferencesFlag
 {
	  my( $theKey ) = @_;
-	 my $value = getPluginPreferencesValue( $theKey );
-	 return TWiki::Prefs::formatAsFlag($value);
+	 my $package = caller;
+	 $package =~ s/.*:://; # strip off TWiki::Plugins:: prefix
+	 return TWiki::Prefs::getPreferencesFlag( "\U$package\E_$theKey" );
 }

 # =========================
</verbatim>

---++ Examples

| *Test* | *Actual test(work if the plugin is installed)* |
| %<nop/>TRANSLATIONS% | %TRANSLATIONS% |
| %<nop/>TRANSLATIONS{format="[[$translation]<nop/>[$language translation]]" separator=", "}% | %TRANSLATIONS{format="[[$translation][$language translation]]" separator=", "}% |
| %<nop/>CURRENTLANGUAGE% | %CURRENTLANGUAGE% |
| %<nop/>DEFAULTLANGUAGE% | %DEFAULTLANGUAGE% |

---++ Plugin Settings

Plugin settings are stored as preferences variables. To reference a plugin setting write ==%<nop>&lt;plugin&gt;_&lt;setting&gt;%==, i.e. ==%<nop>INTERWIKIPLUGIN_SHORTDESCRIPTION%==

	* One line description, is shown in the %TWIKIWEB%.TextFormattingRules topic:
		* Set SHORTDESCRIPTION = manages a topic's translations into several languages. 

	* Debug plugin: (See output in =data/debug.txt=)
		* Set DEBUG = 0

	* Whether automatic redirection must be disabled or not. Set to =yes= to disable.
		* Set DISABLE_AUTOMATIC_REDIRECTION = no

	* My own setting:
		* Set TOPICTRANSLATIONS = en, pt-br

---++ Plugin Installation Instructions

__Note:__ You do not need to install anything on the browser to use this plugin. The following instructions are for the administrator who installs the plugin on the server where TWiki is running. 

	* Download the ZIP file from the Plugin web (see below)
	* Unzip ==%TOPIC%.zip== in your twiki installation directory. Content:
	  | *File:* | *Description:* |
	  | ==data/TWiki/%TOPIC%.txt== | Plugin topic |
	  | ==data/TWiki/%TOPIC%.txt,v== | Plugin topic repository |
	  | ==lib/TWiki/Plugins/%TOPIC%.pm== | Plugin Perl module |
	* Test if the installation was successful:
		* see the examples [[#Examples][above]]

---++ Plugin Info

|  Plugin Author: | TWiki:Main.AntonioTerceiro |
|  Plugin Version: | 03 Jul 2005 (V1.003) |
|  Change History: | <!-- versions below in reverse order -->&nbsp; |
|  03 Jul 2005 | Version =1.003=: fixed to redirect only during =view=/=viewauth= |
|  02 Jul 2005 | Version =1.002=: major rewrite; documented all (or almost all :)) the code; added selection of available/missing translations; added =missingformat=; added support for custom topics (and webs) in <code>%<nop/>TRANSLATIONS%</code>; added automatic redirection for the "best" translation (detection via =I18N::AcceptLanguage=).  |
|  19 Jun 2005: | Initial version: =1.001= |
|  TWiki Dependency: | $TWiki::Plugins::VERSION 1.024 |
|  CPAN Dependencies: | =I18N::AcceptLanguage= |
|  Other Dependencies: | none |
|  Perl Version: | 5.005 |
|  License: | GPL ([[http://www.gnu.org/copyleft/gpl.html][GNU General Public License]]) |
|  TWiki:Plugins/Benchmark: | %TWIKIWEB%.GoodStyle 100%, %TWIKIWEB%.FormattedSearch 100%, %TOPIC% 100% |
|  Plugin Home: | http://TWiki.org/cgi-bin/view/Plugins/%TOPIC% |
|  Feedback: | http://TWiki.org/cgi-bin/view/Plugins/%TOPIC%Dev |
|  Appraisal: | http://TWiki.org/cgi-bin/view/Plugins/%TOPIC%Appraisal |

__Related Topics:__ %TWIKIWEB%.TWikiPreferences, %TWIKIWEB%.TWikiPlugins

-- TWiki:Main.AntonioTerceiro - 03 Jul 2005

