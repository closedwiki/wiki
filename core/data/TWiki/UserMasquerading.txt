%META:TOPICINFO{author="TWikiContributor" date="1339737431" format="1.1" version="$Rev$"}%
---+!! User Masquerading
%TOC%

---++ Preface
This topic describe how to configure your TWiki site for user masquerading.

There are cases where it's handy to access TWiki on behalf of somebody else with a trace of your real identity rather than completely becoming a different user TWiki-wise.
This is called user masquerading here.
Needless to say, there is no need to know somebody else's password.

TWiki is flexible enough to provide user masquerading through a plug-in having a proper initialize user handler and a proper user mapping handler.

For example, your login ID would be "REAL_ID/MASQUERADE_ID" while you are acting on behalf of MASQUERADE_ID.

---++ Benefits
User masquerading discussed here provides the following benefits.

---+++ Minimizing exercise of privilege
Usually, TWiki administrators are the members of !TWikiAdminGroup and can do anything on the TWiki site.
This is like doing everything as root on Unix and doing everything as an administrator account on Windows, which is not regarded as a good practice now.
TWiki Administrators are likely to be TWiki users and they shouldn't have privilege while they are *using* TWiki.
They should exercise their privilege only when they administer.

For that, instead of putting TWiki administrators into !TWikiAdminGroup, allowing them to act on behalf of "admin" is desirable assuming "admin" is a !TWikiAdminGroup member.

---+++ Auditability
Assuming the TWiki access log records both the real and masqueraded identities for individual operations, auditing of TWiki administrators is easier.

You can see admin operations of joeschmoe by picking up joeschmoe/admin's entries in the log file.
joeschmoe's ordinary use is supposed to be conducted as joeschmoe rather than joeschmoe/admin, you don't need to exclude non admin activities manually.

---+++ Web autonomy
On a large TWiki installation having thousands of webs, webs need to be as autonomous as possible.
To that end, it's handy to have a set of users guaranteed to have access to a web regardless of access control settings -- it's like !TWikiAdminGroup members but for the web only.

User masquerading can allow the web owners to act on behalf of "admin" on their web while not allowing that on the other webs.
In case a web administrator kicks oneself out of the web due to access control mistake, the administrator can act on behalf of admin to fix it.
The administrator can also fix a problem on a topic the administrator usually cannot see by acting on behalf of admin.

---+++ Testing access control
Usually, it's cumbersome to confirm access control setting is working as expected. Because you need to ask somebody else try.

User masquerading makes it possible to test access control on your own.

---++ How to set up masquerading
Now that you understand the concept well, how to set up initialize user handler and user mapping handler for user masquerading is described.

The requirements are:
   * While user masquerading is in effect, both the real identity and the masquerade identity need to be reflected in the user's identity.
   * Masquerading takes effect only on webs the user is entitled to.
   * Access checking is conducted taking user masquerading into account.

---+++ Initialize user handler
Let's say while a user joeschmoe (login name) is masquerading as janedoe, the user is identified as joeschmoe/janedoe.
This should happen in initializeUserHandler() of a plug-in.
You may think a login handler can have this feature, it's not practical to determine a user is allowed to masquerade or not in the login handler.
This is because the login handler is called very early in a topic processing and the apparatus you can use is quite limited.

One way to specify a masquerade destination is by an HTTP cookie - e.g. TWIKI_ON_BEHALF_OF.
Assuming that, initializeUserHandler() returns the login name handed as it is if the TWIKI_ON_BEHALF_OF cookie does not exist.
If its value is janedoe, then the handler determines whether joeschmoe is entitled to masquerading. If so it returns joeschmoe/janedoe. Otherwise it returns joeschmoe.

---+++ User mapping handler
Making the corresponding cUID for joeschmoe/janedoe login name shouldn't be an issue - the way !TWikiUserMapping employs for login to cUID mapping is fine.
And let's say the corresponding wiki name is !JoeSchmoeOnBeHalfOfJaneDoe.
For that, the following methods of the user mapping handler need to be implemented accordingly.
   * getWikiName() (for cUID to wiki name mapping)
   * findUserByWikiName() (for wiki name to cUID mapping)

The following methods of the user mapping handler need to take two extra arguments $topic and $web compared to those methods in !TWikiUserMapping.
   $ isAdmin(): it's similar to !TWikiUserMapping's but when it calls isInGroup(), $topic and $web need to be passed, which is not the case with !TWikiUserMapping.
   $ isInGroup(): it's similar to !TWikiUserMapping's but it takes masquerading into account. For that, it needs to take $topic and $web as its arguments.

In addition, the following new method needs to be implemented -
$handler-&gt;isEquivalentCUIDs($cUID, $identCUID, $topic, $web)

$cUID may be masquerading.
$identCUID is not masquerading.
The isEquivalentCUIDs method determines the equivalency of $cUID and $identCUID taking user masquerading into consideration.

---++ Logging while masquerading
On the TWiki log, each entry has a user's login name.
In the scenario described so far, while masquerading, the user's login name is in the joeschmoe/janedoe format.
Consequently, login names for that format are put in the log file.

As mentioned above, initializeUserHandler() determines if the user is entitled to masquerading. If the user is not entitled, even if TWIKI_ON_BEHALF_OF cookie has a value, user masquerading doesn't take effect and the log doesn't get the trace of masquerading.
